!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){},{}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../math/ndarray"),CheckpointLoader=function(){function CheckpointLoader(urlPath){this.urlPath=urlPath,"/"!==this.urlPath.charAt(this.urlPath.length-1)&&(this.urlPath+="/")}return CheckpointLoader.prototype.loadManifest=function(){var _this=this;return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",_this.urlPath+"manifest.json"),xhr.onload=function(){_this.checkpointManifest=JSON.parse(xhr.responseText),resolve()},xhr.onerror=function(error){throw new Error("manifest.json not found at "+_this.urlPath+". "+error)},xhr.send()})},CheckpointLoader.prototype.getCheckpointManifest=function(){var _this=this;return null==this.checkpointManifest?new Promise(function(resolve,reject){_this.loadManifest().then(function(){resolve(_this.checkpointManifest)})}):new Promise(function(resolve,reject){resolve(_this.checkpointManifest)})},CheckpointLoader.prototype.getAllVariables=function(){var _this=this;return null!=this.variables?new Promise(function(resolve,reject){resolve(_this.variables)}):new Promise(function(resolve,reject){_this.getCheckpointManifest().then(function(checkpointDefinition){for(var variableNames=Object.keys(_this.checkpointManifest),variablePromises=[],i=0;i<variableNames.length;i++)variablePromises.push(_this.getVariable(variableNames[i]));Promise.all(variablePromises).then(function(variables){_this.variables={};for(var i=0;i<variables.length;i++)_this.variables[variableNames[i]]=variables[i];resolve(_this.variables)})})})},CheckpointLoader.prototype.getVariable=function(varName){var _this=this;if(!(varName in this.checkpointManifest))throw new Error("Cannot load non-existant variable "+varName);var variableRequestPromiseMethod=function(resolve,reject){var xhr=new XMLHttpRequest;xhr.responseType="arraybuffer";var fname=_this.checkpointManifest[varName].filename;xhr.open("GET",_this.urlPath+fname),xhr.onload=function(){var values=new Float32Array(xhr.response),ndarray=ndarray_1.NDArray.make(_this.checkpointManifest[varName].shape,{values:values});resolve(ndarray)},xhr.onerror=function(error){throw new Error("Could not fetch variable "+varName+": "+error)},xhr.send()};return null==this.checkpointManifest?new Promise(function(resolve,reject){_this.loadManifest().then(function(){new Promise(variableRequestPromiseMethod).then(resolve)})}):new Promise(variableRequestPromiseMethod)},CheckpointLoader}();exports.CheckpointLoader=CheckpointLoader},{"../math/ndarray":51}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../math/ndarray"),util=require("../util"),InMemoryDataset=function(){function InMemoryDataset(dataShapes){this.dataShapes=dataShapes,this.normalizationInfo={}}return InMemoryDataset.prototype.getDataShape=function(dataIndex){return this.dataShapes[dataIndex]},InMemoryDataset.prototype.getData=function(){return this.dataset},InMemoryDataset.prototype.getStats=function(){var _this=this;if(null==this.dataset)throw new Error("Data is null.");return this.dataset.map(function(d){return _this.getStatsForData(d)})},InMemoryDataset.prototype.getStatsForData=function(data){var inputMin=Number.POSITIVE_INFINITY,inputMax=Number.NEGATIVE_INFINITY,exampleIndices=data.map(function(example,i){return i});util.shuffle(exampleIndices),exampleIndices=exampleIndices.slice(.1*exampleIndices.length);for(var i=0;i<exampleIndices.length;i++)for(var inputValues=data[exampleIndices[i]].getValues(),j=0;j<inputValues.length;j++)inputMin=Math.min(inputMin,inputValues[j]),inputMax=Math.max(inputMax,inputValues[j]);return{inputMin:inputMin,inputMax:inputMax,exampleCount:data.length,shape:data[0].shape}},InMemoryDataset.prototype.normalizeExamplesToRange=function(examples,curLowerBounds,curUpperBounds,newLowerBounds,newUpperBounds){var curBoundsIsPerDimension=curUpperBounds instanceof Float32Array&&curLowerBounds instanceof Float32Array,newBoundsIsPerDimension=newLowerBounds instanceof Float32Array&&newUpperBounds instanceof Float32Array,inputSize=util.sizeFromShape(examples[0].shape),newExamples=[];return examples.forEach(function(example){for(var inputValues=example.getValues(),normalizedValues=new Float32Array(inputSize),j=0;j<inputSize;j++){var curLowerBound=curBoundsIsPerDimension?curLowerBounds[j]:curLowerBounds,curRange=(curBoundsIsPerDimension?curUpperBounds[j]:curUpperBounds)-curLowerBound,newLowerBound=newBoundsIsPerDimension?newLowerBounds[j]:newLowerBounds,newRange=(newBoundsIsPerDimension?newUpperBounds[j]:newUpperBounds)-newLowerBound;normalizedValues[j]=0===curRange?newLowerBound:newLowerBound+newRange*(inputValues[j]-curLowerBound)/curRange}newExamples.push(ndarray_1.NDArray.make(example.shape,{values:normalizedValues}))}),newExamples},InMemoryDataset.prototype.computeBounds=function(dataIndex){var _this=this;if(null==this.dataset)throw new Error("Data is null.");var size=util.sizeFromShape(this.dataset[dataIndex][0].shape);this.normalizationInfo[dataIndex]={isNormalized:!1,minValues:new Float32Array(size),maxValues:new Float32Array(size)};for(var i=0;i<size;i++)this.normalizationInfo[dataIndex].minValues[i]=Number.POSITIVE_INFINITY,this.normalizationInfo[dataIndex].maxValues[i]=Number.NEGATIVE_INFINITY;this.dataset[dataIndex].forEach(function(example){for(var inputValues=example.getValues(),k=0;k<size;k++)_this.normalizationInfo[dataIndex].minValues[k]=Math.min(_this.normalizationInfo[dataIndex].minValues[k],inputValues[k]),_this.normalizationInfo[dataIndex].maxValues[k]=Math.max(_this.normalizationInfo[dataIndex].maxValues[k],inputValues[k])})},InMemoryDataset.prototype.normalizeWithinBounds=function(dataIndex,lowerBound,upperBound){if(null==this.dataset)throw new Error("Data is null.");if(dataIndex>=this.dataset.length)throw new Error("dataIndex out of bounds.");null==this.normalizationInfo[dataIndex]&&this.computeBounds(dataIndex);var curLowerBounds,curUpperBounds;this.normalizationInfo[dataIndex].isNormalized?(curLowerBounds=this.normalizationInfo[dataIndex].lowerBound,curUpperBounds=this.normalizationInfo[dataIndex].upperBound):(curLowerBounds=this.normalizationInfo[dataIndex].minValues,curUpperBounds=this.normalizationInfo[dataIndex].maxValues),this.dataset[dataIndex]=this.normalizeExamplesToRange(this.dataset[dataIndex],curLowerBounds,curUpperBounds,lowerBound,upperBound),this.normalizationInfo[dataIndex].isNormalized=!0,this.normalizationInfo[dataIndex].lowerBound=lowerBound,this.normalizationInfo[dataIndex].upperBound=upperBound},InMemoryDataset.prototype.isNormalized=function(dataIndex){return null!=this.normalizationInfo&&this.normalizationInfo[dataIndex].isNormalized},InMemoryDataset.prototype.removeNormalization=function(dataIndex){if(null==this.dataset)throw new Error("Training or test data is null.");this.isNormalized(dataIndex)&&(this.dataset[dataIndex]=this.normalizeExamplesToRange(this.dataset[dataIndex],this.normalizationInfo[dataIndex].lowerBound,this.normalizationInfo[dataIndex].upperBound,this.normalizationInfo[dataIndex].minValues,this.normalizationInfo[dataIndex].maxValues),this.normalizationInfo[dataIndex].isNormalized=!1)},InMemoryDataset.prototype.unnormalizeExamples=function(examples,dataIndex){return this.isNormalized(dataIndex)?this.normalizeExamplesToRange(examples,this.normalizationInfo[dataIndex].lowerBound,this.normalizationInfo[dataIndex].upperBound,this.normalizationInfo[dataIndex].minValues,this.normalizationInfo[dataIndex].maxValues):examples},InMemoryDataset.prototype.dispose=function(){if(null!=this.dataset){for(var i=0;i<this.dataset.length;i++)for(var j=0;j<this.dataset[i].length;j++)this.dataset[i][j].dispose();this.dataset=[]}},InMemoryDataset}();exports.InMemoryDataset=InMemoryDataset},{"../math/ndarray":51,"../util":82}],4:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../math/ndarray"),util=require("../util"),InMemoryShuffledInputProviderBuilder=function(){function InMemoryShuffledInputProviderBuilder(inputs){this.inputs=inputs,this.idx=0,this.inputCounter=0,this.epoch=0,this.shuffledIndices=util.createShuffledIndices(inputs[0].length),this.numInputs=inputs.length;for(var numExamples=this.inputs[0].length,i=0;i<this.numInputs;i++)util.assert(this.inputs[i].length===numExamples,"Number of examples must match across different inputs.");for(i=0;i<this.numInputs;i++)for(var inputShape=this.inputs[i][0].shape,j=0;j<this.inputs[i].length;j++)util.assertShapesMatch(inputShape,this.inputs[i][j].shape)}return InMemoryShuffledInputProviderBuilder.prototype.getCurrentExampleIndex=function(){var returnIdx=this.idx;return this.inputCounter++,this.inputCounter>=this.numInputs&&(this.idx++,this.inputCounter=0,this.idx>=this.inputs[0].length&&(this.idx=0,this.epoch++)),returnIdx},InMemoryShuffledInputProviderBuilder.prototype.getNextInput=function(inputId){var currentExampleIndex=this.getCurrentExampleIndex();return this.inputs[inputId][this.shuffledIndices[currentExampleIndex]]},InMemoryShuffledInputProviderBuilder.prototype.getEpoch=function(){return this.epoch},InMemoryShuffledInputProviderBuilder.prototype.getInputProviders=function(){for(var inputProviders=[],i=0;i<this.numInputs;i++)inputProviders.push(this.getInputProvider(i));return inputProviders},InMemoryShuffledInputProviderBuilder}();exports.InMemoryShuffledInputProviderBuilder=InMemoryShuffledInputProviderBuilder;var InCPUMemoryShuffledInputProviderBuilder=function(_super){function InCPUMemoryShuffledInputProviderBuilder(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(InCPUMemoryShuffledInputProviderBuilder,_super),InCPUMemoryShuffledInputProviderBuilder.prototype.getInputProvider=function(inputId){var shuffledInputProvider=this;return{getNextCopy:function(math){return ndarray_1.NDArray.like(shuffledInputProvider.getNextInput(inputId))},disposeCopy:function(math,copy){copy.dispose()}}},InCPUMemoryShuffledInputProviderBuilder}(InMemoryShuffledInputProviderBuilder);exports.InCPUMemoryShuffledInputProviderBuilder=InCPUMemoryShuffledInputProviderBuilder;var InGPUMemoryShuffledInputProviderBuilder=function(_super){function InGPUMemoryShuffledInputProviderBuilder(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(InGPUMemoryShuffledInputProviderBuilder,_super),InGPUMemoryShuffledInputProviderBuilder.prototype.getInputProvider=function(inputId){var shuffledInputProvider=this;return{getNextCopy:function(math){return math.clone(shuffledInputProvider.getNextInput(inputId))},disposeCopy:function(math,copy){copy.dispose()}}},InGPUMemoryShuffledInputProviderBuilder}(InMemoryShuffledInputProviderBuilder);exports.InGPUMemoryShuffledInputProviderBuilder=InGPUMemoryShuffledInputProviderBuilder},{"../math/ndarray":51,"../util":82}],5:[function(require,module,exports){"use strict";function parseTypedArrayFromBinary(info){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",info.path),xhr.responseType="arraybuffer",xhr.onload=function(event){var data="float32"===info.dataType?new Float32Array(xhr.response):new Uint8Array(xhr.response);resolve(data)},xhr.onerror=function(err){return reject(err)},xhr.send()})}function parseGrayscaleImageData(data,result,resultOffset){for(var idx=resultOffset,i=0;i<data.length;i+=4)result[idx++]=data[i]}function parseRGBImageData(data,result,resultOffset){for(var idx=resultOffset,i=0;i<data.length;i+=4)result[idx]=data[i],result[idx+1]=data[i+1],result[idx+2]=data[i+2],idx+=3}function parseImage(img,shape){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),N=img.height,inputSize=util.sizeFromShape(shape),result=new Uint8Array(N*inputSize);if(img.width!==shape[0]*shape[1])throw new Error("Image width ("+img.width+") must be multiple of rows*columns ("+shape[0]+"*"+shape[1]+") of the ndarray");canvas.width=img.width,canvas.height=PARSING_IMAGE_CANVAS_HEIGHT_PX;for(var sWidth=canvas.width,sHeight=canvas.height,dWidth=sWidth,dHeight=sHeight,depth=shape[2],offset=0,numPasses=Math.ceil(N/canvas.height),pass=0;pass<numPasses;++pass){var sy=pass*canvas.height;pass===numPasses-1&&N%canvas.height>0&&(canvas.height=N%canvas.height,dHeight=sHeight=canvas.height),ctx.drawImage(img,0,sy,sWidth,sHeight,0,0,dWidth,dHeight);var data=ctx.getImageData(0,0,canvas.width,canvas.height).data;1===depth?parseGrayscaleImageData(data,result,offset):parseRGBImageData(data,result,offset),offset+=canvas.height*inputSize}return result}function parseTypedArrayFromPng(info,shape){return new Promise(function(resolve,reject){var img=new Image;img.setAttribute("crossOrigin",""),img.onload=function(){var result=parseImage(img,shape);img.src="",img=null,resolve(result)},img.src=info.path})}var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../math/ndarray"),util=require("../util"),dataset_1=require("./dataset"),PARSING_IMAGE_CANVAS_HEIGHT_PX=1e3;exports.getXhrDatasetConfig=function(jsonConfigPath){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",jsonConfigPath),xhr.onload=function(){resolve(JSON.parse(xhr.responseText))},xhr.onerror=function(error){reject(error)},xhr.send()})};var XhrDataset=function(_super){function XhrDataset(xhrDatasetConfig){var _this=_super.call(this,xhrDatasetConfig.data.map(function(x){return x.shape}))||this;return _this.xhrDatasetConfig=xhrDatasetConfig,_this}return __extends(XhrDataset,_super),XhrDataset.prototype.getNDArray=function(info){return("png"===info.dataType?parseTypedArrayFromPng(info,info.shape):parseTypedArrayFromBinary(info)).then(function(data){for(var inputSize=util.sizeFromShape(info.shape),ndarrays=[],i=0;i<data.length/inputSize;i++){var values=data.subarray(i*inputSize,(i+1)*inputSize),ndarray=ndarray_1.NDArray.make(info.shape,{values:new Float32Array(values)});ndarrays.push(ndarray)}return ndarrays})},XhrDataset.prototype.fetchData=function(){var _this=this;return new Promise(function(resolve,reject){var promises=_this.xhrDatasetConfig.data.map(function(x){return _this.getNDArray(x)});Promise.all(promises).then(function(data){_this.dataset=data,resolve()})})},XhrDataset}(dataset_1.InMemoryDataset);exports.XhrDataset=XhrDataset},{"../math/ndarray":51,"../util":82,"./dataset":3}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isMobile=function(){var a=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))}},{}],7:[function(require,module,exports){"use strict";function getWebGLRenderingContext(webGLVersion){if(0===webGLVersion)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var tempCanvas=document.createElement("canvas");return 1===webGLVersion?tempCanvas.getContext("webgl")||tempCanvas.getContext("experimental-webgl"):tempCanvas.getContext("webgl2")}function loseContext(gl){if(null!=gl){var loseContextExtension=gl.getExtension("WEBGL_lose_context");if(null==loseContextExtension)throw new Error("Extension WEBGL_lose_context not supported on this browser.");loseContextExtension.loseContext()}}function isWebGLVersionEnabled(webGLVersion){var gl=getWebGLRenderingContext(webGLVersion);return null!=gl&&(loseContext(gl),!0)}function isWebGLDisjointQueryTimerEnabled(webGLVersion){var gl=getWebGLRenderingContext(webGLVersion),extensionName=1===webGLVersion?"EXT_disjoint_timer_query":"EXT_disjoint_timer_query_webgl2",isExtEnabled=null!=gl.getExtension(extensionName);return null!=gl&&loseContext(gl),isExtEnabled}Object.defineProperty(exports,"__esModule",{value:!0});var Type,device_util=require("./device_util"),util=require("./util");!function(Type){Type[Type.NUMBER=0]="NUMBER",Type[Type.BOOLEAN=1]="BOOLEAN"}(Type=exports.Type||(exports.Type={})),exports.URL_PROPERTIES=[{name:"WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED",type:Type.BOOLEAN},{name:"WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",type:Type.BOOLEAN},{name:"WEBGL_VERSION",type:Type.NUMBER}];var Environment=function(){function Environment(features){this.features={},null!=features&&(this.features=features)}return Environment.prototype.get=function(feature){return feature in this.features?this.features[feature]:(this.features[feature]=this.evaluateFeature(feature),this.features[feature])},Environment.prototype.evaluateFeature=function(feature){if("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED"===feature){var webGLVersion=this.get("WEBGL_VERSION");return 0!==webGLVersion&&isWebGLDisjointQueryTimerEnabled(webGLVersion)}if("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE"===feature)return this.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED")&&!device_util.isMobile();if("WEBGL_VERSION"===feature)return isWebGLVersionEnabled(2)?2:isWebGLVersionEnabled(1)?1:0;throw new Error("Unknown feature "+feature+".")},Environment}();exports.Environment=Environment;var DEEPLEARNJS_FLAGS_PREFIX="dljsflags";exports.ENV=new Environment(function(){var features={};if("undefined"==typeof window)return features;var urlParams=util.getQueryParams(window.location.search);if(DEEPLEARNJS_FLAGS_PREFIX in urlParams){var urlFlags_1={};urlParams[DEEPLEARNJS_FLAGS_PREFIX].split(",").forEach(function(keyValue){var _a=keyValue.split(":"),key=_a[0],value=_a[1];urlFlags_1[key]=value}),exports.URL_PROPERTIES.forEach(function(urlProperty){urlProperty.name in urlFlags_1&&(console.log("Setting feature override from URL "+urlProperty.name+": "+urlFlags_1[urlProperty.name]),urlProperty.type===Type.NUMBER?features[urlProperty.name]=+urlFlags_1[urlProperty.name]:urlProperty.type===Type.BOOLEAN?features[urlProperty.name]="true"===urlFlags_1[urlProperty.name]:console.warn("Unknown URL param: "+urlProperty.name+"."))})}return features}()),exports.setEnvironment=function(environment){exports.ENV=environment}},{"./device_util":6,"./util":82}],8:[function(require,module,exports){"use strict";function getMatMulOutputShape(x1Shape,x2Shape){return 1===x1Shape.length&&1===x2Shape.length?[1]:1===x1Shape.length&&2===x2Shape.length?[x2Shape[1]]:2===x1Shape.length&&1===x2Shape.length?[x1Shape[0]]:[x1Shape[0],x2Shape[1]]}var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var initializers_1=require("../initializers"),concat_util=require("../math/concat_util"),conv_util=require("../math/conv_util"),ndarray_1=require("../math/ndarray"),util=require("../util"),GraphLayers=function(){function GraphLayers(g){this.g=g}return GraphLayers.prototype.dense=function(name,x,units,activation,useBias,kernelInitializer,biasInitializer){void 0===activation&&(activation=null),void 0===useBias&&(useBias=!0),void 0===kernelInitializer&&(kernelInitializer=new initializers_1.VarianceScalingInitializer),void 0===biasInitializer&&(biasInitializer=new initializers_1.ZerosInitializer);var weights=this.g.variable(name+"-weights",kernelInitializer.initialize([x.shape[0],units],x.shape[0],units)),out=this.g.matmul(x,weights);if(useBias){var bias=this.g.variable(name+"-bias",biasInitializer.initialize([units],x.shape[0],units));out=this.g.add(out,bias)}return null!=activation&&(out=activation(out)),out},GraphLayers}();exports.GraphLayers=GraphLayers;var Graph=function(){function Graph(){this.nodes=[],this.layers=new GraphLayers(this)}return Graph.prototype.variable=function(name,data){return this.addNodeAndReturnOutput(new VariableNode(this,name,data))},Graph.prototype.placeholder=function(name,shape){return this.addNodeAndReturnOutput(new PlaceholderNode(this,name,shape))},Graph.prototype.constant=function(value){var finalValue;if("number"==typeof value)finalValue=ndarray_1.Scalar.new(value);else if(value instanceof ndarray_1.NDArray)finalValue=value;else{if(!(value instanceof Array))throw new Error("unimplemented constant type.");var vals=new Float32Array(util.flatten(value));finalValue=ndarray_1.NDArray.make(util.inferShape(value),{values:vals})}return this.addNodeAndReturnOutput(new ConstantNode(this,finalValue))},Graph.prototype.reshape=function(x,shape){return this.addNodeAndReturnOutput(new ReshapeNode(this,"Reshape",x,shape))},Graph.prototype.fusedLinearCombination=function(x1,x2,c1,c2){return this.addNodeAndReturnOutput(new FusedLinearCombinationNode(this,x1,x2,c1,c2))},Graph.prototype.add=function(x1,x2){return this.addNodeAndReturnOutput(new AddNode(this,x1,x2))},Graph.prototype.subtract=function(x1,x2){return this.addNodeAndReturnOutput(new SubtractNode(this,x1,x2))},Graph.prototype.multiply=function(x1,x2){return this.addNodeAndReturnOutput(new MultiplyNode(this,x1,x2))},Graph.prototype.divide=function(x1,x2){return this.addNodeAndReturnOutput(new DivideNode(this,x1,x2))},Graph.prototype.reduceSum=function(x){return this.addNodeAndReturnOutput(new ReduceSumNode(this,x))},Graph.prototype.concat3d=function(x1,x2,axis){return this.addNodeAndReturnOutput(new Concat3DNode(this,x1,x2,axis))},Graph.prototype.matmul=function(x1,x2){return this.addNodeAndReturnOutput(new MatMulNode(this,x1,x2))},Graph.prototype.conv2d=function(x,w,b,fieldSize,outputDepth,stride,zeroPad){return void 0===stride&&(stride=1),this.addNodeAndReturnOutput(new Convolution2DNode(this,x,w,b,fieldSize,outputDepth,stride,zeroPad))},Graph.prototype.maxPool=function(x,fieldSize,stride,zeroPad){return void 0===stride&&(stride=1),this.addNodeAndReturnOutput(new MaxPoolNode(this,x,fieldSize,stride,zeroPad))},Graph.prototype.exp=function(x){return this.addNodeAndReturnOutput(new ExpNode(this,x))},Graph.prototype.log=function(x){return this.addNodeAndReturnOutput(new LogNode(this,x))},Graph.prototype.relu=function(x){return this.addNodeAndReturnOutput(new ReLUNode(this,x))},Graph.prototype.tanh=function(x){return this.addNodeAndReturnOutput(new TanHNode(this,x))},Graph.prototype.sigmoid=function(x){return this.addNodeAndReturnOutput(new SigmoidNode(this,x))},Graph.prototype.square=function(x){return this.addNodeAndReturnOutput(new SquareNode(this,x))},Graph.prototype.softmax=function(x){return this.addNodeAndReturnOutput(new SoftmaxNode(this,x))},Graph.prototype.softmaxCrossEntropyCost=function(x,target){return this.addNodeAndReturnOutput(new SoftmaxCrossEntropyCostNode(this,x,target))},Graph.prototype.meanSquaredCost=function(label,prediction){return this.addNodeAndReturnOutput(new MeanSquaredCostNode(this,label,prediction))},Graph.prototype.argmax=function(x){return this.addNodeAndReturnOutput(new ArgMaxNode(this,x))},Graph.prototype.argmaxEquals=function(x1,x2){return this.addNodeAndReturnOutput(new ArgMaxEqualsNode(this,x1,x2))},Graph.prototype.addNodeAndReturnOutput=function(node){return this.nodes.push(node),node.validate(),node.output},Graph.prototype.getNodes=function(){return this.nodes},Graph}();exports.Graph=Graph;var Tensor=function(){function Tensor(shape){this.shape=shape,this.id=Tensor.nextID++}return Tensor.nextID=0,Tensor}();exports.Tensor=Tensor;var Node=function(){function Node(graph,name,inputs,output){this.graph=graph,this.name=name,this.inputs=inputs,this.output=output,this.id=Node.nextID++,output.node=this}return Node.nextID=0,Node}();exports.Node=Node;var VariableNode=function(_super){function VariableNode(graph,name,data){var _this=_super.call(this,graph,name,{},new Tensor(data.shape))||this;return _this.data=data,_this}return __extends(VariableNode,_super),VariableNode.prototype.validate=function(){util.assert(null!=this.data,"Error adding variable op: Data for variable '"+this.name+"' is null or undefined")},VariableNode}(Node);exports.VariableNode=VariableNode;var PlaceholderNode=function(_super){function PlaceholderNode(graph,name,shape){return _super.call(this,graph,name,{},new Tensor(shape))||this}return __extends(PlaceholderNode,_super),PlaceholderNode.prototype.validate=function(){},PlaceholderNode}(Node);exports.PlaceholderNode=PlaceholderNode;var ConstantNode=function(_super){function ConstantNode(graph,data){var _this=_super.call(this,graph,"Constant",{},new Tensor(data.shape))||this;return _this.data=data,_this}return __extends(ConstantNode,_super),ConstantNode.prototype.validate=function(){util.assert(null!=this.data,"Error adding constant: data for placeholder '"+this.name+"' is null or undefined")},ConstantNode}(Node);exports.ConstantNode=ConstantNode;var ReshapeNode=function(_super){function ReshapeNode(graph,name,x,shape){var _this=_super.call(this,graph,name,{x:x},new Tensor(shape))||this;return _this.name=name,_this.x=x,_this.shape=shape,_this}return __extends(ReshapeNode,_super),ReshapeNode.prototype.validate=function(){var xSize=util.sizeFromShape(this.x.shape),shapeSize=util.sizeFromShape(this.shape);util.assert(xSize===shapeSize,"Error making reshape operation: input Tensor to reshape '"+this.name+"' of shape ("+this.x.shape+") does not match size of requested shape "+this.shape+".")},ReshapeNode.X="x",ReshapeNode}(Node);exports.ReshapeNode=ReshapeNode;var FusedLinearCombinationNode=function(_super){function FusedLinearCombinationNode(graph,t1,t2,c1,c2){var _this=_super.call(this,graph,"Linear Combination",{t1:t1,t2:t2,c1:c1,c2:c2},new Tensor(t1.shape))||this;return _this.t1=t1,_this.t2=t2,_this.c1=c1,_this.c2=c2,_this}return __extends(FusedLinearCombinationNode,_super),FusedLinearCombinationNode.prototype.validate=function(){if(util.assertShapesMatch(this.t1.shape,this.t2.shape),!util.isScalarShape(this.c1.shape))throw new Error("Error adding fusedLinearCombination: c1 is not a scalar, got shape: "+this.c1.shape);if(!util.isScalarShape(this.c2.shape))throw new Error("Error adding fusedLinearCombination: c2 is not a scalar, got shape: "+this.c2.shape)},FusedLinearCombinationNode.T1="t1",FusedLinearCombinationNode.T2="t2",FusedLinearCombinationNode.C1="c1",FusedLinearCombinationNode.C2="c2",FusedLinearCombinationNode}(Node);exports.FusedLinearCombinationNode=FusedLinearCombinationNode;var AddNode=function(_super){function AddNode(graph,t1,t2){var _this=_super.call(this,graph,"Add",{t1:t1,t2:t2},new Tensor(1===util.sizeFromShape(t1.shape)?t2.shape:t1.shape))||this;return _this.t1=t1,_this.t2=t2,_this}return __extends(AddNode,_super),AddNode.prototype.validate=function(){util.assert(1===util.sizeFromShape(this.t1.shape)||1===util.sizeFromShape(this.t2.shape)||util.arraysEqual(this.t1.shape,this.t2.shape),"Error adding add operation op: one of inputs must be scalar or the shapes "+this.t1.shape+" and "+this.t2.shape+" must match.")},AddNode.T1="t1",AddNode.T2="t2",AddNode}(Node);exports.AddNode=AddNode;var SubtractNode=function(_super){function SubtractNode(graph,t1,t2){var _this=_super.call(this,graph,"Subtract",{t1:t1,t2:t2},new Tensor(1===util.sizeFromShape(t1.shape)?t2.shape:t1.shape))||this;return _this.t1=t1,_this.t2=t2,_this}return __extends(SubtractNode,_super),SubtractNode.prototype.validate=function(){util.assert(1===util.sizeFromShape(this.t1.shape)||1===util.sizeFromShape(this.t2.shape)||util.arraysEqual(this.t1.shape,this.t2.shape),"Error adding subtract op: one of inputs must be scalar or the shapes "+this.t1.shape+" and "+this.t2.shape+" must match.")},SubtractNode.T1="t1",SubtractNode.T2="t2",SubtractNode}(Node);exports.SubtractNode=SubtractNode;var MultiplyNode=function(_super){function MultiplyNode(graph,t1,t2){var _this=_super.call(this,graph,"Multiply",{t1:t1,t2:t2},new Tensor(1===util.sizeFromShape(t1.shape)?t2.shape:t1.shape))||this;return _this.t1=t1,_this.t2=t2,_this}return __extends(MultiplyNode,_super),MultiplyNode.prototype.validate=function(){util.assert(1===util.sizeFromShape(this.t1.shape)||1===util.sizeFromShape(this.t2.shape)||util.arraysEqual(this.t1.shape,this.t2.shape),"Error adding multiply op: one of inputs must be scalar or the shapes "+this.t1.shape+" and "+this.t2.shape+" must match.")},MultiplyNode.T1="t1",MultiplyNode.T2="t2",MultiplyNode}(Node);exports.MultiplyNode=MultiplyNode;var DivideNode=function(_super){function DivideNode(graph,t1,t2){var _this=_super.call(this,graph,"Divide",{t1:t1,t2:t2},new Tensor(1===util.sizeFromShape(t1.shape)?t2.shape:t1.shape))||this;return _this.t1=t1,_this.t2=t2,_this}return __extends(DivideNode,_super),DivideNode.prototype.validate=function(){util.assert(1===util.sizeFromShape(this.t1.shape)||1===util.sizeFromShape(this.t2.shape)||util.arraysEqual(this.t1.shape,this.t2.shape),"Error adding divide op: one of inputs must be scalar or the shapes "+this.t1.shape+" and "+this.t2.shape+" must match.")},DivideNode.T1="t1",DivideNode.T2="t2",DivideNode}(Node);exports.DivideNode=DivideNode;var ReduceSumNode=function(_super){function ReduceSumNode(graph,x){return _super.call(this,graph,"ReduceSum",{x:x},new Tensor([]))||this}return __extends(ReduceSumNode,_super),ReduceSumNode.prototype.validate=function(){},ReduceSumNode.X="x",ReduceSumNode}(Node);exports.ReduceSumNode=ReduceSumNode;var Concat3DNode=function(_super){function Concat3DNode(graph,x1,x2,axis){var _this=_super.call(this,graph,"Concat3D",{x1:x1,x2:x2},new Tensor(concat_util.computeOutShape(x1.shape,x2.shape,axis)))||this;return _this.x1=x1,_this.x2=x2,_this.axis=axis,_this}return __extends(Concat3DNode,_super),Concat3DNode.prototype.validate=function(){concat_util.assertParams(this.x1.shape,this.x2.shape,this.axis)},Concat3DNode.X1="x1",Concat3DNode.X2="x2",Concat3DNode.AXIS="axis",Concat3DNode}(Node);exports.Concat3DNode=Concat3DNode;var MatMulNode=function(_super){function MatMulNode(graph,x1,x2){var _this=_super.call(this,graph,"MatMul",{x1:x1,x2:x2},new Tensor(getMatMulOutputShape(x1.shape,x2.shape)))||this;return _this.x1=x1,_this.x2=x2,_this}return __extends(MatMulNode,_super),MatMulNode.prototype.validate=function(){if(2===this.x1.shape.length&&2===this.x2.shape.length)util.assert(this.x1.shape[1]===this.x2.shape[0],"Error adding matmul op: inner shapes of matrices with shapes "+this.x1.shape+" and "+this.x2.shape+" must match.");else if(2===this.x1.shape.length&&1===this.x2.shape.length)util.assert(this.x1.shape[1]===this.x2.shape[0],"Error adding matmul op: second dimension of matrix with shape "+this.x1.shape+" must match size of vector with shape "+this.x2.shape+".");else{if(1!==this.x1.shape.length||2!==this.x2.shape.length)throw new Error("Error adding matmul op: inputs must be vectors or matrices.");util.assert(this.x1.shape[0]===this.x2.shape[0],"Error adding matmul op: size of vector with shape "+this.x1.shape+" must match first dimension of matrix with shape "+this.x2.shape+".")}},MatMulNode.X1="x1",MatMulNode.X2="x2",MatMulNode}(Node);exports.MatMulNode=MatMulNode;var Convolution2DNode=function(_super){function Convolution2DNode(graph,x,w,b,fieldSize,outputDepth,stride,zeroPad){void 0===stride&&(stride=1);var _this=_super.call(this,graph,"Convolution 2D",{x:x,w:w,b:b},new Tensor(conv_util.computeOutputShape3D(x.shape,fieldSize,outputDepth,stride,zeroPad)))||this;return _this.x=x,_this.w=w,_this.b=b,_this.fieldSize=fieldSize,_this.outputDepth=outputDepth,_this.stride=stride,_this.zeroPad=zeroPad,_this}return __extends(Convolution2DNode,_super),Convolution2DNode.prototype.validate=function(){util.assert(3===this.x.shape.length,"Error adding conv2d op: input must be of rank 3, but got shape: "+this.x.shape+"."),util.assert(4===this.w.shape.length,"Error adding conv2d op: weights must be of rank 4, but got shape: "+this.w.shape+"."),util.assert(1===this.b.shape.length,"Error adding conv2d op: biases must be of rank 1, but got shape: "+this.b.shape+"."),util.assert(this.x.shape[2]===this.w.shape[2],"Error adding conv2d op: depth of input ("+this.x.shape[2]+") must match input depth for weights ("+this.w.shape[2]+").")},Convolution2DNode.X="x",Convolution2DNode.W="w",Convolution2DNode.B="b",Convolution2DNode}(Node);exports.Convolution2DNode=Convolution2DNode;var MaxPoolNode=function(_super){function MaxPoolNode(graph,x,fieldSize,stride,zeroPad){void 0===stride&&(stride=1);var _this=_super.call(this,graph,"Max pool",{x:x},new Tensor(conv_util.computeOutputShape3D(x.shape,fieldSize,x.shape[2],stride,zeroPad)))||this;return _this.x=x,_this.fieldSize=fieldSize,_this.stride=stride,_this.zeroPad=zeroPad,_this}return __extends(MaxPoolNode,_super),MaxPoolNode.prototype.validate=function(){util.assert(3===this.x.shape.length,"Error adding maxPool op: input must be of rank 3, but got shape: "+this.x.shape+".")},MaxPoolNode.X="x",MaxPoolNode}(Node);exports.MaxPoolNode=MaxPoolNode;var ReLUNode=function(_super){function ReLUNode(graph,x){return _super.call(this,graph,"ReLU",{x:x},new Tensor(x.shape))||this}return __extends(ReLUNode,_super),ReLUNode.prototype.validate=function(){},ReLUNode.X="x",ReLUNode}(Node);exports.ReLUNode=ReLUNode;var ExpNode=function(_super){function ExpNode(graph,x){return _super.call(this,graph,"Exp",{x:x},new Tensor(x.shape))||this}return __extends(ExpNode,_super),ExpNode.prototype.validate=function(){},ExpNode.X="x",ExpNode}(Node);exports.ExpNode=ExpNode;var LogNode=function(_super){function LogNode(graph,x){return _super.call(this,graph,"Log",{x:x},new Tensor(x.shape))||this}return __extends(LogNode,_super),LogNode.prototype.validate=function(){},LogNode.X="x",LogNode}(Node);exports.LogNode=LogNode;var TanHNode=function(_super){function TanHNode(graph,x){return _super.call(this,graph,"TanH",{x:x},new Tensor(x.shape))||this}return __extends(TanHNode,_super),TanHNode.prototype.validate=function(){},TanHNode.X="x",TanHNode}(Node);exports.TanHNode=TanHNode;var SigmoidNode=function(_super){function SigmoidNode(graph,x){return _super.call(this,graph,"Sigmoid",{x:x},new Tensor(x.shape))||this}return __extends(SigmoidNode,_super),SigmoidNode.prototype.validate=function(){},SigmoidNode.X="x",SigmoidNode}(Node);exports.SigmoidNode=SigmoidNode;var SquareNode=function(_super){function SquareNode(graph,x){return _super.call(this,graph,"Square",{x:x},new Tensor(x.shape))||this}return __extends(SquareNode,_super),SquareNode.prototype.validate=function(){},SquareNode.X="x",SquareNode}(Node);exports.SquareNode=SquareNode;var SoftmaxCrossEntropyCostNode=function(_super){function SoftmaxCrossEntropyCostNode(graph,x,target){var _this=_super.call(this,graph,"SoftmaxCrossEntropyCost",{x:x,target:target},new Tensor([]))||this;return _this.x=x,_this.target=target,_this}return __extends(SoftmaxCrossEntropyCostNode,_super),SoftmaxCrossEntropyCostNode.prototype.validate=function(){util.assert(util.arraysEqual(this.x.shape,this.target.shape),"Error adding softmaxCrossEntropyCost op: x shape ("+this.x.shape+") must match target shape ("+this.target.shape+").")},SoftmaxCrossEntropyCostNode.X="x",SoftmaxCrossEntropyCostNode.TARGET="target",SoftmaxCrossEntropyCostNode}(Node);exports.SoftmaxCrossEntropyCostNode=SoftmaxCrossEntropyCostNode;var SoftmaxNode=function(_super){function SoftmaxNode(graph,x){var _this=_super.call(this,graph,"Softmax",{x:x},new Tensor(x.shape))||this;return _this.x=x,_this}return __extends(SoftmaxNode,_super),SoftmaxNode.prototype.validate=function(){util.assert(1===this.x.shape.length,"The input to a softmax must be a 1-D tensor"),util.assert(this.x.shape[0]>=2,"The input to a softmax must have at least 2 values")},SoftmaxNode.X="x",SoftmaxNode}(Node);exports.SoftmaxNode=SoftmaxNode;var MeanSquaredCostNode=function(_super){function MeanSquaredCostNode(graph,label,prediction){var _this=_super.call(this,graph,"Mean Squared Cost",{label:label,prediction:prediction},new Tensor([]))||this;return _this.label=label,_this.prediction=prediction,_this}return __extends(MeanSquaredCostNode,_super),MeanSquaredCostNode.prototype.validate=function(){util.assert(util.arraysEqual(this.label.shape,this.prediction.shape),"Error adding meanSquaredCost op: label shape ("+this.label.shape+") must match prediction shape ("+this.prediction.shape+").")},MeanSquaredCostNode.LABEL="label",MeanSquaredCostNode.PREDICTION="prediction",MeanSquaredCostNode}(Node);exports.MeanSquaredCostNode=MeanSquaredCostNode;var ArgMaxNode=function(_super){function ArgMaxNode(graph,x){var _this=_super.call(this,graph,"ArgMax",{x:x},new Tensor([1]))||this;return _this.x=x,_this}return __extends(ArgMaxNode,_super),ArgMaxNode.prototype.validate=function(){util.assert(util.sizeFromShape(this.x.shape)>0,"Error adding argmax op: input tensor must have at least one entry.")},ArgMaxNode.X="x",ArgMaxNode}(Node);exports.ArgMaxNode=ArgMaxNode;var ArgMaxEqualsNode=function(_super){function ArgMaxEqualsNode(graph,x1,x2){var _this=_super.call(this,graph,"ArgMaxEquals",{x1:x1,x2:x2},new Tensor([1]))||this;return _this.x1=x1,_this.x2=x2,_this}return __extends(ArgMaxEqualsNode,_super),ArgMaxEqualsNode.prototype.validate=function(){util.assert(util.arraysEqual(this.x1.shape,this.x2.shape),"Error adding ArgMaxEquals op: x1 shape ("+this.x1.shape+") must match x2 shape ("+this.x2.shape+").")},ArgMaxEqualsNode.X1="x1",ArgMaxEqualsNode.X2="x2",ArgMaxEqualsNode}(Node);exports.ArgMaxEqualsNode=ArgMaxEqualsNode},{"../initializers":42,"../math/concat_util":44,"../math/conv_util":45,"../math/ndarray":51,"../util":82}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var graph_1=require("./graph"),priority_queue=require("./priority_queue"),priority_queue_1=require("./priority_queue");exports.getUnorderedEvaluationSet=function(nodes,terminatingNodes){var terminatingNodeMap={},seen={},set=[],visit=nodes.slice();terminatingNodes.forEach(function(node){return terminatingNodeMap[node.id]=node});for(;0!==visit.length;)!function(){var cur=visit.pop();null==seen[cur.id]&&(null==terminatingNodeMap[cur.id]&&Object.keys(cur.inputs).map(function(inputName){return cur.inputs[inputName]}).forEach(function(input){return visit.push(input.node)}),set.push(cur),seen[cur.id]=cur)}();return set},exports.getOrderedEvaluationSet=function(unorderedEvaluationSet){var set=[],nodeIndices={},pendingDependencies={},nodeQueue=new priority_queue_1.PriorityQueue(function(a,b){return priority_queue.defaultCompare(pendingDependencies[a.id],pendingDependencies[b.id])},function(node,newIndex){return nodeIndices[node.id]=newIndex});for(unorderedEvaluationSet.forEach(function(node){return pendingDependencies[node.id]=0}),unorderedEvaluationSet.forEach(function(node){return Object.keys(node.inputs).map(function(key){return node.inputs[key]}).forEach(function(input){-1!==unorderedEvaluationSet.indexOf(input.node)&&pendingDependencies[input.node.id]++})}),unorderedEvaluationSet.forEach(function(node){return nodeQueue.enqueue(node)});!nodeQueue.empty();)set.unshift(nodeQueue.dequeue()),Object.keys(set[0].inputs).map(function(key){return set[0].inputs[key]}).forEach(function(input){-1!==unorderedEvaluationSet.indexOf(input.node)&&(pendingDependencies[input.node.id]--,nodeQueue.update(input.node,nodeIndices[input.node.id]))});return set},exports.isInputNode=function(node){return 0===Object.keys(node.inputs).length},exports.shouldBackProp=function(t){return!(t.node instanceof graph_1.ConstantNode)},exports.isPassthroughNode=function(node,map){for(var keys=Object.keys(node.inputs),i=0;i<keys.length;i++){var input=node.inputs[keys[i]];if(map.get(input,!0)===map.get(node.output,!0))return!0}return!1}},{"./graph":8,"./priority_queue":36}],10:[function(require,module,exports){"use strict";function emitOpFromNode(node){if(node instanceof graph_1.ReshapeNode)return[new reshape_1.Reshape(node.inputs[graph_1.ReshapeNode.X],node.output)];if(node instanceof graph_1.MatMulNode){var x1=node.inputs[graph_1.MatMulNode.X1],x2=node.inputs[graph_1.MatMulNode.X2];return[new matmul_1.MatMul(x1,x2,node.output)]}if(node instanceof graph_1.Convolution2DNode){var w=node.inputs[graph_1.Convolution2DNode.W],x=node.inputs[graph_1.Convolution2DNode.X],b=node.inputs[graph_1.Convolution2DNode.B];return[new convolution_1.Convolution2D(w,x,b,node.output,node.fieldSize,node.outputDepth,node.stride,node.zeroPad)]}if(node instanceof graph_1.MaxPoolNode){x=node.inputs[graph_1.MaxPoolNode.X];return[new max_pool_1.MaxPool(x,node.output,node.fieldSize,node.stride,node.zeroPad)]}if(node instanceof graph_1.ExpNode)return[new exp_1.Exp(node.inputs[graph_1.ExpNode.X],node.output)];if(node instanceof graph_1.LogNode)return[new log_1.Log(node.inputs[graph_1.LogNode.X],node.output)];if(node instanceof graph_1.ReLUNode)return[new element_wise_activation_1.ReLU(node.inputs[graph_1.ReLUNode.X],node.output)];if(node instanceof graph_1.TanHNode)return[new element_wise_activation_1.TanH(node.inputs[graph_1.TanHNode.X],node.output)];if(node instanceof graph_1.SigmoidNode)return[new element_wise_activation_1.Sigmoid(node.inputs[graph_1.SigmoidNode.X],node.output)];if(node instanceof graph_1.SoftmaxCrossEntropyCostNode){var x=node.inputs[graph_1.SoftmaxCrossEntropyCostNode.X],target=node.inputs[graph_1.SoftmaxCrossEntropyCostNode.TARGET];return[new softmax_1.SoftmaxCrossEntropyCost(x,target,node.output)]}if(node instanceof graph_1.SoftmaxNode)return[new softmax_1.Softmax(node.inputs[graph_1.SoftmaxNode.X],node.output)];if(node instanceof graph_1.MeanSquaredCostNode){var label=node.inputs[graph_1.MeanSquaredCostNode.LABEL],prediction=node.inputs[graph_1.MeanSquaredCostNode.PREDICTION];return[new element_wise_cost_1.MeanSquaredCost(label,prediction,node.output)]}if(node instanceof graph_1.ArgMaxEqualsNode)return[new argmaxequals_1.ArgMaxEquals(node.inputs[graph_1.ArgMaxEqualsNode.X1],node.inputs[graph_1.ArgMaxEqualsNode.X2],node.output)];if(node instanceof graph_1.ArgMaxNode)return[new argmax_1.ArgMax(node.x,node.output)];if(node instanceof graph_1.FusedLinearCombinationNode)return[new linear_combination_1.LinearCombination(node.inputs[graph_1.FusedLinearCombinationNode.T1],node.inputs[graph_1.FusedLinearCombinationNode.T2],node.inputs[graph_1.FusedLinearCombinationNode.C1],node.inputs[graph_1.FusedLinearCombinationNode.C2],node.output)];if(node instanceof graph_1.Concat3DNode)return[new concat3d_1.Concat3D(node.inputs[graph_1.Concat3DNode.X1],node.inputs[graph_1.Concat3DNode.X2],node.axis,node.output)];if(node instanceof graph_1.SquareNode)return[new element_wise_activation_1.Square(node.inputs[graph_1.SquareNode.X],node.output)];if(node instanceof graph_1.AddNode)return[new add_1.Add(node.inputs[graph_1.AddNode.T1],node.inputs[graph_1.AddNode.T2],node.output)];if(node instanceof graph_1.SubtractNode)return[new subtract_1.Subtract(node.inputs[graph_1.SubtractNode.T1],node.inputs[graph_1.SubtractNode.T2],node.output)];if(node instanceof graph_1.MultiplyNode)return[new multiply_1.Multiply(node.inputs[graph_1.MultiplyNode.T1],node.inputs[graph_1.MultiplyNode.T2],node.output)];if(node instanceof graph_1.DivideNode)return[new divide_1.Divide(node.inputs[graph_1.DivideNode.T1],node.inputs[graph_1.DivideNode.T2],node.output)];if(node instanceof graph_1.ReduceSumNode)return[new reduce_sum_1.ReduceSum(node.inputs[graph_1.ReduceSumNode.X],node.output)];if(graph_util.isInputNode(node))return[];throw Error("Unsupported node type: "+node.constructor.name)}Object.defineProperty(exports,"__esModule",{value:!0});var graph_1=require("./graph"),graph_util=require("./graph_util"),add_1=require("./ops/add"),argmax_1=require("./ops/argmax"),argmaxequals_1=require("./ops/argmaxequals"),concat3d_1=require("./ops/concat3d"),convolution_1=require("./ops/convolution"),divide_1=require("./ops/divide"),element_wise_activation_1=require("./ops/element_wise_activation"),element_wise_cost_1=require("./ops/element_wise_cost"),exp_1=require("./ops/exp"),linear_combination_1=require("./ops/linear_combination"),log_1=require("./ops/log"),matmul_1=require("./ops/matmul"),max_pool_1=require("./ops/max_pool"),multiply_1=require("./ops/multiply"),reduce_sum_1=require("./ops/reduce_sum"),reshape_1=require("./ops/reshape"),softmax_1=require("./ops/softmax"),subtract_1=require("./ops/subtract");exports.emitFromGraphNodes=function(nodes){var ops=[];return nodes.forEach(function(node){return Array.prototype.push.apply(ops,emitOpFromNode(node))}),ops}},{"./graph":8,"./graph_util":9,"./ops/add":11,"./ops/argmax":12,"./ops/argmaxequals":13,"./ops/concat3d":14,"./ops/convolution":15,"./ops/divide":16,"./ops/element_wise_activation":17,"./ops/element_wise_cost":18,"./ops/exp":19,"./ops/linear_combination":20,"./ops/log":21,"./ops/matmul":22,"./ops/max_pool":23,"./ops/multiply":24,"./ops/reduce_sum":26,"./ops/reshape":27,"./ops/softmax":28,"./ops/subtract":29}],11:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),util=require("../../util"),graph_util=require("../graph_util"),Add=function(_super){function Add(x1Tensor,x2Tensor,yTensor){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.yTensor=yTensor,util.assert(1===util.sizeFromShape(x1Tensor.shape)||1===util.sizeFromShape(x2Tensor.shape)||util.arraysEqual(x1Tensor.shape,x2Tensor.shape),"One of t1 or t2 must be a scalar, or t1 and t2 must have the same shape"),_this}return __extends(Add,_super),Add.prototype.feedForward=function(math,inferenceArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor);math.scope(function(keep){var result;result=util.isScalarShape(x1.shape)?math.scalarPlusArray(x1,x2):util.isScalarShape(x2.shape)?math.scalarPlusArray(x2,x1):math.add(x1,x2),inferenceArrays.set(_this.yTensor,keep(result))})},Add.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,dy=gradientArrays.get(this.yTensor);math.scope(function(){if(graph_util.shouldBackProp(_this.x1Tensor))if(util.isScalarShape(_this.x1Tensor.shape)){sum=math.sum(dy);null==_this.dySizeScalar&&(_this.dySizeScalar=ndarray_1.Scalar.new(dy.size)),gradientArrays.add(_this.x1Tensor,math.divide(sum,_this.dySizeScalar))}else gradientArrays.add(_this.x1Tensor,math.clone(dy));if(graph_util.shouldBackProp(_this.x2Tensor))if(util.isScalarShape(_this.x2Tensor.shape)){var sum=math.sum(dy);null==_this.dySizeScalar&&(_this.dySizeScalar=ndarray_1.Scalar.new(dy.size)),gradientArrays.add(_this.x2Tensor,math.divide(sum,_this.dySizeScalar))}else gradientArrays.add(_this.x2Tensor,math.clone(dy))})},Add.prototype.dispose=function(){null!=this.dySizeScalar&&this.dySizeScalar.dispose()},Add}(require("./op").Operation);exports.Add=Add},{"../../math/ndarray":51,"../../util":82,"../graph_util":9,"./op":25}],12:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ArgMax=function(_super){function ArgMax(xTensor,yTensor){var _this=_super.call(this)||this;return _this.xTensor=xTensor,_this.yTensor=yTensor,_this}return __extends(ArgMax,_super),ArgMax.prototype.feedForward=function(math,inferenceArrays){var _this=this,x=inferenceArrays.get(this.xTensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(math.argMax(x)))})},ArgMax.prototype.backProp=function(math,inferenceArrays,gradientArrays){throw new Error("ArgMax backprop unimplemented")},ArgMax}(require("./op").Operation);exports.ArgMax=ArgMax},{"./op":25}],13:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ArgMaxEquals=function(_super){function ArgMaxEquals(x1Tensor,x2Tensor,yTensor){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.yTensor=yTensor,_this}return __extends(ArgMaxEquals,_super),ArgMaxEquals.prototype.feedForward=function(math,inferenceArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(math.argMaxEquals(x1,x2)))})},ArgMaxEquals.prototype.backProp=function(math,inferenceArrays,gradientArrays){throw new Error("ArgMaxEquals backprop unimplemented")},ArgMaxEquals}(require("./op").Operation);exports.ArgMaxEquals=ArgMaxEquals},{"./op":25}],14:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var concat_util=require("../../math/concat_util"),Concat3D=function(_super){function Concat3D(x1Tensor,x2Tensor,axis,yTensor){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.axis=axis,_this.yTensor=yTensor,concat_util.assertParams(x1Tensor.shape,x2Tensor.shape,axis),_this}return __extends(Concat3D,_super),Concat3D.prototype.feedForward=function(math,inferenceArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor);math.scope(function(keep){var concatResult=math.concat3D(x1,x2,_this.axis);inferenceArrays.set(_this.yTensor,keep(concatResult))})},Concat3D.prototype.backProp=function(math,inferenceArrays,gradientArrays){throw new Error("Concat3D backprop not implemented.")},Concat3D}(require("./op").Operation);exports.Concat3D=Concat3D},{"../../math/concat_util":44,"./op":25}],15:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var conv_util=require("../../math/conv_util"),util=require("../../util"),Convolution2D=function(_super){function Convolution2D(wTensor,xTensor,bTensor,yTensor,fieldSize,outputDepth,stride,zeroPad){void 0===stride&&(stride=1);var _this=_super.call(this)||this;return _this.wTensor=wTensor,_this.xTensor=xTensor,_this.bTensor=bTensor,_this.yTensor=yTensor,_this.fieldSize=fieldSize,_this.outputDepth=outputDepth,_this.stride=stride,_this.assertWeightsShape(wTensor.shape),_this.zeroPad=null!=zeroPad?zeroPad:conv_util.computeDefaultPad(_this.xTensor.shape,_this.fieldSize,_this.stride),util.assert(util.isInt(_this.zeroPad),"The zero padding ("+_this.zeroPad+") must be an integer. Change the stride and/or zero pad parameters"),_this}return __extends(Convolution2D,_super),Convolution2D.prototype.feedForward=function(math,inferenceArrays){var _this=this,weights=inferenceArrays.get(this.wTensor),biases=inferenceArrays.get(this.bTensor),x=inferenceArrays.get(this.xTensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(math.conv2d(x,weights,biases,_this.stride,_this.zeroPad)))})},Convolution2D.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,weights=inferenceArrays.get(this.wTensor),x=inferenceArrays.get(this.xTensor),dy=gradientArrays.get(this.yTensor);math.scope(function(){var _a=math.conv2dBackProp(x,dy,weights,_this.stride,_this.zeroPad),dw=_a.dw,db=_a.db,dx=_a.dx;gradientArrays.add(_this.wTensor,dw),gradientArrays.add(_this.bTensor,db),gradientArrays.add(_this.xTensor,dx)})},Convolution2D.prototype.assertWeightsShape=function(weightsShape){util.assert(weightsShape[0]===this.fieldSize&&weightsShape[1]===this.fieldSize&&weightsShape[2]===this.xTensor.shape[2]&&weightsShape[3]===this.outputDepth,"weights must be of shape ["+this.fieldSize+","+this.fieldSize+","+this.xTensor.shape[2]+","+this.outputDepth+"] but they are ofshape ["+weightsShape+"]")},Convolution2D}(require("./op").Operation);exports.Convolution2D=Convolution2D},{"../../math/conv_util":45,"../../util":82,"./op":25}],16:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util"),graph_util=require("../graph_util"),Divide=function(_super){function Divide(x1Tensor,x2Tensor,yTensor){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.yTensor=yTensor,util.assert(1===util.sizeFromShape(x1Tensor.shape)||1===util.sizeFromShape(x2Tensor.shape)||util.arraysEqual(x1Tensor.shape,x2Tensor.shape),"One of t1 or t2 must be a scalar, or t1 and t2 must have the same shape"),_this}return __extends(Divide,_super),Divide.prototype.feedForward=function(math,inferenceArrays){var _this=this,t1=inferenceArrays.get(this.x1Tensor),t2=inferenceArrays.get(this.x2Tensor);math.scope(function(keep){var result;result=util.isScalarShape(t1.shape)?math.scalarDividedByArray(t1,t2):util.isScalarShape(t2.shape)?math.arrayDividedByScalar(t1,t2):math.divide(t1,t2),inferenceArrays.set(_this.yTensor,keep(result))})},Divide.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor),dy=gradientArrays.get(this.yTensor),x1IsScalar=util.isScalarShape(x1.shape),x2IsScalar=util.isScalarShape(x2.shape);math.scope(function(){if(graph_util.shouldBackProp(_this.x1Tensor))if(x1IsScalar){var div=math.divide(dy,x2);gradientArrays.add(_this.x1Tensor,math.sum(div)),div.dispose()}else x2IsScalar?gradientArrays.add(_this.x1Tensor,math.arrayDividedByScalar(dy,x2)):gradientArrays.add(_this.x1Tensor,math.divide(dy,x2));if(graph_util.shouldBackProp(_this.x2Tensor)){var x2Squared=math.elementWiseMul(x2,x2),x1OverX2Squared=void 0;x1OverX2Squared=x2IsScalar?math.arrayDividedByScalar(x1,x2Squared):x1IsScalar?math.scalarDividedByArray(x1,x2Squared):math.divide(x1,x2Squared);var dx2=math.neg(x1OverX2Squared),dyTimesDerivative=math.elementWiseMul(dy,dx2);x2IsScalar?gradientArrays.add(_this.x2Tensor,math.sum(dyTimesDerivative)):gradientArrays.add(_this.x2Tensor,dyTimesDerivative)}})},Divide}(require("./op").Operation);exports.Divide=Divide},{"../../util":82,"../graph_util":9,"./op":25}],17:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var activation_functions_1=require("../../math/activation_functions"),ElementWiseActivation=function(_super){function ElementWiseActivation(xTensor,yTensor,func){var _this=_super.call(this)||this;return _this.xTensor=xTensor,_this.yTensor=yTensor,_this.func=func,_this}return __extends(ElementWiseActivation,_super),ElementWiseActivation.prototype.feedForward=function(math,inferenceArrays){var _this=this,x=inferenceArrays.get(this.xTensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(_this.func.output(math,x)))})},ElementWiseActivation.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x=inferenceArrays.get(this.xTensor),y=inferenceArrays.get(this.yTensor),dy=gradientArrays.get(this.yTensor);math.scope(function(){var dydx=_this.func.der(math,x,y);gradientArrays.add(_this.xTensor,math.elementWiseMul(dy,dydx)),dydx.dispose()})},ElementWiseActivation}(require("./op").Operation);exports.ElementWiseActivation=ElementWiseActivation;var ReLU=function(_super){function ReLU(xTensor,yTensor){return _super.call(this,xTensor,yTensor,new activation_functions_1.ReLUFunc)||this}return __extends(ReLU,_super),ReLU}(ElementWiseActivation);exports.ReLU=ReLU;var TanH=function(_super){function TanH(xTensor,yTensor){return _super.call(this,xTensor,yTensor,new activation_functions_1.TanHFunc)||this}return __extends(TanH,_super),TanH}(ElementWiseActivation);exports.TanH=TanH;var Sigmoid=function(_super){function Sigmoid(xTensor,yTensor){return _super.call(this,xTensor,yTensor,new activation_functions_1.SigmoidFunc)||this}return __extends(Sigmoid,_super),Sigmoid}(ElementWiseActivation);exports.Sigmoid=Sigmoid;var Square=function(_super){function Square(xTensor,yTensor){return _super.call(this,xTensor,yTensor,new activation_functions_1.SquareFunc)||this}return __extends(Square,_super),Square}(ElementWiseActivation);exports.Square=Square},{"../../math/activation_functions":43,"./op":25}],18:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var cost_functions_1=require("../../math/cost_functions"),ndarray_1=require("../../math/ndarray"),util=require("../../util"),graph_util=require("../graph_util"),ElementWiseCost=function(_super){function ElementWiseCost(x1Tensor,x2Tensor,yTensor,func){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.yTensor=yTensor,_this.func=func,_this.oneOverNScalar=ndarray_1.Scalar.new(1/util.sizeFromShape(x1Tensor.shape)),_this}return __extends(ElementWiseCost,_super),ElementWiseCost.prototype.feedForward=function(math,inferenceArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor);math.scope(function(keep){var elementWiseCost=_this.func.cost(math,x1,x2),sum=math.sum(elementWiseCost),result=math.scalarTimesArray(_this.oneOverNScalar,sum);inferenceArrays.set(_this.yTensor,keep(result))})},ElementWiseCost.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor);math.scope(function(){graph_util.shouldBackProp(_this.x1Tensor)&&gradientArrays.add(_this.x1Tensor,_this.func.der(math,x1,x2)),graph_util.shouldBackProp(_this.x2Tensor)&&gradientArrays.add(_this.x2Tensor,_this.func.der(math,x2,x1))})},ElementWiseCost.prototype.dispose=function(){this.func.dispose(),this.oneOverNScalar.dispose()},ElementWiseCost}(require("./op").Operation);exports.ElementWiseCost=ElementWiseCost;var MeanSquaredCost=function(_super){function MeanSquaredCost(x1Tensor,x2Tensor,yTensor){return _super.call(this,x1Tensor,x2Tensor,yTensor,new cost_functions_1.SquareCostFunc)||this}return __extends(MeanSquaredCost,_super),MeanSquaredCost}(ElementWiseCost);exports.MeanSquaredCost=MeanSquaredCost},{"../../math/cost_functions":47,"../../math/ndarray":51,"../../util":82,"../graph_util":9,"./op":25}],19:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var graph_util=require("../graph_util"),Exp=function(_super){function Exp(xTensor,yTensor){var _this=_super.call(this)||this;return _this.xTensor=xTensor,_this.yTensor=yTensor,_this}return __extends(Exp,_super),Exp.prototype.feedForward=function(math,inferenceArrays){var _this=this,x=inferenceArrays.get(this.xTensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(math.exp(x)))})},Exp.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,y=inferenceArrays.get(this.yTensor),dy=gradientArrays.get(this.yTensor);math.scope(function(){graph_util.shouldBackProp(_this.xTensor)&&gradientArrays.add(_this.xTensor,math.elementWiseMul(y,dy))})},Exp}(require("./op").Operation);exports.Exp=Exp},{"../graph_util":9,"./op":25}],20:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var graph_util=require("../graph_util"),LinearCombination=function(_super){function LinearCombination(x1Tensor,x2Tensor,c1Tensor,c2Tensor,outTensor){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.c1Tensor=c1Tensor,_this.c2Tensor=c2Tensor,_this.outTensor=outTensor,_this}return __extends(LinearCombination,_super),LinearCombination.prototype.feedForward=function(math,inferenceArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor),c1=inferenceArrays.get(this.c1Tensor).asScalar(),c2=inferenceArrays.get(this.c2Tensor).asScalar();math.scope(function(keep){inferenceArrays.set(_this.outTensor,keep(math.scaledArrayAdd(c1,x1,c2,x2)))})},LinearCombination.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor),c1=inferenceArrays.get(this.c1Tensor),c2=inferenceArrays.get(this.c2Tensor),dy=gradientArrays.get(this.outTensor);math.scope(function(){if(graph_util.shouldBackProp(_this.x1Tensor)&&gradientArrays.add(_this.x1Tensor,math.scalarTimesArray(c1,dy)),graph_util.shouldBackProp(_this.x2Tensor)&&gradientArrays.add(_this.x2Tensor,math.scalarTimesArray(c2,dy)),graph_util.shouldBackProp(_this.c1Tensor)){var dotProduct1=math.elementWiseMul(x1,dy);gradientArrays.add(_this.c1Tensor,math.sum(dotProduct1))}if(graph_util.shouldBackProp(_this.c2Tensor)){var dotProduct2=math.elementWiseMul(x2,dy);gradientArrays.add(_this.c2Tensor,math.sum(dotProduct2))}})},LinearCombination}(require("./op").Operation);exports.LinearCombination=LinearCombination},{"../graph_util":9,"./op":25}],21:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var graph_util=require("../graph_util"),Log=function(_super){function Log(xTensor,yTensor){var _this=_super.call(this)||this;return _this.xTensor=xTensor,_this.yTensor=yTensor,_this}return __extends(Log,_super),Log.prototype.feedForward=function(math,inferenceArrays){var _this=this,x=inferenceArrays.get(this.xTensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(math.log(x)))})},Log.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x=inferenceArrays.get(this.xTensor),dy=gradientArrays.get(this.yTensor);math.scope(function(){graph_util.shouldBackProp(_this.xTensor)&&gradientArrays.add(_this.xTensor,math.divide(dy,x))})},Log}(require("./op").Operation);exports.Log=Log},{"../graph_util":9,"./op":25}],22:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var math_1=require("../../math/math"),graph_util=require("../graph_util"),MatMul=function(_super){function MatMul(x1Tensor,x2Tensor,yTensor){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.yTensor=yTensor,_this}return __extends(MatMul,_super),MatMul.prototype.feedForward=function(math,inferenceArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor);math.scope(function(keep){2===x1.shape.length&&2===x2.shape.length?inferenceArrays.set(_this.yTensor,keep(math.matMul(x1,x2))):2===x1.shape.length&&1===x2.shape.length?inferenceArrays.set(_this.yTensor,keep(math.matrixTimesVector(x1,x2))):1===x1.shape.length&&2===x2.shape.length&&inferenceArrays.set(_this.yTensor,keep(math.vectorTimesMatrix(x1,x2)))})},MatMul.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor),dy=gradientArrays.get(this.yTensor);1===x1.shape.length&&(x1=x1.reshape([1,x1.size]),dy=dy.reshape([1,dy.size])),1===x2.shape.length&&(x2=x2.reshape([x2.size,1]),dy=dy.reshape([dy.size,1])),math.scope(function(){if(graph_util.shouldBackProp(_this.x1Tensor)){var dx1=math.matMul(dy,x2,math_1.MatrixOrientation.REGULAR,math_1.MatrixOrientation.TRANSPOSED);gradientArrays.add(_this.x1Tensor,1===_this.x1Tensor.shape.length?dx1.as1D():dx1)}if(graph_util.shouldBackProp(_this.x2Tensor)){var dx2=math.matMul(x1,dy,math_1.MatrixOrientation.TRANSPOSED,math_1.MatrixOrientation.REGULAR);gradientArrays.add(_this.x2Tensor,1===_this.x2Tensor.shape.length?dx2.as1D():dx2)}})},MatMul}(require("./op").Operation);exports.MatMul=MatMul},{"../../math/math":48,"../graph_util":9,"./op":25}],23:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var conv_util=require("../../math/conv_util"),util=require("../../util"),MaxPool=function(_super){function MaxPool(xTensor,yTensor,fieldSize,stride,pad){void 0===stride&&(stride=1);var _this=_super.call(this)||this;return _this.xTensor=xTensor,_this.yTensor=yTensor,_this.fieldSize=fieldSize,_this.stride=stride,_this.pad=null!=pad?pad:conv_util.computeDefaultPad(xTensor.shape,_this.fieldSize,_this.stride),util.assert(util.isInt(_this.pad),"The zero padding ("+_this.pad+") must be an integer. Change the stride and/or zero pad parameters"),_this}return __extends(MaxPool,_super),MaxPool.prototype.feedForward=function(math,inferenceArrays){var _this=this,x=inferenceArrays.get(this.xTensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(math.maxPool(x,_this.fieldSize,_this.stride,_this.pad)))})},MaxPool.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x=inferenceArrays.get(this.xTensor),dy=gradientArrays.get(this.yTensor);math.scope(function(){gradientArrays.add(_this.xTensor,math.maxPoolBackprop(dy,x,_this.fieldSize,_this.stride,_this.pad))})},MaxPool}(require("./op").Operation);exports.MaxPool=MaxPool},{"../../math/conv_util":45,"../../util":82,"./op":25}],24:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util"),graph_util=require("../graph_util"),Multiply=function(_super){function Multiply(x1Tensor,x2Tensor,yTensor){var _this=_super.call(this)||this;return _this.x1Tensor=x1Tensor,_this.x2Tensor=x2Tensor,_this.yTensor=yTensor,util.assert(1===util.sizeFromShape(x1Tensor.shape)||1===util.sizeFromShape(x2Tensor.shape)||util.arraysEqual(x1Tensor.shape,x2Tensor.shape),"One of t1 or t2 must be a scalar, or t1 and t2 must have the same shape"),_this}return __extends(Multiply,_super),Multiply.prototype.feedForward=function(math,inferenceArrays){var _this=this,t1=inferenceArrays.get(this.x1Tensor),t2=inferenceArrays.get(this.x2Tensor);math.scope(function(keep){var result;result=util.isScalarShape(t1.shape)?math.scalarTimesArray(t1,t2):util.isScalarShape(t2.shape)?math.scalarTimesArray(t2,t1):math.elementWiseMul(t1,t2),inferenceArrays.set(_this.yTensor,keep(result))})},Multiply.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,x1=inferenceArrays.get(this.x1Tensor),x2=inferenceArrays.get(this.x2Tensor),dy=gradientArrays.get(this.yTensor);math.scope(function(){if(graph_util.shouldBackProp(_this.x1Tensor))if(util.isScalarShape(_this.x1Tensor.shape)){mul=math.elementWiseMul(dy,x2);gradientArrays.add(_this.x1Tensor,math.sum(mul))}else util.isScalarShape(x2.shape)?gradientArrays.add(_this.x1Tensor,math.scalarTimesArray(x2,dy)):gradientArrays.add(_this.x1Tensor,math.elementWiseMul(x2,dy));if(graph_util.shouldBackProp(_this.x2Tensor))if(util.isScalarShape(_this.x2Tensor.shape)){var mul=math.elementWiseMul(dy,x1);gradientArrays.add(_this.x2Tensor,math.sum(mul))}else util.isScalarShape(x1.shape)?gradientArrays.add(_this.x2Tensor,math.scalarTimesArray(x1,dy)):gradientArrays.add(_this.x2Tensor,math.elementWiseMul(x1,dy))})},Multiply}(require("./op").Operation);exports.Multiply=Multiply},{"../../util":82,"../graph_util":9,"./op":25}],25:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Operation=function(){function Operation(){}return Operation.prototype.disposeTransientArrays=function(inferenceArrays,gradientArrays){},Operation.prototype.dispose=function(){},Operation}();exports.Operation=Operation},{}],26:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),util=require("../../util"),graph_util=require("../graph_util"),ReduceSum=function(_super){function ReduceSum(x,outTensor){var _this=_super.call(this)||this;return _this.x=x,_this.outTensor=outTensor,util.assertShapesMatch(outTensor.shape,[]),_this}return __extends(ReduceSum,_super),ReduceSum.prototype.feedForward=function(math,inferenceArrays){var _this=this,x=inferenceArrays.get(this.x);math.scope(function(keep){inferenceArrays.set(_this.outTensor,keep(math.sum(x)))})},ReduceSum.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this;graph_util.shouldBackProp(this.x)&&math.scope(function(){var dy=gradientArrays.get(_this.outTensor);if(null==_this.ones){var xArray=inferenceArrays.get(_this.x);_this.ones=ndarray_1.NDArray.zerosLike(xArray),_this.ones.fill(1)}gradientArrays.add(_this.x,math.scalarTimesArray(dy,_this.ones))})},ReduceSum}(require("./op").Operation);exports.ReduceSum=ReduceSum},{"../../math/ndarray":51,"../../util":82,"../graph_util":9,"./op":25}],27:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util"),Reshape=function(_super){function Reshape(xTensor,yTensor){var _this=_super.call(this)||this;_this.xTensor=xTensor,_this.yTensor=yTensor;var xSize=util.sizeFromShape(xTensor.shape),ySize=util.sizeFromShape(yTensor.shape);return util.assert(xSize===ySize,"The input size ("+xSize+") and output size ("+ySize+") must match"),_this}return __extends(Reshape,_super),Reshape.prototype.feedForward=function(math,inferenceArrays){var _this=this,x=inferenceArrays.get(this.xTensor);math.scope(function(keep){inferenceArrays.set(_this.yTensor,keep(x.reshape(_this.yTensor.shape)))})},Reshape.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,dy=gradientArrays.get(this.yTensor);math.scope(function(){gradientArrays.add(_this.xTensor,dy.reshape(_this.xTensor.shape))})},Reshape}(require("./op").Operation);exports.Reshape=Reshape},{"../../util":82,"./op":25}],28:[function(require,module,exports){"use strict";function crossEntropyCost(math,y,target,epsilon){return util.assert(y.size===target.size,"The output and target must be the same size"),math.scope(function(){var yPlusEps=math.scalarPlusArray(epsilon,y),logOutput=math.log(yPlusEps),tarLogOutput=math.elementWiseMul(target,logOutput),costVector=math.neg(tarLogOutput);return math.sum(costVector)})}var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),util=require("../../util"),graph_1=require("../graph"),op_1=require("./op"),Softmax=function(_super){function Softmax(logitsTensor,output){var _this=_super.call(this)||this;return _this.logitsTensor=logitsTensor,_this.output=output,_this}return __extends(Softmax,_super),Softmax.prototype.feedForward=function(math,inferenceArrays){var _this=this,logits=inferenceArrays.get(this.logitsTensor);return math.scope(function(keep){inferenceArrays.set(_this.output,keep(math.softmax(logits)))})},Softmax.prototype.backProp=function(){throw Error("Softmax backprop is not yet implemented")},Softmax}(op_1.Operation);exports.Softmax=Softmax;var SoftmaxCrossEntropyCost=function(_super){function SoftmaxCrossEntropyCost(logitsTensor,labelTensor,yTensor){var _this=_super.call(this)||this;return _this.logitsTensor=logitsTensor,_this.labelTensor=labelTensor,_this.yTensor=yTensor,_this.epsilon=ndarray_1.Scalar.new(1e-5),_this.softmaxTensor=new graph_1.Tensor(logitsTensor.shape),_this}return __extends(SoftmaxCrossEntropyCost,_super),SoftmaxCrossEntropyCost.prototype.feedForward=function(math,inferenceArrays){var _this=this,logits=inferenceArrays.get(this.logitsTensor),label=inferenceArrays.get(this.labelTensor);math.scope(function(keep){var softmaxResult=math.softmax(logits);inferenceArrays.set(_this.softmaxTensor,keep(softmaxResult)),inferenceArrays.set(_this.yTensor,keep(crossEntropyCost(math,softmaxResult,label,_this.epsilon)))})},SoftmaxCrossEntropyCost.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,softmax=inferenceArrays.get(this.softmaxTensor),label=inferenceArrays.get(this.labelTensor);math.scope(function(){gradientArrays.add(_this.logitsTensor,math.sub(softmax,label))})},SoftmaxCrossEntropyCost.prototype.disposeTransientArrays=function(inferenceArrays,gradientArrays){inferenceArrays.disposeArray(this.softmaxTensor)},SoftmaxCrossEntropyCost.prototype.dispose=function(){this.epsilon.dispose()},SoftmaxCrossEntropyCost}(op_1.Operation);exports.SoftmaxCrossEntropyCost=SoftmaxCrossEntropyCost,exports.crossEntropyCost=crossEntropyCost},{"../../math/ndarray":51,"../../util":82,"../graph":8,"./op":25}],29:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),util=require("../../util"),graph_util=require("../graph_util"),Subtract=function(_super){function Subtract(t1,t2,outTensor){var _this=_super.call(this)||this;return _this.t1=t1,_this.t2=t2,_this.outTensor=outTensor,util.assert(1===util.sizeFromShape(t1.shape)||1===util.sizeFromShape(t2.shape)||util.arraysEqual(t1.shape,t2.shape),"One of t1 or t2 must be a scalar, or t1 and t2 must have the same shape"),_this}return __extends(Subtract,_super),Subtract.prototype.feedForward=function(math,inferenceArrays){var _this=this,t1=inferenceArrays.get(this.t1),t2=inferenceArrays.get(this.t2);math.scope(function(keep){var result;result=util.isScalarShape(t1.shape)?math.scalarMinusArray(t1,t2):util.isScalarShape(t2.shape)?math.arrayMinusScalar(t1,t2):math.sub(t1,t2),inferenceArrays.set(_this.outTensor,keep(result))})},Subtract.prototype.backProp=function(math,inferenceArrays,gradientArrays){var _this=this,dy=gradientArrays.get(this.outTensor);math.scope(function(){if(graph_util.shouldBackProp(_this.t1))if(util.isScalarShape(_this.t1.shape)){sum=math.sum(dy);null==_this.dySizeScalar&&(_this.dySizeScalar=ndarray_1.Scalar.new(dy.size)),gradientArrays.add(_this.t1,math.divide(sum,_this.dySizeScalar))}else gradientArrays.add(_this.t1,math.clone(dy));if(graph_util.shouldBackProp(_this.t2))if(util.isScalarShape(_this.t2.shape)){var sum=math.sum(dy),negSum=math.neg(sum);null==_this.dySizeScalar&&(_this.dySizeScalar=ndarray_1.Scalar.new(dy.size)),gradientArrays.add(_this.t2,math.divide(negSum,_this.dySizeScalar))}else gradientArrays.add(_this.t2,math.neg(dy))})},Subtract.prototype.dispose=function(){null!=this.dySizeScalar&&this.dySizeScalar.dispose()},Subtract}(require("./op").Operation);exports.Subtract=Subtract},{"../../math/ndarray":51,"../../util":82,"../graph_util":9,"./op":25}],30:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),tensor_array_map_1=require("../tensor_array_map"),AdadeltaOptimizer=function(_super){function AdadeltaOptimizer(learningRate,gamma,specifiedVariableList){var _this=_super.call(this,learningRate,specifiedVariableList)||this;return _this.learningRate=learningRate,_this.gamma=gamma,_this.accumulatedSquaredGradients=new tensor_array_map_1.TensorArrayMap,_this.accumulatedUpdates=new tensor_array_map_1.TensorArrayMap,_this.eps=ndarray_1.Scalar.new(1e-6),_this.g=ndarray_1.Scalar.new(_this.gamma),_this}return __extends(AdadeltaOptimizer,_super),AdadeltaOptimizer.prototype.beforeBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;_super.prototype.beforeBatch.call(this,math,batchSize,runtime,activationArrayMap,gradientArrayMap),0===this.accumulatedSquaredGradients.size()&&this.variableNodes.forEach(function(node){_this.accumulatedSquaredGradients.set(node.output,ndarray_1.NDArray.zeros(node.output.shape)),_this.accumulatedUpdates.set(node.output,ndarray_1.NDArray.zeros(node.output.shape))})},AdadeltaOptimizer.prototype.afterBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;math.scope(function(keep){_this.variableNodes.forEach(function(node){var oldVariable=activationArrayMap.get(node.output),gradient=_this.variableGradients.get(node.output),oldCache=_this.accumulatedSquaredGradients.get(node.output),oldUpdates=_this.accumulatedUpdates.get(node.output),gradientSquare=math.multiply(gradient,gradient),cache=math.scaledArrayAdd(_this.g,oldCache,math.sub(_this.one,_this.g),gradientSquare),updates=math.multiply(math.divide(math.sqrt(math.add(oldUpdates,_this.eps)),math.sqrt(math.add(oldCache,_this.eps))),gradient),variable=math.scaledArrayAdd(_this.c,updates,_this.one,oldVariable),updateSquare=math.multiply(updates,updates),newUpdates=math.scaledArrayAdd(_this.g,oldUpdates,math.sub(_this.one,_this.g),updateSquare);_this.accumulatedSquaredGradients.set(node.output,keep(cache)),_this.accumulatedUpdates.set(node.output,keep(newUpdates)),activationArrayMap.set(node.output,keep(variable)),node.data=variable,oldVariable.dispose(),oldCache.dispose(),oldUpdates.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},AdadeltaOptimizer.prototype.dispose=function(){_super.prototype.dispose.call(this),this.eps.dispose(),this.g.dispose(),this.accumulatedSquaredGradients.dispose(),this.accumulatedUpdates.dispose()},AdadeltaOptimizer}(require("./optimizer").Optimizer);exports.AdadeltaOptimizer=AdadeltaOptimizer},{"../../math/ndarray":51,"../tensor_array_map":39,"./optimizer":33}],31:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),tensor_array_map_1=require("../tensor_array_map"),AdagradOptimizer=function(_super){function AdagradOptimizer(learningRate,momentum,specifiedVariableList){var _this=_super.call(this,learningRate,specifiedVariableList)||this;return _this.learningRate=learningRate,_this.momentum=momentum,_this.accumulatedSquaredGradients=new tensor_array_map_1.TensorArrayMap,_this.m=ndarray_1.Scalar.new(momentum),_this.eps=ndarray_1.Scalar.new(1e-6),_this}return __extends(AdagradOptimizer,_super),AdagradOptimizer.prototype.beforeBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;_super.prototype.beforeBatch.call(this,math,batchSize,runtime,activationArrayMap,gradientArrayMap),0===this.accumulatedSquaredGradients.size()&&this.variableNodes.forEach(function(node){_this.accumulatedSquaredGradients.set(node.output,ndarray_1.NDArray.zeros(node.output.shape))})},AdagradOptimizer.prototype.afterBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;math.scope(function(keep){_this.variableNodes.forEach(function(node){var oldVariable=activationArrayMap.get(node.output),gradient=_this.variableGradients.get(node.output),oldCache=_this.accumulatedSquaredGradients.get(node.output),gradientSquare=math.multiply(gradient,gradient),cache=math.add(oldCache,gradientSquare),variable=math.scaledArrayAdd(_this.c,math.divide(gradient,math.add(math.sqrt(cache),_this.eps)),_this.one,oldVariable);_this.accumulatedSquaredGradients.set(node.output,keep(cache)),activationArrayMap.set(node.output,keep(variable)),node.data=variable,oldVariable.dispose(),oldCache.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},AdagradOptimizer.prototype.dispose=function(){_super.prototype.dispose.call(this),this.m.dispose(),this.eps.dispose(),this.accumulatedSquaredGradients.dispose()},AdagradOptimizer}(require("./optimizer").Optimizer);exports.AdagradOptimizer=AdagradOptimizer},{"../../math/ndarray":51,"../tensor_array_map":39,"./optimizer":33}],32:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),tensor_array_map_1=require("../tensor_array_map"),MomentumOptimizer=function(_super){function MomentumOptimizer(learningRate,momentum,specifiedVariableList){var _this=_super.call(this,learningRate,specifiedVariableList)||this;return _this.learningRate=learningRate,_this.momentum=momentum,_this.variableVelocities=new tensor_array_map_1.TensorArrayMap,_this.m=ndarray_1.Scalar.new(_this.momentum),_this}return __extends(MomentumOptimizer,_super),MomentumOptimizer.prototype.beforeBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;_super.prototype.beforeBatch.call(this,math,batchSize,runtime,activationArrayMap,gradientArrayMap),0===this.variableVelocities.size()&&this.variableNodes.forEach(function(node){_this.variableVelocities.set(node.output,ndarray_1.NDArray.zeros(node.output.shape))})},MomentumOptimizer.prototype.afterBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;math.scope(function(keep){_this.variableNodes.forEach(function(node){var oldVariable=activationArrayMap.get(node.output),gradient=_this.variableGradients.get(node.output),oldVelocity=_this.variableVelocities.get(node.output),velocity=math.scaledArrayAdd(_this.m,oldVelocity,_this.one,gradient),variable=math.scaledArrayAdd(_this.c,velocity,_this.one,oldVariable);_this.variableVelocities.set(node.output,keep(velocity)),activationArrayMap.set(node.output,keep(variable)),node.data=variable,oldVariable.dispose(),oldVelocity.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},MomentumOptimizer.prototype.dispose=function(){_super.prototype.dispose.call(this),this.m.dispose(),this.variableVelocities.dispose()},MomentumOptimizer.prototype.setMomentum=function(momentum){this.momentum=momentum},MomentumOptimizer}(require("./sgd_optimizer").SGDOptimizer);exports.MomentumOptimizer=MomentumOptimizer},{"../../math/ndarray":51,"../tensor_array_map":39,"./sgd_optimizer":35}],33:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),session_util=require("../session_util"),tensor_array_map_1=require("../tensor_array_map"),Optimizer=function(){function Optimizer(learningRate,specifiedVariableList){this.learningRate=learningRate,this.variableGradients=new tensor_array_map_1.TensorArrayMap,this.one=ndarray_1.Scalar.new(1),null!=specifiedVariableList&&(this.specifiedVariableNodes=specifiedVariableList)}return Optimizer.prototype.beforeBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;this.variableNodes=null==this.specifiedVariableNodes?session_util.getVariableNodesFromEvaluationSet(runtime.nodes):this.specifiedVariableNodes,batchSize!==this.prevBatchSize&&(null!=this.c&&this.c.dispose(),this.prevBatchSize=batchSize,this.c=ndarray_1.Scalar.new(-this.learningRate/batchSize)),this.variableNodes.forEach(function(node){return _this.variableGradients.set(node.output,ndarray_1.NDArray.zeros(node.output.shape))})},Optimizer.prototype.afterExample=function(math,runtime,activationArrayMap,gradientArrayMap){var _this=this;math.scope(function(keep){_this.variableNodes.forEach(function(node){var gradient=gradientArrayMap.get(node.output),accumulatedGradient=_this.variableGradients.get(node.output);_this.variableGradients.set(node.output,keep(math.add(gradient,accumulatedGradient))),accumulatedGradient.dispose()})})},Optimizer.prototype.dispose=function(){null!=this.c&&this.c.dispose(),this.one.dispose()},Optimizer}();exports.Optimizer=Optimizer},{"../../math/ndarray":51,"../session_util":38,"../tensor_array_map":39}],34:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),tensor_array_map_1=require("../tensor_array_map"),RMSPropOptimizer=function(_super){function RMSPropOptimizer(learningRate,gamma,specifiedVariableList){var _this=_super.call(this,learningRate,specifiedVariableList)||this;return _this.learningRate=learningRate,_this.gamma=gamma,_this.accumulatedSquaredGradients=new tensor_array_map_1.TensorArrayMap,_this.eps=ndarray_1.Scalar.new(1e-6),_this.g=ndarray_1.Scalar.new(_this.gamma),_this}return __extends(RMSPropOptimizer,_super),RMSPropOptimizer.prototype.beforeBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;_super.prototype.beforeBatch.call(this,math,batchSize,runtime,activationArrayMap,gradientArrayMap),0===this.accumulatedSquaredGradients.size()&&this.variableNodes.forEach(function(node){_this.accumulatedSquaredGradients.set(node.output,ndarray_1.NDArray.zeros(node.output.shape))})},RMSPropOptimizer.prototype.afterBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;math.scope(function(keep){_this.variableNodes.forEach(function(node){var oldVariable=activationArrayMap.get(node.output),gradient=_this.variableGradients.get(node.output),oldCache=_this.accumulatedSquaredGradients.get(node.output),gradientSquare=math.multiply(gradient,gradient),cache=math.scaledArrayAdd(_this.g,oldCache,math.sub(_this.one,_this.g),gradientSquare),variable=math.scaledArrayAdd(_this.c,math.divide(gradient,math.add(math.sqrt(cache),_this.eps)),_this.one,oldVariable);_this.accumulatedSquaredGradients.set(node.output,keep(cache)),activationArrayMap.set(node.output,keep(variable)),node.data=variable,oldVariable.dispose(),oldCache.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},RMSPropOptimizer.prototype.dispose=function(){_super.prototype.dispose.call(this),this.eps.dispose(),this.g.dispose(),this.accumulatedSquaredGradients.dispose()},RMSPropOptimizer}(require("./optimizer").Optimizer);exports.RMSPropOptimizer=RMSPropOptimizer},{"../../math/ndarray":51,"../tensor_array_map":39,"./optimizer":33}],35:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var tensor_array_map_1=require("../tensor_array_map"),SGDOptimizer=function(_super){function SGDOptimizer(learningRate,specifiedVariableList){var _this=_super.call(this,learningRate,specifiedVariableList)||this;return _this.learningRate=learningRate,_this}return __extends(SGDOptimizer,_super),SGDOptimizer.prototype.afterBatch=function(math,batchSize,runtime,activationArrayMap,gradientArrayMap){var _this=this;math.scope(function(keep){_this.variableNodes.forEach(function(node){var oldVariable=activationArrayMap.get(node.output),gradient=_this.variableGradients.get(node.output),variable=math.scaledArrayAdd(_this.c,gradient,_this.one,oldVariable);activationArrayMap.set(node.output,keep(variable)),node.data=variable,oldVariable.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},SGDOptimizer.prototype.dispose=function(){_super.prototype.dispose.call(this)},SGDOptimizer.prototype.setLearningRate=function(learningRate){this.learningRate=learningRate},SGDOptimizer}(require("./optimizer").Optimizer);exports.SGDOptimizer=SGDOptimizer},{"../tensor_array_map":39,"./optimizer":33}],36:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.defaultCompare=function(a,b){return a===b?0:a<b?-1:1};var PriorityQueue=function(){function PriorityQueue(comparator,indexObserver){this.comparator=comparator,this.indexObserver=indexObserver,this.heap=[]}return PriorityQueue.prototype.enqueue=function(t){this.heap.push(t),this.onIndexChanged(t,this.heap.length-1),this.siftUp(this.heap.length-1)},PriorityQueue.prototype.dequeue=function(){if(this.empty())throw new Error("dequeue called on empty priority queue.");var t=this.heap[0];return this.swap(0,this.heap.length-1),this.heap.pop(),this.siftDown(0),t},PriorityQueue.prototype.update=function(newT,index){var last=index===this.heap.length-1;last||this.swap(index,this.heap.length-1),this.heap.pop(),last||(-1!==this.siftUpIndex(index)?this.siftUp(index):-1!==this.siftDownIndex(index)&&this.siftDown(index)),this.enqueue(newT)},PriorityQueue.prototype.empty=function(){return 0===this.heap.length},PriorityQueue.prototype.onIndexChanged=function(t,newIndex){this.indexObserver&&this.indexObserver(t,newIndex)},PriorityQueue.prototype.getParentIndex=function(index){return 0===index?-1:Math.floor((index-1)/2)},PriorityQueue.prototype.getLeftChildIndex=function(index){var candidate=2*index+1;return candidate<this.heap.length?candidate:-1},PriorityQueue.prototype.getRightChildIndex=function(index){var candidate=2*index+2;return candidate<this.heap.length?candidate:-1},PriorityQueue.prototype.siftUpIndex=function(index){var parentIndex=this.getParentIndex(index);return-1===parentIndex?-1:this.compare(parentIndex,index)>0?parentIndex:-1},PriorityQueue.prototype.siftUp=function(index){for(var siftIndex=this.siftUpIndex(index);-1!==siftIndex;)this.swap(index,siftIndex),index=siftIndex,siftIndex=this.siftUpIndex(index)},PriorityQueue.prototype.siftDownIndex=function(index){if(index>=this.heap.length)return-1;var largestChildIndex=index,leftChildIndex=this.getLeftChildIndex(index);-1!==leftChildIndex&&this.compare(leftChildIndex,largestChildIndex)<0&&(largestChildIndex=leftChildIndex);var rightChildIndex=this.getRightChildIndex(index);return-1!==rightChildIndex&&this.compare(rightChildIndex,largestChildIndex)<0&&(largestChildIndex=rightChildIndex),largestChildIndex===index?-1:largestChildIndex},PriorityQueue.prototype.siftDown=function(index){for(var siftIndex=this.siftDownIndex(index);-1!==siftIndex;)this.swap(index,siftIndex),index=siftIndex,siftIndex=this.siftDownIndex(index)},PriorityQueue.prototype.compare=function(aIndex,bIndex){return this.comparator(this.heap[aIndex],this.heap[bIndex])},PriorityQueue.prototype.swap=function(a,b){var temp=this.heap[a];this.heap[a]=this.heap[b],this.heap[b]=temp,this.onIndexChanged(this.heap[a],a),this.onIndexChanged(this.heap[b],b)},PriorityQueue}();exports.PriorityQueue=PriorityQueue},{}],37:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../math/ndarray"),util=require("../util"),operation_emitter=require("./operation_emitter"),session_util=require("./session_util"),tensor_array_map_1=require("./tensor_array_map"),FeedDictionary=function(){return function(feedEntries){var _this=this;this.dict={},feedEntries&&feedEntries.forEach(function(entry){return _this.dict[entry.tensor.id]=entry})}}();exports.FeedDictionary=FeedDictionary;var CostReduction;!function(CostReduction){CostReduction[CostReduction.NONE=0]="NONE",CostReduction[CostReduction.SUM=1]="SUM",CostReduction[CostReduction.MEAN=2]="MEAN"}(CostReduction=exports.CostReduction||(exports.CostReduction={}));var Session=function(){function Session(graph,math){this.math=math,this.activationArrayMap=new tensor_array_map_1.TensorArrayMap,this.runtimeCache={},this.oneScalar=ndarray_1.Scalar.new(1),this.gradientArrayMap=new tensor_array_map_1.SummedTensorArrayMap(this.math)}return Session.prototype.dispose=function(){var _this=this;this.activationArrayMap.dispose(),Object.keys(this.runtimeCache).forEach(function(key){var runtime=_this.runtimeCache[key];runtime.operations&&runtime.operations.forEach(function(op){return op.dispose()})}),this.runtimeCache={},null!=this.batchSizeScalar&&this.batchSizeScalar.dispose(),this.oneScalar.dispose()},Session.prototype.evalAll=function(tensors,feedEntries){var _this=this;return this.math.scope(function(){var feed=new FeedDictionary(feedEntries),runtime=_this.getOrCreateRuntime(tensors,feed),activations=_this.activationArrayMap;session_util.disposeAndInitializeOperationOutputs(runtime.nodes,activations),session_util.disposeTransientOperationArrays(runtime.operations,_this.activationArrayMap,_this.gradientArrayMap),session_util.addPersistentArraysToTensorArrayMap(runtime.nodes,activations),session_util.loadInputsFromFeedDictionaryToTensorArrayMap(feed,activations,_this.math),runtime.operations.forEach(function(op){return op.feedForward(_this.math,activations)});var results=tensors.map(function(x){return activations.get(x)});return tensors.forEach(function(x){return activations.delete(x)}),session_util.releaseFeedDictionaryInputsFromTensorArrayMap(feed,activations,_this.math),results})},Session.prototype.eval=function(tensor,feedEntries){return this.evalAll([tensor],feedEntries)[0]},Session.prototype.train=function(costTensor,feedEntries,batchSize,optimizer,costReduction){var _this=this;void 0===costReduction&&(costReduction=CostReduction.NONE),util.assert(util.isScalarShape(costTensor.shape),"Cost tensor for training must be a scalar value."),this.prevBatchSize!==batchSize&&(this.prevBatchSize=batchSize,this.batchSizeScalar=ndarray_1.Scalar.new(batchSize));var feed=new FeedDictionary(feedEntries);session_util.throwIfFeedDictionaryContainsNDArrays(feed);var runtime=this.getOrCreateRuntime([costTensor],feed),inferenceOperations=runtime.operations,backPropOperations=runtime.operations.slice().reverse(),activations=this.activationArrayMap,gradients=this.gradientArrayMap;return gradients.nullify(costTensor),gradients.add(costTensor,this.oneScalar),session_util.addPersistentArraysToTensorArrayMap(runtime.nodes,activations),optimizer.beforeBatch(this.math,batchSize,runtime,activations,gradients),this.math.scope(function(keep,track){for(var cost=track(ndarray_1.Scalar.new(0)),i=0;i<batchSize;++i)session_util.disposeAndInitializeOperationOutputs(runtime.nodes,activations),session_util.disposeAndInitializeOperationInputGradients(runtime.nodes,gradients),session_util.disposeTransientOperationArrays(runtime.operations,activations,gradients),session_util.loadInputsFromFeedDictionaryToTensorArrayMap(feed,activations,_this.math),inferenceOperations.forEach(function(op){return op.feedForward(_this.math,activations)}),backPropOperations.forEach(function(op){return op.backProp(_this.math,activations,gradients)}),optimizer.afterExample(_this.math,runtime,activations,gradients),session_util.releaseFeedDictionaryInputsFromTensorArrayMap(feed,activations,_this.math),cost=_this.updateCostForExample(cost,activations.get(costTensor),costReduction);return optimizer.afterBatch(_this.math,batchSize,runtime,activations,gradients),_this.updateCostForBatch(cost,costReduction)})},Session.prototype.updateCostForExample=function(totalCost,currCost,costReduction){return costReduction===CostReduction.MEAN||costReduction===CostReduction.SUM?this.math.add(totalCost,currCost):totalCost},Session.prototype.updateCostForBatch=function(totalCost,costReduction){return costReduction===CostReduction.MEAN?this.math.divide(totalCost,this.batchSizeScalar):totalCost},Session.prototype.getOrCreateRuntime=function(tensors,feed){var key=this.makeRuntimeCacheKey(tensors,feed),runtime=this.runtimeCache[key];if(void 0===runtime){var nodes=session_util.getOrderedEvaluationSetFromEvalTensor(tensors,feed);session_util.removeFeedDictionaryNodesFromEvaluationSet(feed,nodes),session_util.throwErrorIfEvaluationSetContainsPlaceholderNodes(nodes),runtime={nodes:nodes,operations:operation_emitter.emitFromGraphNodes(nodes)},this.runtimeCache[key]=runtime}return runtime},Session.prototype.makeRuntimeCacheKey=function(tensors,feed){return tensors.map(function(x){return x.id}).sort().join("_")+"__"+Object.keys(feed.dict).sort().join("_")},Session}();exports.Session=Session},{"../math/ndarray":51,"../util":82,"./operation_emitter":10,"./session_util":38,"./tensor_array_map":39}],38:[function(require,module,exports){"use strict";function getTerminatingNodesFromFeedDictionary(feedDictionary){return Object.keys(feedDictionary.dict).map(function(tensorID){return feedDictionary.dict[+tensorID].tensor.node})}Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../math/ndarray"),util=require("../util"),graph_1=require("./graph"),graph_util=require("./graph_util");exports.getTerminatingNodesFromFeedDictionary=getTerminatingNodesFromFeedDictionary,exports.getOrderedEvaluationSetFromEvalTensor=function(evalTensors,feedDictionary){var terminatingNodes=getTerminatingNodesFromFeedDictionary(feedDictionary),evalNodes=evalTensors.map(function(x){return x.node}),unorderedEvaluationSet=graph_util.getUnorderedEvaluationSet(evalNodes,terminatingNodes);return graph_util.getOrderedEvaluationSet(unorderedEvaluationSet)},exports.addPersistentArraysToTensorArrayMap=function(evaluationSet,tensorArrayMap){evaluationSet.forEach(function(node){(node instanceof graph_1.VariableNode||node instanceof graph_1.ConstantNode)&&tensorArrayMap.set(node.output,node.data)})},exports.getVariableNodesFromEvaluationSet=function(evaluationSet){var nodes=[];return evaluationSet.forEach(function(node){node instanceof graph_1.VariableNode&&nodes.push(node)}),nodes},exports.throwIfFeedDictionaryContainsNDArrays=function(feedDictionary){Object.keys(feedDictionary.dict).forEach(function(tensorID){if(feedDictionary.dict[+tensorID].data instanceof ndarray_1.NDArray)throw new Error("training requires FeedDictionary entries to be InputProvidersand not NDArrays.")})},exports.loadInputsFromFeedDictionaryToTensorArrayMap=function(batchFeed,activations,math){Object.keys(batchFeed.dict).forEach(function(tensorID){var data,feedEntry=batchFeed.dict[+tensorID];data=feedEntry.data instanceof ndarray_1.NDArray?feedEntry.data:feedEntry.data.getNextCopy(math),util.assert(util.arraysEqual(feedEntry.tensor.shape,data.shape),"Error loading FeedEntry: feeding NDArray of shape "+data.shape+" does not match Tensor (id: "+feedEntry.tensor.id+") shape: "+feedEntry.tensor.shape+"."),activations.set(feedEntry.tensor,data)})},exports.releaseFeedDictionaryInputsFromTensorArrayMap=function(batchFeed,activations,math){Object.keys(batchFeed.dict).forEach(function(tensorID){var feedEntry=batchFeed.dict[+tensorID];if(!(feedEntry.data instanceof ndarray_1.NDArray)){var provider=feedEntry.data,feedEntryArray=activations.get(feedEntry.tensor);provider.disposeCopy(math,feedEntryArray)}activations.delete(feedEntry.tensor)})},exports.removeFeedDictionaryNodesFromEvaluationSet=function(feedDictionary,evaluationSet){for(var i=0;i<evaluationSet.length;){var node=evaluationSet[i];null!=feedDictionary.dict[node.output.id]?evaluationSet.splice(i,1):++i}},exports.disposeAndInitializeOperationOutputs=function(evaluationSet,tensorArrayMap){evaluationSet.forEach(function(node){graph_util.isInputNode(node)||(graph_util.isPassthroughNode(node,tensorArrayMap)||tensorArrayMap.disposeArray(node.output),tensorArrayMap.set(node.output,null))})},exports.disposeAndInitializeOperationInputGradients=function(evaluationSet,gradients){evaluationSet.forEach(function(node){Object.keys(node.inputs).forEach(function(inputName){var input=node.inputs[inputName];gradients.get(input,!0)!==gradients.get(node.output,!0)&&gradients.disposeArray(input),gradients.nullify(input)})})},exports.disposeTransientOperationArrays=function(operations,activations,gradients){operations.forEach(function(op){return op.disposeTransientArrays(activations,gradients)})},exports.throwErrorIfEvaluationSetContainsPlaceholderNodes=function(evaluationSet){evaluationSet.forEach(function(node){if(node instanceof graph_1.PlaceholderNode){var shape="["+node.output.shape.join(", ")+"]";throw new Error('Placeholder node "'+node.name+'" '+shape+" not present in feed dictionary.")}})}},{"../math/ndarray":51,"../util":82,"./graph":8,"./graph_util":9}],39:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var TensorArrayMapBase=function(){function TensorArrayMapBase(){this.dict={}}return TensorArrayMapBase.prototype.get=function(tensor,skipChecks){if(void 0===skipChecks&&(skipChecks=!1),!skipChecks&&void 0===this.dict[tensor.id])throw new Error("tensor "+tensor.id+" not in array map.");var nda=this.dict[tensor.id];if(!skipChecks&&null===nda)throw new Error("tensor "+tensor.id+" has null array.");return nda},TensorArrayMapBase.prototype.delete=function(tensor){delete this.dict[tensor.id]},TensorArrayMapBase.prototype.nullify=function(tensor){this.dict[tensor.id]=null},TensorArrayMapBase.prototype.disposeArray=function(tensor){if(void 0!==this.dict[tensor.id]){var nda=this.dict[tensor.id];null!==nda&&(nda.dispose(),this.dict[tensor.id]=null)}},TensorArrayMapBase.prototype.size=function(){return Object.keys(this.dict).length},TensorArrayMapBase.prototype.dispose=function(){var _this=this;Object.keys(this.dict).forEach(function(tensorID){var nda=_this.dict[+tensorID];nda&&nda.dispose()}),this.dict={}},TensorArrayMapBase.prototype.hasNullArray=function(tensor){if(void 0===this.dict[tensor.id])throw new Error("tensor "+tensor.id+" not in array map.");return null===this.dict[tensor.id]},TensorArrayMapBase}();exports.TensorArrayMapBase=TensorArrayMapBase;var TensorArrayMap=function(_super){function TensorArrayMap(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(TensorArrayMap,_super),TensorArrayMap.prototype.set=function(tensor,array){this.dict[tensor.id]=array},TensorArrayMap}(TensorArrayMapBase);exports.TensorArrayMap=TensorArrayMap;var SummedTensorArrayMap=function(_super){function SummedTensorArrayMap(math){var _this=_super.call(this)||this;return _this.math=math,_this}return __extends(SummedTensorArrayMap,_super),SummedTensorArrayMap.prototype.add=function(tensor,array){if(null==this.dict[tensor.id])this.dict[tensor.id]=this.math.keep(array);else{var oldValue=this.get(tensor),newValue=this.math.keep(this.math.addStrict(oldValue,array));this.dict[tensor.id]=newValue,oldValue.dispose()}},SummedTensorArrayMap}(TensorArrayMapBase);exports.SummedTensorArrayMap=SummedTensorArrayMap},{}],40:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MetricReduction,session_1=require("./graph/session"),ndarray_1=require("./math/ndarray");!function(MetricReduction){MetricReduction[MetricReduction.SUM=0]="SUM",MetricReduction[MetricReduction.MEAN=1]="MEAN"}(MetricReduction=exports.MetricReduction||(exports.MetricReduction={}));var GraphRunner=function(){function GraphRunner(math,session,eventObserver){this.math=math,this.session=session,this.eventObserver=eventObserver,this.lastCostTimestamp=0,this.lastEvalTimestamp=0,this.totalIdleTimeMs=0,this.resetStatistics(),this.zeroScalar=ndarray_1.Scalar.new(0)}return GraphRunner.prototype.resetStatistics=function(){this.totalBatchesTrained=0,this.totalIdleTimeMs=0,this.lastStopTimestamp=null},GraphRunner.prototype.train=function(costTensor,trainFeedEntries,batchSize,optimizer,numBatches,metricTensor,metricFeedEntries,metricBatchSize,metricReduction,evalIntervalMs,costIntervalMs){void 0===metricReduction&&(metricReduction=MetricReduction.MEAN),void 0===evalIntervalMs&&(evalIntervalMs=1500),void 0===costIntervalMs&&(costIntervalMs=500),this.costTensor=costTensor,this.trainFeedEntries=trainFeedEntries,this.metricTensor=metricTensor,this.metricFeedEntries=metricFeedEntries,null!=metricBatchSize&&this.metricBatchSize!==metricBatchSize&&(null!=this.metricBatchSizeScalar&&this.metricBatchSizeScalar.dispose(),this.metricBatchSizeScalar=ndarray_1.Scalar.new(metricBatchSize)),this.metricBatchSize=metricBatchSize,this.metricReduction=metricReduction,this.batchSize=batchSize,this.optimizer=optimizer,this.metricIntervalMs=evalIntervalMs,this.costIntervalMs=costIntervalMs,this.currentTrainLoopNumBatches=numBatches,this.batchesTrainedThisRun=0,this.isTraining=!0,this.trainStartTimestamp=performance.now(),this.trainNetwork()},GraphRunner.prototype.stopTraining=function(){this.isTraining=!1,this.lastStopTimestamp=performance.now()},GraphRunner.prototype.resumeTraining=function(){this.isTraining=!0,null!=this.lastStopTimestamp&&(this.totalIdleTimeMs+=performance.now()-this.lastStopTimestamp),this.trainNetwork()},GraphRunner.prototype.trainNetwork=function(){var _this=this;if(this.batchesTrainedThisRun===this.currentTrainLoopNumBatches&&this.stopTraining(),this.isTraining){var start=performance.now(),shouldComputeCost=null!=this.eventObserver.avgCostCallback&&start-this.lastCostTimestamp>this.costIntervalMs;shouldComputeCost&&(this.lastCostTimestamp=start);var costReduction=shouldComputeCost?session_1.CostReduction.MEAN:session_1.CostReduction.NONE;this.math.scope(function(keep){var avgCost=_this.session.train(_this.costTensor,_this.trainFeedEntries,_this.batchSize,_this.optimizer,costReduction);if(shouldComputeCost){var trainTime=performance.now()-start;if(_this.eventObserver.avgCostCallback(avgCost),null!=_this.eventObserver.trainExamplesPerSecCallback){var examplesPerSec=1e3*_this.batchSize/trainTime;_this.eventObserver.trainExamplesPerSecCallback(examplesPerSec)}}null!=_this.eventObserver.metricCallback&&null!=_this.metricFeedEntries&&start-_this.lastEvalTimestamp>_this.metricIntervalMs&&(_this.lastEvalTimestamp=start,null!=_this.lastComputedMetric&&_this.lastComputedMetric.dispose(),_this.lastComputedMetric=_this.computeMetric(),_this.eventObserver.metricCallback(_this.lastComputedMetric)),null!=_this.eventObserver.totalTimeCallback&&_this.eventObserver.totalTimeCallback((start-_this.trainStartTimestamp)/1e3),_this.batchesTrainedThisRun++,_this.totalBatchesTrained++,null!=_this.eventObserver.batchesTrainedCallback&&_this.eventObserver.batchesTrainedCallback(_this.totalBatchesTrained)}),requestAnimationFrame(function(){return _this.trainNetwork()})}else null!=this.eventObserver.doneTrainingCallback&&this.eventObserver.doneTrainingCallback()},GraphRunner.prototype.infer=function(inferenceTensor,inferenceFeedEntries,inferenceExampleIntervalMs,inferenceExampleCount,numPasses){var _this=this;if(void 0===inferenceExampleIntervalMs&&(inferenceExampleIntervalMs=3e3),void 0===inferenceExampleCount&&(inferenceExampleCount=5),null==this.eventObserver.inferenceExamplesCallback&&null==this.eventObserver.inferenceExamplesPerSecCallback)throw new Error("Cannot start inference loop, no inference example or examples/sec observer provided.");for(var i=0;i<inferenceFeedEntries.length;i++)if(inferenceFeedEntries[i].data instanceof ndarray_1.NDArray)throw new Error("Cannot start inference on the model runner with feed entries of type NDArray. Please use InputProviders.");this.inferenceExampleIntervalMs=inferenceExampleIntervalMs,this.inferenceTensor=inferenceTensor,this.inferenceFeedEntries=inferenceFeedEntries,this.inferenceExampleCount=inferenceExampleCount,this.currentInferenceLoopNumPasses=numPasses,this.isInferring||(this.inferencePassesThisRun=0,requestAnimationFrame(function(){return _this.inferNetwork()})),this.isInferring=!0},GraphRunner.prototype.inferNetwork=function(){var _this=this;this.isInferring&&this.inferencePassesThisRun!==this.currentInferenceLoopNumPasses&&(this.math.scope(function(keep,track){for(var feeds=[],inferenceValues=[],start=performance.now(),i=0;i<_this.inferenceExampleCount;i++){for(var ndarrayFeedEntries=[],j=0;j<_this.inferenceFeedEntries.length;j++){var feedEntry=_this.inferenceFeedEntries[j];ndarrayFeedEntries.push({tensor:feedEntry.tensor,data:track(feedEntry.data.getNextCopy(_this.math))})}feeds.push(ndarrayFeedEntries),inferenceValues.push(_this.session.eval(_this.inferenceTensor,ndarrayFeedEntries))}if(null!=_this.eventObserver.inferenceExamplesPerSecCallback){inferenceValues[inferenceValues.length-1].getValues();var inferenceExamplesPerSecTime=performance.now()-start,examplesPerSec=1e3*_this.inferenceExampleCount/inferenceExamplesPerSecTime;_this.eventObserver.inferenceExamplesPerSecCallback(examplesPerSec)}null!=_this.eventObserver.inferenceExamplesCallback&&_this.eventObserver.inferenceExamplesCallback(feeds,inferenceValues),_this.inferencePassesThisRun++}),this.lastInferTimeoutID=window.setTimeout(function(){return _this.inferNetwork()},this.inferenceExampleIntervalMs))},GraphRunner.prototype.stopInferring=function(){this.isInferring=!1,window.clearTimeout(this.lastInferTimeoutID)},GraphRunner.prototype.isInferenceRunning=function(){return this.isInferring},GraphRunner.prototype.computeMetric=function(){var _this=this;if(null==this.metricFeedEntries)throw new Error("Cannot compute metric, no metric FeedEntries provided.");var metric=this.zeroScalar;return this.math.scope(function(keep){for(var i=0;i<_this.metricBatchSize;i++){var metricValue=_this.session.eval(_this.metricTensor,_this.metricFeedEntries);metric=_this.math.add(metric,metricValue)}return _this.metricReduction===MetricReduction.MEAN&&(metric=_this.math.divide(metric,_this.metricBatchSizeScalar)),metric})},GraphRunner.prototype.getTotalBatchesTrained=function(){return this.totalBatchesTrained},GraphRunner.prototype.getLastComputedMetric=function(){return this.lastComputedMetric},GraphRunner.prototype.setMath=function(math){this.math=math},GraphRunner.prototype.setSession=function(session){this.session=session},GraphRunner.prototype.setInferenceTensor=function(inferenceTensor){this.inferenceTensor=inferenceTensor},GraphRunner.prototype.setInferenceExampleCount=function(inferenceExampleCount){this.inferenceExampleCount=inferenceExampleCount},GraphRunner}();exports.GraphRunner=GraphRunner},{"./graph/session":37,"./math/ndarray":51}],41:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var xhr_dataset=require("./data/xhr-dataset");exports.xhr_dataset=xhr_dataset;var conv_util=require("./math/conv_util");exports.conv_util=conv_util;var gpgpu_util=require("./math/webgl/gpgpu_util");exports.gpgpu_util=gpgpu_util;var render_ndarray_gpu_util=require("./math/webgl/render_ndarray_gpu_util");exports.render_ndarray_gpu_util=render_ndarray_gpu_util;var webgl_util=require("./math/webgl/webgl_util");exports.webgl_util=webgl_util;var test_util=require("./test_util");exports.test_util=test_util;var util=require("./util");exports.util=util;var checkpoint_loader_1=require("./data/checkpoint_loader");exports.CheckpointLoader=checkpoint_loader_1.CheckpointLoader;var dataset_1=require("./data/dataset");exports.InMemoryDataset=dataset_1.InMemoryDataset;var input_provider_1=require("./data/input_provider");exports.InCPUMemoryShuffledInputProviderBuilder=input_provider_1.InCPUMemoryShuffledInputProviderBuilder,exports.InGPUMemoryShuffledInputProviderBuilder=input_provider_1.InGPUMemoryShuffledInputProviderBuilder;var xhr_dataset_1=require("./data/xhr-dataset");exports.XhrDataset=xhr_dataset_1.XhrDataset;var environment_1=require("./environment");exports.ENV=environment_1.ENV;var graph_1=require("./graph/graph");exports.Graph=graph_1.Graph,exports.Tensor=graph_1.Tensor;var adadelta_optimizer_1=require("./graph/optimizers/adadelta_optimizer");exports.AdadeltaOptimizer=adadelta_optimizer_1.AdadeltaOptimizer;var adagrad_optimizer_1=require("./graph/optimizers/adagrad_optimizer");exports.AdagradOptimizer=adagrad_optimizer_1.AdagradOptimizer;var momentum_optimizer_1=require("./graph/optimizers/momentum_optimizer");exports.MomentumOptimizer=momentum_optimizer_1.MomentumOptimizer;var optimizer_1=require("./graph/optimizers/optimizer");exports.Optimizer=optimizer_1.Optimizer;var rmsprop_optimizer_1=require("./graph/optimizers/rmsprop_optimizer");exports.RMSPropOptimizer=rmsprop_optimizer_1.RMSPropOptimizer;var sgd_optimizer_1=require("./graph/optimizers/sgd_optimizer");exports.SGDOptimizer=sgd_optimizer_1.SGDOptimizer;var session_1=require("./graph/session");exports.CostReduction=session_1.CostReduction,exports.Session=session_1.Session;var graph_runner_1=require("./graph_runner");exports.GraphRunner=graph_runner_1.GraphRunner,exports.MetricReduction=graph_runner_1.MetricReduction;var initializers_1=require("./initializers");exports.ConstantInitializer=initializers_1.ConstantInitializer,exports.NDArrayInitializer=initializers_1.NDArrayInitializer,exports.OnesInitializer=initializers_1.OnesInitializer,exports.RandomNormalInitializer=initializers_1.RandomNormalInitializer,exports.RandomTruncatedNormalInitializer=initializers_1.RandomTruncatedNormalInitializer,exports.RandomUniformInitializer=initializers_1.RandomUniformInitializer,exports.VarianceScalingInitializer=initializers_1.VarianceScalingInitializer,exports.ZerosInitializer=initializers_1.ZerosInitializer;var math_1=require("./math/math");exports.MatrixOrientation=math_1.MatrixOrientation,exports.NDArrayMath=math_1.NDArrayMath;var math_cpu_1=require("./math/math_cpu");exports.NDArrayMathCPU=math_cpu_1.NDArrayMathCPU;var math_gpu_1=require("./math/math_gpu");exports.NDArrayMathGPU=math_gpu_1.NDArrayMathGPU;var ndarray_1=require("./math/ndarray");exports.Array1D=ndarray_1.Array1D,exports.Array2D=ndarray_1.Array2D,exports.Array3D=ndarray_1.Array3D,exports.Array4D=ndarray_1.Array4D,exports.NDArray=ndarray_1.NDArray,exports.Scalar=ndarray_1.Scalar;var gpgpu_context_1=require("./math/webgl/gpgpu_context");exports.GPGPUContext=gpgpu_context_1.GPGPUContext},{"./data/checkpoint_loader":2,"./data/dataset":3,"./data/input_provider":4,"./data/xhr-dataset":5,"./environment":7,"./graph/graph":8,"./graph/optimizers/adadelta_optimizer":30,"./graph/optimizers/adagrad_optimizer":31,"./graph/optimizers/momentum_optimizer":32,"./graph/optimizers/optimizer":33,"./graph/optimizers/rmsprop_optimizer":34,"./graph/optimizers/sgd_optimizer":35,"./graph/session":37,"./graph_runner":40,"./initializers":42,"./math/conv_util":45,"./math/math":48,"./math/math_cpu":49,"./math/math_gpu":50,"./math/ndarray":51,"./math/webgl/gpgpu_context":62,"./math/webgl/gpgpu_util":64,"./math/webgl/render_ndarray_gpu_util":73,"./math/webgl/webgl_util":80,"./test_util":81,"./util":82}],42:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("./math/ndarray"),VarianceScalingInitializer=function(){function VarianceScalingInitializer(scale,mode,distribution){void 0===scale&&(scale=1),void 0===mode&&(mode="fan_in"),void 0===distribution&&(distribution="normal"),this.scale=scale,this.mode=mode,this.distribution=distribution}return VarianceScalingInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){var n=0;if("fan_in"===this.mode)n=inputUnits;else if("fan_out"===this.mode)n=outputUnits;else{if("fan_avg"!==this.mode)throw new Error("Unexpected mode for variance scaling initializer: "+this.mode);n=(inputUnits+outputUnits)/2}if("normal"===this.distribution)return ndarray_1.NDArray.randTruncatedNormal(weightsShape,0,Math.sqrt(this.scale/n));if("uniform"===this.distribution)return ndarray_1.NDArray.randUniform(weightsShape,0,Math.sqrt(3*this.scale/n));throw new Error("Unexpected distribution for variance scaling initializer: "+this.distribution)},VarianceScalingInitializer}();exports.VarianceScalingInitializer=VarianceScalingInitializer;var ZerosInitializer=function(){function ZerosInitializer(){}return ZerosInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){return ndarray_1.NDArray.zeros(weightsShape)},ZerosInitializer}();exports.ZerosInitializer=ZerosInitializer;var OnesInitializer=function(){function OnesInitializer(){}return OnesInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){var values=ndarray_1.NDArray.zeros(weightsShape);return values.fill(1),values},OnesInitializer}();exports.OnesInitializer=OnesInitializer;var ConstantInitializer=function(){function ConstantInitializer(value){void 0===value&&(value=0),this.value=value}return ConstantInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){var values=ndarray_1.NDArray.zeros(weightsShape);return values.fill(this.value),values},ConstantInitializer}();exports.ConstantInitializer=ConstantInitializer;var NDArrayInitializer=function(){function NDArrayInitializer(ndarray){this.ndarray=ndarray}return NDArrayInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){return this.ndarray},NDArrayInitializer}();exports.NDArrayInitializer=NDArrayInitializer;var RandomNormalInitializer=function(){function RandomNormalInitializer(mean,stdev){void 0===mean&&(mean=0),void 0===stdev&&(stdev=.05),this.mean=mean,this.stdev=stdev}return RandomNormalInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){return ndarray_1.NDArray.randNormal(weightsShape,this.mean,this.stdev)},RandomNormalInitializer}();exports.RandomNormalInitializer=RandomNormalInitializer;var RandomTruncatedNormalInitializer=function(){function RandomTruncatedNormalInitializer(mean,stdev){void 0===mean&&(mean=0),void 0===stdev&&(stdev=.05),this.mean=mean,this.stdev=stdev}return RandomTruncatedNormalInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){return ndarray_1.NDArray.randTruncatedNormal(weightsShape,this.mean,this.stdev)},RandomTruncatedNormalInitializer}();exports.RandomTruncatedNormalInitializer=RandomTruncatedNormalInitializer;var RandomUniformInitializer=function(){function RandomUniformInitializer(minval,maxval){void 0===minval&&(minval=-.05),void 0===maxval&&(maxval=.05),this.minval=minval,this.maxval=maxval}return RandomUniformInitializer.prototype.initialize=function(weightsShape,inputUnits,outputUnits){return ndarray_1.NDArray.randUniform(weightsShape,this.minval,this.maxval)},RandomUniformInitializer}();exports.RandomUniformInitializer=RandomUniformInitializer},{"./math/ndarray":51}],43:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("./ndarray"),TanHFunc=function(){function TanHFunc(){}return TanHFunc.prototype.output=function(math,x){return math.scope(function(){return math.tanh(x)})},TanHFunc.prototype.der=function(math,x,y){return math.scope(function(){var ySquared=math.elementWiseMul(y,y);return math.scalarMinusArray(ndarray_1.Scalar.ONE,ySquared)})},TanHFunc}();exports.TanHFunc=TanHFunc;var ReLUFunc=function(){function ReLUFunc(){}return ReLUFunc.prototype.output=function(math,x){return math.scope(function(){return math.relu(x)})},ReLUFunc.prototype.der=function(math,x,y){return math.scope(function(){return math.step(x)})},ReLUFunc}();exports.ReLUFunc=ReLUFunc;var SigmoidFunc=function(){function SigmoidFunc(){}return SigmoidFunc.prototype.output=function(math,x){return math.scope(function(){return math.sigmoid(x)})},SigmoidFunc.prototype.der=function(math,x,y){return math.scope(function(){var ySquared=math.elementWiseMul(y,y);return math.subStrict(y,ySquared)})},SigmoidFunc}();exports.SigmoidFunc=SigmoidFunc;var SquareFunc=function(){function SquareFunc(){}return SquareFunc.prototype.output=function(math,x){return math.scope(function(){return math.elementWiseMul(x,x)})},SquareFunc.prototype.der=function(math,x,y){return math.scope(function(){return math.scalarTimesArray(ndarray_1.Scalar.TWO,x)})},SquareFunc}();exports.SquareFunc=SquareFunc},{"./ndarray":51}],44:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.assertParams=function(aShape,bShape,axis){var aRank=aShape.length,bRank=bShape.length;util.assert(aShape.length===bShape.length,"Error in concat"+aRank+"D: rank of x1 ("+aRank+") and x2 ("+bRank+") must be the same."),util.assert(axis>=0&&axis<aRank,"Error in concat"+aRank+"D: axis must be between 0 and "+(aRank-1)+".");for(var i=0;i<aRank;i++)util.assert(i===axis||aShape[i]===bShape[i],"Error in concat"+aRank+"D: Shape ("+aShape+") does not match ("+bShape+") along the non-concatenated axis "+i+".")},exports.computeOutShape=function(x1Shape,x2Shape,axis){util.assert(x1Shape.length===x2Shape.length,"x1 and x2 should have the same rank.");var outputShape=x1Shape.slice();return outputShape[axis]+=x2Shape[axis],outputShape}},{"../util":82}],45:[function(require,module,exports){"use strict";function computeOutputShape3D(inShape,fieldSize,outDepth,stride,zeroPad){null==zeroPad&&(zeroPad=computeDefaultPad(inShape,fieldSize,stride));var inputRows=inShape[0],inputCols=inShape[1],outputRows=(inputRows-fieldSize+2*zeroPad)/stride+1;util.assert(util.isInt(outputRows),"The output # of rows ("+outputRows+") must be an integer. Change the stride and/or zero pad parameters");var outputCols=(inputCols-fieldSize+2*zeroPad)/stride+1;return util.assert(util.isInt(outputCols),"The output # of columns ("+outputCols+") must be an integer. Change the stride and/or zero pad parameters"),[outputRows,outputCols,outDepth]}function computeDefaultPad(inputShape,fieldSize,stride){return Math.floor((inputShape[0]*(stride-1)-stride+fieldSize)/2)}Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.computeConvInfo=function(inShape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad){if("number"==typeof pad)return{inShape:inShape,outShape:computeOutputShape3D(inShape,filterHeight,outDepth,strideHeight,pad),padInfo:{top:pad,bottom:pad,left:pad,right:pad},strideHeight:strideHeight,strideWidth:strideWidth,filterHeight:filterHeight,filterWidth:filterWidth};var outShape,padInfo,inHeight=inShape[0],inWidth=inShape[1];if("same"===pad){outShape=[outHeight=Math.ceil(inHeight/strideHeight),outWidth=Math.ceil(inWidth/strideWidth),outDepth];var padAlongHeight=(outHeight-1)*strideHeight+filterHeight-inHeight,padAlongWidth=(outWidth-1)*strideWidth+filterWidth-inWidth,top_1=Math.floor(padAlongHeight/2),bottom=padAlongHeight-top_1,left=Math.floor(padAlongWidth/2);padInfo={top:top_1,bottom:bottom,left:left,right:padAlongWidth-left}}else{if("valid"!==pad)throw Error("Unknown padding parameter: "+pad);var outHeight=Math.ceil((inHeight-filterHeight+1)/strideHeight),outWidth=Math.ceil((inWidth-filterWidth+1)/strideWidth);outShape=[outHeight,outWidth,outDepth],padInfo={top:0,bottom:0,left:0,right:0}}return{inShape:inShape,outShape:outShape,padInfo:padInfo,strideHeight:strideHeight,strideWidth:strideWidth,filterHeight:filterHeight,filterWidth:filterWidth}},exports.computeOutputShape3D=computeOutputShape3D,exports.computeDefaultPad=computeDefaultPad,exports.computeTexShapeFrom3D=function(shapeRowColDepth){return[shapeRowColDepth[0],shapeRowColDepth[1]*shapeRowColDepth[2]]},exports.computeWeightsShape4D=function(inputDepth,outputDepth,filterHeight,filterWidth){return[filterHeight,filterWidth,inputDepth,outputDepth]},exports.computeDilatedRC=function(rc,origStride){return[(rc[0]-1)*origStride+1,(rc[1]-1)*origStride+1]}},{"../util":82}],46:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateShapes=function(sourceSize,destSize){var srcArea=sourceSize[0]*sourceSize[1],dstArea=destSize[0]*destSize[1];if(srcArea!==dstArea){var srcStr="["+sourceSize[0]+", "+sourceSize[1]+"]",dstStr="["+destSize[0]+", "+destSize[1]+"]";throw new Error("copy2D shapes have different areas:\n  sourceSize "+srcStr+", area "+srcArea+"\n  destSize "+dstStr+", area "+dstArea)}}},{}],47:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("./ndarray"),SquareCostFunc=function(){function SquareCostFunc(){this.halfOne=ndarray_1.Scalar.new(.5)}return SquareCostFunc.prototype.cost=function(math,x1,x2){var diff=math.subStrict(x1,x2),diffSquared=math.elementWiseMul(diff,diff),result=math.scalarTimesArray(this.halfOne,diffSquared);return diff.dispose(),diffSquared.dispose(),result},SquareCostFunc.prototype.der=function(math,x1,x2){return math.subStrict(x1,x2)},SquareCostFunc.prototype.dispose=function(){this.halfOne.dispose()},SquareCostFunc}();exports.SquareCostFunc=SquareCostFunc},{"./ndarray":51}],48:[function(require,module,exports){"use strict";function parseTupleParam(param){return"number"==typeof param?[param,param]:param}Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util"),concat_util=require("./concat_util"),conv_util=require("./conv_util"),copy2d_util=require("./copy2d_util"),ndarray_1=require("./ndarray"),slice_util=require("./slice_util"),NDArrayMath=function(){function NDArrayMath(safeMode){this.safeMode=safeMode,this.ndarrayScopes=[],this.ndarraysToKeep=[],this.activeScopeNDArraysToKeep=[],this.debugMode=!1}return NDArrayMath.prototype.scope=function(scopeFn){var _this=this;this.startScope();var result=scopeFn(function(ndarray){return _this.keep(ndarray)},function(ndarray){return _this.track(ndarray)});return this.endScope(result),result},NDArrayMath.prototype.enableDebugMode=function(){this.debugMode=!0,console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")},NDArrayMath.prototype.startScope=function(){var newScope=[];this.ndarrayScopes.push(newScope),this.activeScope=newScope;var newNDArraysToKeep=[];this.ndarraysToKeep.push(newNDArraysToKeep),this.activeScopeNDArraysToKeep=newNDArraysToKeep},NDArrayMath.prototype.endScope=function(result){var _this=this,arraysToKeep=this.activeScopeNDArraysToKeep;null!=result&&(arraysToKeep=arraysToKeep.concat(result));for(var i=0;i<this.activeScope.length;i++){var ndarray=this.activeScope[i];this.isNDArrayDataInList(ndarray,arraysToKeep)||ndarray.dispose()}this.ndarrayScopes.pop(),this.activeScope=0===this.ndarrayScopes.length?null:this.ndarrayScopes[this.ndarrayScopes.length-1],result instanceof ndarray_1.NDArray&&!this.isNDArrayDataInList(result,this.activeScopeNDArraysToKeep)?this.track(result):Array.isArray(result)&&result.forEach(function(r){r instanceof ndarray_1.NDArray&&!_this.isNDArrayDataInList(r,_this.activeScopeNDArraysToKeep)&&_this.track(r)}),this.ndarraysToKeep.pop(),this.activeScopeNDArraysToKeep=0===this.ndarraysToKeep.length?null:this.ndarraysToKeep[this.ndarraysToKeep.length-1]},NDArrayMath.prototype.isNDArrayDataInList=function(ndarray,ndarrayList){for(var i=0;i<ndarrayList.length;i++)if(ndarrayList[i].getData()===ndarray.getData())return!0;return!1},NDArrayMath.prototype.keep=function(result){if(null==this.activeScope){if(this.safeMode)throw new Error("You are using math in safe mode. Enclose all math.method() calls inside a scope: math.scope(() => {math.method();...}) to avoid memory leaks.");return result}return this.activeScopeNDArraysToKeep.push(result),result},NDArrayMath.prototype.checkForNaN=function(vals,name){for(var i=0;i<vals.length;i++)if(isNaN(vals[i]))throw Error("The result of the last math."+name+" has NaNs.")},NDArrayMath.prototype.track=function(result){if(null==this.activeScope){if(this.safeMode)throw new Error("You are using math in safe mode. Enclose all math.method() calls inside a scope: math.scope(() => {math.method();...}) to avoid memory leaks.");return result}return this.activeScope.push(result),result},NDArrayMath.prototype.dispose=function(){},NDArrayMath.prototype.matMul=function(a,b,aOrientation,bOrientation){var _this=this;void 0===aOrientation&&(aOrientation=MatrixOrientation.REGULAR),void 0===bOrientation&&(bOrientation=MatrixOrientation.REGULAR);var innerShapeA=aOrientation===MatrixOrientation.REGULAR?a.shape[1]:a.shape[0],innerShapeB=bOrientation===MatrixOrientation.REGULAR?b.shape[0]:b.shape[1];return util.assert(2===a.rank&&2===b.rank,"Error in matMul: inputs must be rank 2, got ranks "+a.rank+"and "+b.rank+"."),util.assert(innerShapeA===innerShapeB,"Error in matMul: inner shapes ("+innerShapeA+") and ("+innerShapeB+") of NDArrays with shapes "+a.shape+" and "+b.shape+" and orientations "+MatrixOrientation[aOrientation]+" and "+MatrixOrientation[bOrientation]+" must match."),this.executeOp("matMul",function(){return _this.matMulInternal(a,b,aOrientation,bOrientation)})},NDArrayMath.prototype.executeOp=function(name,f){var start;this.debugMode&&(start=performance.now());var result=f();if(this.debugMode){var vals=result.getValues(),time=util.rightPad(performance.now()-start+"ms",9),paddedName=util.rightPad(name,25),rank=result.rank,size=result.size,shape=util.rightPad(result.shape+"",14);console.log("%c"+paddedName+"\t%c"+time+"\t%c"+rank+"D "+shape+"\t%c"+size,"font-weight:bold","color:red","color:blue","color: orange"),this.checkForNaN(vals,name)}return this.track(result)},NDArrayMath.prototype.vectorTimesMatrix=function(v,matrix){return util.assert(1===v.rank,"Error in vectorTimesMatrix: first input must be rank 1, but got rank "+v.rank+"."),util.assert(2===matrix.rank,"Error in vectorTimesMatrix: second input must be rank 2, but got rank "+matrix.rank+"."),util.assert(v.size===matrix.shape[0],"Error in vectorTimesMatrix: size of vector ("+v.size+") must match first dimension of matrix ("+matrix.shape[0]+")"),this.matMul(v.as2D(1,-1),matrix).as1D()},NDArrayMath.prototype.matrixTimesVector=function(matrix,v){return util.assert(1===v.rank,"Error in vectorTimesMatrix: second input must rank 1, but got rank "+v.rank+"."),util.assert(2===matrix.rank,"Error in vectorTimesMatrix: first input must be a rank 2, but got rank "+matrix.rank+"."),util.assert(v.size===matrix.shape[1],"Error in vectorTimesMatrix: size of first rank 1 input "+v.size+" must match inner dimension of second rank 2 input, but got shape "+matrix.shape+"."),this.matMul(matrix,v.as2D(-1,1)).as1D()},NDArrayMath.prototype.dotProduct=function(v1,v2){return util.assert(1===v1.rank&&1===v2.rank,"Error in dotProduct: inputs must be rank 1, but got ranks "+v1.rank+" and "+v2.rank+"."),util.assert(v1.size===v2.size,"Error in dotProduct: size of inputs ("+v1.size+") and ("+v2.size+") must match."),this.matMul(v1.as2D(1,-1),v2.as2D(-1,1)).asScalar()},NDArrayMath.prototype.outerProduct=function(v1,v2){return util.assert(1===v1.rank&&1===v2.rank,"Error in outerProduct: inputs must be rank 1, but got ranks "+v1.rank+" and "+v2.rank+"."),this.matMul(v1.as2D(-1,1),v2.as2D(1,-1))},NDArrayMath.prototype.clone=function(ndarray){var _this=this;return this.executeOp("clone",function(){return _this.cloneInternal(ndarray)})},NDArrayMath.prototype.reshape=function(ndarray,newShape){return console.warn("math.reshape() is deprecated. Please call reshape() directly on the ndarray object"),ndarray.reshape(newShape)},NDArrayMath.prototype.slice1D=function(input,begin,size){var _this=this;return slice_util.assertParamsValid(input,[begin],[size]),this.executeOp("slice1D",function(){return _this.slice1DInternal(input,begin,size)})},NDArrayMath.prototype.slice2D=function(input,begin,size){var _this=this;return slice_util.assertParamsValid(input,begin,size),this.executeOp("slice2D",function(){return _this.slice2DInternal(input,begin,size)})},NDArrayMath.prototype.slice3D=function(input,begin,size){var _this=this;return slice_util.assertParamsValid(input,begin,size),this.executeOp("slice3D",function(){return _this.slice3DInternal(input,begin,size)})},NDArrayMath.prototype.slice4D=function(input,begin,size){var _this=this;return slice_util.assertParamsValid(input,begin,size),this.executeOp("slice4D",function(){return _this.slice4DInternal(input,begin,size)})},NDArrayMath.prototype.copy2D=function(source,sourceBegin,sourceSize,dest,destBegin,destSize){var _this=this;util.assert(sourceBegin[0]+sourceSize[0]<=source.shape[0]&&sourceBegin[1]+sourceSize[1]<=source.shape[1],"Error in copy2D: requested source start position "+sourceBegin+" and source size "+sourceSize+" would overflow source NDArrayof shape "+source.shape+"."),util.assert(destBegin[0]+destSize[0]<=dest.shape[0]&&destBegin[1]+destSize[1]<=dest.shape[1],"Error in copy2D: requested dest start position "+destBegin+" and source size "+destSize+" would overflow dest NDArray ofshape "+dest.shape+"."),copy2d_util.validateShapes(sourceSize,destSize),this.executeOp("copy2D",function(){return _this.copy2DInternal(source,sourceBegin,sourceSize,dest,destBegin,destSize),dest})},NDArrayMath.prototype.concat1D=function(a,b){var _this=this;return concat_util.assertParams(a.shape,b.shape,0),this.executeOp("concat1D",function(){return _this.concat1DInternal(a,b)})},NDArrayMath.prototype.concat2D=function(a,b,axis){var _this=this;return concat_util.assertParams(a.shape,b.shape,axis),this.executeOp("concat2D",function(){return _this.concat2DInternal(a,b,axis)})},NDArrayMath.prototype.concat3D=function(ndarray1,ndarray2,axis){var _this=this;return concat_util.assertParams(ndarray1.shape,ndarray2.shape,axis),this.executeOp("concat3D",function(){return _this.concat3DInternal(ndarray1,ndarray2,axis)})},NDArrayMath.prototype.concat4D=function(ndarray1,ndarray2,axis){var _this=this;return concat_util.assertParams(ndarray1.shape,ndarray2.shape,axis),this.executeOp("concat4D",function(){return _this.concat4DInternal(ndarray1,ndarray2,axis)})},NDArrayMath.prototype.logSumExp=function(ndarray){var _this=this;return this.executeOp("logSumExp",function(){return _this.logSumExpInternal(ndarray)})},NDArrayMath.prototype.sum=function(ndarray){var _this=this;return this.executeOp("sum",function(){return _this.sumInternal(ndarray)})},NDArrayMath.prototype.argMin=function(ndarray){var _this=this;return this.executeOp("argMin",function(){return _this.argMinInternal(ndarray)})},NDArrayMath.prototype.argMax=function(ndarray){var _this=this;return this.executeOp("argMax",function(){return _this.argMaxInternal(ndarray)})},NDArrayMath.prototype.argMaxEquals=function(x1,x2){var _this=this;return util.assertShapesMatch(x1.shape,x2.shape,"Error in argMaxEquals: "),this.executeOp("argMaxEquals",function(){return _this.argMaxEqualsInternal(x1,x2)})},NDArrayMath.prototype.topK=function(ndarray,k){var _this=this;util.assert(k<=ndarray.size,"Error in topK: k value ("+k+") must be less than size of input ndarray, got shape "+ndarray.shape+".");var result;return this.executeOp("topK",function(){return(result=_this.topKInternal(ndarray,k)).values}),this.track(result.indices),result},NDArrayMath.prototype.min=function(ndarray){var _this=this;return this.executeOp("min",function(){return _this.minInternal(ndarray)})},NDArrayMath.prototype.max=function(ndarray){var _this=this;return this.executeOp("max",function(){return _this.maxInternal(ndarray)})},NDArrayMath.prototype.softmax=function(x){var _this=this;return this.executeOp("softmax",function(){return _this.scope(function(){var lse=_this.logSumExp(x),logResult=_this.arrayMinusScalar(x,lse);return _this.exp(logResult)})})},NDArrayMath.prototype.switchDim=function(a,newDim){var _this=this;return util.assert(a.rank===newDim.length,"Error in switchDim: length of input shape "+a.shape+" must match size of newDim array "+newDim+"."),this.executeOp("switchDim",function(){return _this.switchDimInternal(a,newDim)})},NDArrayMath.prototype.scalarPlusArray=function(c,a){return util.assert(1===c.size,"Error in scalarPlusArray: first argument must be rank 0, but got rank "+c.rank+"."),this.add(c,a)},NDArrayMath.prototype.scalarMinusArray=function(c,a){return util.assert(1===c.size,"Error in scalarMinusArray: first argument must be rank 0, but got rank "+c.rank+"."),this.sub(c,a)},NDArrayMath.prototype.arrayMinusScalar=function(a,c){return util.assert(1===c.size,"Error in arrayMinusScalar: second argument must be rank 0, but got rank "+c.rank+"."),this.sub(a,c)},NDArrayMath.prototype.neg=function(a){var _this=this;return this.executeOp("neg",function(){return _this.negInternal(a)})},NDArrayMath.prototype.add=function(a,b){var _this=this;return util.assertAndGetBroadcastedShape(a.shape,b.shape),this.executeOp("add",function(){return _this.addInternal(a,b)})},NDArrayMath.prototype.addStrict=function(a,b){return util.assertShapesMatch(a.shape,b.shape,"Error in addStrict: "),this.add(a,b)},NDArrayMath.prototype.sub=function(a,b){var _this=this;return util.assertAndGetBroadcastedShape(a.shape,b.shape),this.executeOp("sub",function(){return _this.subInternal(a,b)})},NDArrayMath.prototype.subStrict=function(a,b){return util.assertShapesMatch(a.shape,b.shape,"Error in subStrict: "),this.sub(a,b)},NDArrayMath.prototype.multiply=function(a,b){var _this=this;return util.assertAndGetBroadcastedShape(a.shape,b.shape),this.executeOp("multiply",function(){return _this.multiplyInternal(a,b)})},NDArrayMath.prototype.elementWiseMul=function(a,b){return this.multiplyStrict(a,b)},NDArrayMath.prototype.multiplyStrict=function(a,b){return util.assertShapesMatch(a.shape,b.shape,"Error in multiplyStrict: "),this.multiply(a,b)},NDArrayMath.prototype.divide=function(a,b){var _this=this;return util.assertAndGetBroadcastedShape(a.shape,b.shape),this.executeOp("divide",function(){return _this.divideInternal(a,b)})},NDArrayMath.prototype.divideStrict=function(a,b){return util.assertShapesMatch(a.shape,b.shape,"Error in divideStrict: "),this.divide(a,b)},NDArrayMath.prototype.scalarDividedByArray=function(c,a){return util.assert(1===c.size,"Error in scalarDividedByArray: first argument must be rank 0, but got NDArray of rank "+c.rank+"."),this.divide(c,a)},NDArrayMath.prototype.arrayDividedByScalar=function(a,c){return util.assert(1===c.size,"Error in arrayDividedByScalar: second argument must be rank 0, but got NDArray of rank "+c.rank+"."),this.divide(a,c)},NDArrayMath.prototype.exp=function(ndarray){var _this=this;return this.executeOp("exp",function(){return _this.expInternal(ndarray)})},NDArrayMath.prototype.log=function(ndarray){var _this=this;return this.executeOp("log",function(){return _this.logInternal(ndarray)})},NDArrayMath.prototype.sqrt=function(ndarray){var _this=this;return this.executeOp("sqrt",function(){return _this.sqrtInternal(ndarray)})},NDArrayMath.prototype.abs=function(ndarray){var _this=this;return this.executeOp("abs",function(){return _this.absInternal(ndarray)})},NDArrayMath.prototype.relu=function(ndarray){var _this=this;return this.executeOp("relu",function(){return _this.reluInternal(ndarray)})},NDArrayMath.prototype.sigmoid=function(ndarray){var _this=this;return this.executeOp("sigmoid",function(){return _this.sigmoidInternal(ndarray)})},NDArrayMath.prototype.sin=function(ndarray){var _this=this;return this.executeOp("sin",function(){return _this.sinInternal(ndarray)})},NDArrayMath.prototype.cos=function(ndarray){var _this=this;return this.executeOp("cos",function(){return _this.cosInternal(ndarray)})},NDArrayMath.prototype.tan=function(ndarray){var _this=this;return this.executeOp("tan",function(){return _this.tanInternal(ndarray)})},NDArrayMath.prototype.asin=function(ndarray){var _this=this;return this.executeOp("asin",function(){return _this.asinInternal(ndarray)})},NDArrayMath.prototype.acos=function(ndarray){var _this=this;return this.executeOp("acos",function(){return _this.acosInternal(ndarray)})},NDArrayMath.prototype.atan=function(ndarray){var _this=this;return this.executeOp("atan",function(){return _this.atanInternal(ndarray)})},NDArrayMath.prototype.sinh=function(ndarray){var _this=this;return this.executeOp("sinh",function(){return _this.sinhInternal(ndarray)})},NDArrayMath.prototype.cosh=function(ndarray){var _this=this;return this.executeOp("cosh",function(){return _this.coshInternal(ndarray)})},NDArrayMath.prototype.tanh=function(ndarray){var _this=this;return this.executeOp("tanh",function(){return _this.tanhInternal(ndarray)})},NDArrayMath.prototype.step=function(ndarray){var _this=this;return this.executeOp("step",function(){return _this.stepInternal(ndarray)})},NDArrayMath.prototype.scaledArrayAdd=function(c1,a,c2,b){var _this=this;return util.assert(1===c1.size,"Error in scaledArrayAdd: first argument must rank 0, but got  rank "+c1.rank+"."),util.assert(1===c2.size,"Error in scaledArrayAdd: third argument must be rank 0, but got NDArray of rank "+c2.rank+"."),util.assertShapesMatch(a.shape,b.shape,"Error in scaledArrayAdd: "),this.executeOp("scaledArrayAdd",function(){return _this.scaledArrayAddInternal(c1,a,c2,b)})},NDArrayMath.prototype.scalarTimesArray=function(c,a){return util.assert(1===c.size,"Error in arrayDividedByScalar: first argument must be rank 0, but got rank "+c.rank+"."),this.multiply(c,a)},NDArrayMath.prototype.elementWiseMulBroadcast=function(a,b){return util.assert(2===a.rank,"Error in elementWiseMulBroadcast: first argument must be rank 2, but got rank "+a.rank+"."),util.assert(2===b.rank,"Error in elementWiseMulBroadcast: second argument must be rank 2, but got rank "+b.rank+"."),this.multiply(a,b)},NDArrayMath.prototype.conv2d=function(x,filter,bias,strides,pad){var _this=this;util.assert(3===x.rank,"Error in conv2d: x must be rank 3, but got rank "+x.rank+"."),util.assert(4===filter.rank,"Error in conv2d: filter must be rank 4, but got rank "+filter.rank+"."),null!=bias&&util.assert(1===bias.rank,"Error in conv2d: bias must be rank 1, but got rank "+bias.rank+"."),util.assert(x.shape[2]===filter.shape[2],"Error in conv2d: depth of input ("+x.shape[2]+") must match  input depth for filter "+filter.shape[2]+".");var filterHeight=filter.shape[0],filterWidth=filter.shape[1],outDepth=filter.shape[3],_a=parseTupleParam(strides),strideHeight=_a[0],strideWidth=_a[1],convInfo=conv_util.computeConvInfo(x.shape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad);return this.executeOp("conv2d",function(){return _this.conv2dInternal(x,filter,bias,convInfo)})},NDArrayMath.prototype.conv2dBackProp=function(x,dy,filter,strides,pad){var dw=this.conv2dDerFilter(x,dy,filter.shape,strides,pad);return{db:this.conv2dDerBias(dy),dw:dw,dx:this.conv2dDerInput(x.shape,dy,filter,strides,pad)}},NDArrayMath.prototype.conv2dDerInput=function(inShape,dy,filter,strides,pad){var _this=this,inDepth=inShape[2],outDepth=dy.shape[2];util.assert(3===inShape.length,"Error in conv2dDerInput: x must be rank 3, but got rank "+inShape.length+"."),util.assert(3===dy.rank,"Error in conv2dDerInput: dy must be rank 3, but got rank "+dy.rank),util.assert(4===filter.rank,"Error in conv2dDerInput: filter must be rank 4, but got rank "+filter.rank),util.assert(inDepth===filter.shape[2],"Error in conv2dDerInput: depth of input ("+inDepth+") must match input depth for filter "+filter.shape[2]+"."),util.assert(outDepth===filter.shape[3],"Error in conv2dDerInput: depth of output ("+outDepth+") mustmatch output depth for filter "+filter.shape[3]+".");var filterHeight=filter.shape[0],filterWidth=filter.shape[1],_a=parseTupleParam(strides),strideHeight=_a[0],strideWidth=_a[1],convInfo=conv_util.computeConvInfo(inShape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad);return this.executeOp("conv2dDerInput",function(){return _this.conv2dDerInputInternal(dy,filter,convInfo)})},NDArrayMath.prototype.conv2dDerBias=function(dy){return this.track(this.conv2dDerBiasInternal(dy))},NDArrayMath.prototype.conv2dDerFilter=function(x,dy,filterSize,strides,pad){util.assert(3===x.rank,"Error in conv2dDerFilter: x must be rank 3, but got shape "+x.shape+"."),util.assert(3===dy.rank,"Error in conv2dDerFilter: dy must be rank 3, but got shape "+dy.shape+"."),util.assert(4===filterSize.length,"Error in conv2dDerFilter: filterSize must be length 4, but got "+filterSize+"."),util.assert(x.shape[2]===filterSize[2],"Error in conv2dDerFilter: depth of x "+x.shape[2]+") must match input depth in filter ("+filterSize[2]+"."),util.assert(dy.shape[2]===filterSize[3],"Error in conv2dDerFilter: depth of dy ("+dy.shape[2]+") must match output depth for filter ("+filterSize[3]+").");var filterHeight=filterSize[0],filterWidth=filterSize[1],outDepth=filterSize[3],_a=parseTupleParam(strides),strideHeight=_a[0],strideWidth=_a[1],convInfo=conv_util.computeConvInfo(x.shape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad);return this.track(this.conv2dDerFilterInternal(x,dy,convInfo))},NDArrayMath.prototype.conv2dTranspose=function(x,filter,outputShape,strides,pad){return this.conv2dDerInput(outputShape,x,filter,strides,pad)},NDArrayMath.prototype.maxPool=function(x,filterSize,strides,pad){var _this=this;util.assert(3===x.rank,"Error in maxPool: x must be rank 3 but got rank "+x.rank+".");var _a=parseTupleParam(filterSize),filterHeight=_a[0],filterWidth=_a[1],outDepth=x.shape[2],_b=parseTupleParam(strides),strideHeight=_b[0],strideWidth=_b[1],convInfo=conv_util.computeConvInfo(x.shape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad);return this.executeOp("maxPool",function(){return _this.maxPoolInternal(x,convInfo)})},NDArrayMath.prototype.maxPoolBackprop=function(dy,x,filterSize,strides,pad){var _this=this;util.assert(3===dy.rank,"Error in maxPoolBackprop: dy must be rank 3 but got rank "+dy.rank+"."),util.assert(3===x.rank,"Error in maxPoolBackprop: x must be rank 3 but got rank "+x.rank+".");var _a=parseTupleParam(filterSize),filterHeight=_a[0],filterWidth=_a[1],outDepth=x.shape[2],_b=parseTupleParam(strides),strideHeight=_b[0],strideWidth=_b[1],convInfo=conv_util.computeConvInfo(x.shape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad);return this.executeOp("maxPoolBackprop",function(){return _this.maxPoolBackpropInternal(dy,x,convInfo)})},NDArrayMath.prototype.minPool=function(x,filterSize,strides,pad){var _this=this;util.assert(3===x.rank,"Error in minPool: x must be rank 3 but got rank "+x.rank+".");var _a=parseTupleParam(filterSize),filterHeight=_a[0],filterWidth=_a[1],outDepth=x.shape[2],_b=parseTupleParam(strides),strideHeight=_b[0],strideWidth=_b[1],convInfo=conv_util.computeConvInfo(x.shape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad);return this.executeOp("minPool",function(){return _this.minPoolInternal(x,convInfo)})},NDArrayMath.prototype.avgPool=function(x,filterSize,strides,pad){var _this=this;util.assert(3===x.rank,"Error in avgPool: x must be rank 3 but got rank "+x.rank+".");var _a=parseTupleParam(filterSize),filterHeight=_a[0],filterWidth=_a[1],outDepth=x.shape[2],_b=parseTupleParam(strides),strideHeight=_b[0],strideWidth=_b[1],convInfo=conv_util.computeConvInfo(x.shape,filterHeight,filterWidth,outDepth,strideHeight,strideWidth,pad);return this.executeOp("avgPool",function(){return _this.avgPoolInternal(x,convInfo)})},NDArrayMath.prototype.resizeBilinear3D=function(x,newShape2D,alignCorners){var _this=this;return void 0===alignCorners&&(alignCorners=!1),util.assert(3===x.rank,"Error in resizeBilinear3D: x must be rank 3 but got rank "+x.rank+"."),util.assert(2===newShape2D.length,"Error in resizeBilinear3D: new shape must 2D, but got shape "+newShape2D+"."),this.executeOp("resizeBilinear3D",function(){return _this.resizeBilinear3DInternal(x,newShape2D,alignCorners)})},NDArrayMath.prototype.batchNormalization3D=function(x,mean,variance,varianceEpsilon,scale,offset){var _this=this;return void 0===varianceEpsilon&&(varianceEpsilon=.001),util.assert(3===x.rank,"Error in batchNormalization3D: x must be rank 3 but got rank "+x.rank+"."),util.assert(3===mean.rank||1===mean.rank,"Error in batchNormalization3D: mean must be rank 3 or rank 1 but got rank "+mean.rank+"."),util.assert(3===variance.rank||1===variance.rank,"Error in batchNormalization3D: variance must be rank 3 or rank 1 but got rank "+variance.rank+"."),null!=scale&&util.assert(3===scale.rank||1===scale.rank,"Error in batchNormalization3D: scale must be rank 3 or rank 1 but got rank "+scale.rank+"."),null!=offset&&util.assert(3===offset.rank||1===offset.rank,"Error in batchNormalization3D: offset must be rank 3 or rank 1 but got rank "+offset.rank+"."),this.executeOp("batchNorm3D",function(){return _this.batchNormalization3DInternal(x,mean,variance,varianceEpsilon,scale,offset)})},NDArrayMath.prototype.multiRNNCell=function(lstmCells,data,c,h){util.assert(1===data.shape[0],"Error in multiRNNCell: first dimension of data is "+data.shape[0]+", but batch sizes > 1 are not yet supported.");for(var res=this.scope(function(){for(var input=data,newStates=[],i=0;i<lstmCells.length;i++){var output=lstmCells[i](input,c[i],h[i]);newStates.push(output[0]),newStates.push(output[1]),input=output[1]}return newStates}),newC=[],newH=[],i=0;i<res.length;i+=2)newC.push(res[i]),newH.push(res[i+1]);return[newC,newH]},NDArrayMath.prototype.basicLSTMCell=function(forgetBias,lstmKernel,lstmBias,data,c,h){var _this=this,res=this.scope(function(){util.assert(1===data.shape[0],"Error in multiRNNCell: first dimension of data is "+data.shape[0]+", but batch sizes > 1 are not yet supported.");var combined=_this.concat1D(data.as1D(),h.as1D()),weighted=_this.vectorTimesMatrix(combined,lstmKernel),res=_this.addStrict(weighted,lstmBias),sliceSize=res.size/4,i=_this.slice1D(res,0,sliceSize),j=_this.slice1D(res,sliceSize,sliceSize),f=_this.slice1D(res,2*sliceSize,sliceSize),o=_this.slice1D(res,3*sliceSize,sliceSize),newC=_this.addStrict(_this.multiplyStrict(c.as1D(),_this.sigmoid(_this.scalarPlusArray(forgetBias,f))),_this.multiplyStrict(_this.sigmoid(i),_this.tanh(j)));return[newC,_this.multiplyStrict(_this.tanh(newC),_this.sigmoid(o))]});return[res[0].as2D(1,-1),res[1].as2D(1,-1)]},NDArrayMath.prototype.multinomial=function(probabilities,numSamples,seed){var _this=this,numOutcomes=probabilities.size;if(numOutcomes<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+numOutcomes+".");return seed=seed||Math.random(),this.executeOp("multinomial",function(){return _this.multinomialInternal(probabilities,numSamples,seed)})},NDArrayMath.prototype.oneHot=function(indices,depth,onValue,offValue){var _this=this;if(void 0===onValue&&(onValue=1),void 0===offValue&&(offValue=0),depth<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+depth);return this.executeOp("oneHot",function(){return _this.oneHotInternal(indices,depth,onValue,offValue)})},NDArrayMath}();exports.NDArrayMath=NDArrayMath;var MatrixOrientation;!function(MatrixOrientation){MatrixOrientation[MatrixOrientation.REGULAR=0]="REGULAR",MatrixOrientation[MatrixOrientation.TRANSPOSED=1]="TRANSPOSED"}(MatrixOrientation=exports.MatrixOrientation||(exports.MatrixOrientation={}))},{"../util":82,"./concat_util":44,"./conv_util":45,"./copy2d_util":46,"./ndarray":51,"./slice_util":52}],49:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),util=require("../util"),concat_util=require("./concat_util"),conv_util=require("./conv_util"),copy2D_util=require("./copy2d_util"),math_1=require("./math"),ndarray_1=require("./ndarray"),NDArrayMathCPU=function(_super){function NDArrayMathCPU(safeMode){return void 0===safeMode&&(safeMode=!1),_super.call(this,safeMode)||this}return __extends(NDArrayMathCPU,_super),NDArrayMathCPU.prototype.cloneInternal=function(ndarray){return ndarray_1.NDArray.make(ndarray.shape,{values:new Float32Array(ndarray.getValues())})},NDArrayMathCPU.prototype.slice1DInternal=function(input,begin,size){var newVals=input.getValues().slice(begin,begin+size);return ndarray_1.Array1D.new(newVals)},NDArrayMathCPU.prototype.slice2DInternal=function(input,begin,size){for(var result=ndarray_1.Array2D.zeros(size),startI=begin[0],startJ=begin[1],i=0;i<size[0];++i)for(var j=0;j<size[1];++j){var val=input.get(i+startI,j+startJ);result.set(val,i,j)}return result},NDArrayMathCPU.prototype.slice3DInternal=function(input,begin,size){for(var result=ndarray_1.Array3D.zeros(size),startI=begin[0],startJ=begin[1],startK=begin[2],i=0;i<size[0];++i)for(var j=0;j<size[1];++j)for(var k=0;k<size[2];++k){var val=input.get(i+startI,j+startJ,k+startK);result.set(val,i,j,k)}return result},NDArrayMathCPU.prototype.slice4DInternal=function(input,begin,size){for(var result=ndarray_1.Array4D.zeros(size),startI=begin[0],startJ=begin[1],startK=begin[2],startL=begin[3],i=0;i<size[0];++i)for(var j=0;j<size[1];++j)for(var k=0;k<size[2];++k)for(var l=0;l<size[3];++l){var val=input.get(i+startI,j+startJ,k+startK,l+startL);result.set(val,i,j,k,l)}return result},NDArrayMathCPU.prototype.copy2DInternal=function(source,sourceBeginRowCol,sourceSizeRowCol,dest,destBeginRowCol,destSizeRowCol){copy2D_util.validateShapes(sourceSizeRowCol,destSizeRowCol);for(var srcValues=source.getValues(),dstValues=dest.getValues(),n=sourceSizeRowCol[0]*sourceSizeRowCol[1],i=0;i<n;++i){var srcRow=sourceBeginRowCol[0]+Math.floor(i/sourceSizeRowCol[1]),srcCol=sourceBeginRowCol[1]+i%sourceSizeRowCol[1],srcOff=srcRow*source.shape[1]+srcCol,dstRow=destBeginRowCol[0]+Math.floor(i/destSizeRowCol[1]),dstCol=destBeginRowCol[1]+i%destSizeRowCol[1];dstValues[dstRow*dest.shape[1]+dstCol]=srcValues[srcOff]}},NDArrayMathCPU.prototype.concat1DInternal=function(a,b){var outShape=concat_util.computeOutShape(a.shape,b.shape,0),result=ndarray_1.Array1D.zeros(outShape),aVals=a.getValues(),bVals=b.getValues(),vals=result.getValues();return vals.set(aVals,0),vals.set(bVals,a.size),result},NDArrayMathCPU.prototype.concat2DInternal=function(a,b,axis){var outShape=concat_util.computeOutShape(a.shape,b.shape,axis),result=ndarray_1.Array2D.zeros(outShape);if(0===axis){var aVals=a.getValues(),bVals=b.getValues(),vals=result.getValues();return vals.set(aVals,0),vals.set(bVals,a.size),result}for(var i=0;i<outShape[0];++i)for(var j=0;j<outShape[1];++j){var index=[i,j],value=void 0;if(index[axis]<a.shape[axis])value=a.get(i,j);else{index[axis]-=a.shape[axis];var i2=index[0],j2=index[1];value=b.get(i2,j2)}result.set(value,i,j)}return result},NDArrayMathCPU.prototype.concat3DInternal=function(a,b,axis){var outShape=concat_util.computeOutShape(a.shape,b.shape,axis),result=ndarray_1.Array3D.zeros(outShape);if(0===axis){var aVals=a.getValues(),bVals=b.getValues(),vals=result.getValues();return vals.set(aVals,0),vals.set(bVals,a.size),result}for(var i=0;i<outShape[0];++i)for(var j=0;j<outShape[1];++j)for(var k=0;k<outShape[2];++k){var index=[i,j,k],value=void 0;if(index[axis]<a.shape[axis])value=a.get(i,j,k);else{index[axis]-=a.shape[axis];var i2=index[0],j2=index[1],k2=index[2];value=b.get(i2,j2,k2)}result.set(value,i,j,k)}return result},NDArrayMathCPU.prototype.concat4DInternal=function(a,b,axis){var outShape=concat_util.computeOutShape(a.shape,b.shape,axis),result=ndarray_1.Array4D.zeros(outShape);if(0===axis){var aVals=a.getValues(),bVals=b.getValues(),vals=result.getValues();return vals.set(aVals,0),vals.set(bVals,a.size),result}for(var i=0;i<outShape[0];++i)for(var j=0;j<outShape[1];++j)for(var k=0;k<outShape[2];++k)for(var l=0;l<outShape[3];++l){var index=[i,j,k,l],value=void 0;if(index[axis]<a.shape[axis])value=a.get(i,j,k,l);else{index[axis]-=a.shape[axis];var i2=index[0],j2=index[1],k2=index[2],l2=index[3];value=b.get(i2,j2,k2,l2)}result.set(value,i,j,k,l)}return result},NDArrayMathCPU.prototype.scaledArrayAddInternal=function(c1,a,c2,b){for(var newShape=util.assertAndGetBroadcastedShape(a.shape,b.shape),newValues=new Float32Array(util.sizeFromShape(newShape)),aValues=a.getValues(),bValues=b.getValues(),c1Val=c1.get(),c2Val=c2.get(),i=0;i<newValues.length;++i)newValues[i]=c1Val*aValues[i%a.size]+c2Val*bValues[i%b.size];return ndarray_1.NDArray.make(newShape,{values:newValues})},NDArrayMathCPU.prototype.negInternal=function(a){return this.scalarTimesArray(ndarray_1.Scalar.NEG_ONE,a)},NDArrayMathCPU.prototype.addInternal=function(a,b){return this.scaledArrayAddInternal(ndarray_1.Scalar.ONE,a,ndarray_1.Scalar.ONE,b)},NDArrayMathCPU.prototype.subInternal=function(a,b){return this.scaledArrayAddInternal(ndarray_1.Scalar.ONE,a,ndarray_1.Scalar.NEG_ONE,b)},NDArrayMathCPU.prototype.matMulInternal=function(a,b,aOrientation,bOrientation){void 0===aOrientation&&(aOrientation=math_1.MatrixOrientation.REGULAR),void 0===bOrientation&&(bOrientation=math_1.MatrixOrientation.REGULAR);for(var sharedDim=aOrientation===math_1.MatrixOrientation.REGULAR?a.shape[1]:a.shape[0],leftDim=aOrientation===math_1.MatrixOrientation.REGULAR?a.shape[0]:a.shape[1],rightDim=bOrientation===math_1.MatrixOrientation.REGULAR?b.shape[1]:b.shape[0],normalGetter=function(matrix,i,j){return matrix.get(i,j)},transposedGetter=function(matrix,i,j){return matrix.get(j,i)},aGetter=aOrientation===math_1.MatrixOrientation.REGULAR?normalGetter:transposedGetter,bGetter=bOrientation===math_1.MatrixOrientation.REGULAR?normalGetter:transposedGetter,values=new Float32Array(leftDim*rightDim),index=0,i=0;i<leftDim;++i)for(var j=0;j<rightDim;++j){for(var sum=0,k=0;k<sharedDim;++k)sum+=aGetter(a,i,k)*bGetter(b,k,j);values[index++]=sum}return ndarray_1.Array2D.new([leftDim,rightDim],values)},NDArrayMathCPU.prototype.multiplyInternal=function(a,b){for(var newShape=util.assertAndGetBroadcastedShape(a.shape,b.shape),newValues=new Float32Array(util.sizeFromShape(newShape)),aValues=a.getValues(),bValues=b.getValues(),i=0;i<newValues.length;++i)newValues[i]=aValues[i%a.size]*bValues[i%b.size];return ndarray_1.NDArray.make(newShape,{values:newValues})},NDArrayMathCPU.prototype.divideInternal=function(a,b){for(var newShape=util.assertAndGetBroadcastedShape(a.shape,b.shape),newValues=new Float32Array(util.sizeFromShape(newShape)),aValues=a.getValues(),bValues=b.getValues(),i=0;i<newValues.length;++i)newValues[i]=aValues[i%a.size]/bValues[i%b.size];return ndarray_1.NDArray.make(newShape,{values:newValues})},NDArrayMathCPU.prototype.sumInternal=function(ndarray){for(var sum=0,values=ndarray.getValues(),i=0;i<values.length;++i)sum+=values[i];return ndarray_1.Scalar.new(sum)},NDArrayMathCPU.prototype.argMinInternal=function(ndarray){for(var min=Number.MAX_VALUE,minIndex=-1,values=ndarray.getValues(),i=0;i<values.length;++i){var value=values[i];if(isNaN(value))return ndarray_1.Scalar.new(NaN);value<min&&(min=value,minIndex=i)}return ndarray_1.Scalar.new(minIndex)},NDArrayMathCPU.prototype.argMaxInternal=function(ndarray){for(var max=Number.NEGATIVE_INFINITY,maxIndex=-1,values=ndarray.getValues(),i=0;i<values.length;++i){var value=values[i];if(isNaN(value))return ndarray_1.Scalar.new(NaN);value>max&&(max=value,maxIndex=i)}return ndarray_1.Scalar.new(maxIndex)},NDArrayMathCPU.prototype.argMaxEqualsInternal=function(x1,x2){var argMax1=this.argMaxInternal(x1).get(),argMax2=this.argMaxInternal(x2).get();return isNaN(argMax1)||isNaN(argMax2)?ndarray_1.Scalar.new(NaN):ndarray_1.Scalar.new(+(argMax1===argMax2))},NDArrayMathCPU.prototype.topKInternal=function(ndarray,k){for(var values=ndarray.getValues(),valuesAndIndices=[],i=0;i<values.length;i++)valuesAndIndices.push({value:values[i],index:i});valuesAndIndices.sort(function(a,b){return b.value-a.value});for(var topkValues=new Float32Array(k),topkIndices=new Float32Array(k),i=0;i<k;i++)topkValues[i]=valuesAndIndices[i].value,topkIndices[i]=valuesAndIndices[i].index;return{values:ndarray_1.Array1D.new(topkValues),indices:ndarray_1.Array1D.new(topkIndices)}},NDArrayMathCPU.prototype.minInternal=function(ndarray){for(var values=ndarray.getValues(),min=values[0],i=1;i<values.length;++i){var value=values[i];if(isNaN(value))return ndarray_1.Scalar.new(NaN);value<min&&(min=value)}return ndarray_1.Scalar.new(min)},NDArrayMathCPU.prototype.maxInternal=function(ndarray){for(var values=ndarray.getValues(),max=values[0],i=1;i<values.length;++i){var value=values[i];if(isNaN(value))return ndarray_1.Scalar.new(NaN);value>max&&(max=value)}return ndarray_1.Scalar.new(max)},NDArrayMathCPU.prototype.expInternal=function(ndarray){for(var values=ndarray.getValues(),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.exp(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:newValues})},NDArrayMathCPU.prototype.logInternal=function(ndarray){for(var values=ndarray.getValues(),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.log(value)}return ndarray_1.NDArray.make(ndarray.shape,{values:newValues})},NDArrayMathCPU.prototype.sqrtInternal=function(ndarray){for(var values=ndarray.getValues(),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.sqrt(value)}return ndarray_1.NDArray.make(ndarray.shape,{values:newValues})},NDArrayMathCPU.prototype.logSumExpInternal=function(ndarray){var xMax=this.max(ndarray),a=this.arrayMinusScalar(ndarray,xMax),b=this.exp(a),c=this.sum(b),d=this.log(c),result=this.add(xMax,d);return xMax.dispose(),a.dispose(),b.dispose(),c.dispose(),d.dispose(),result},NDArrayMathCPU.prototype.reluInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.max(0,values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.absInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.abs(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.sigmoidInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=1/(1+Math.exp(-values[i]));return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.sinInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.sin(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.cosInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.cos(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.tanInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.tan(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.asinInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.asin(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.acosInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.acos(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.atanInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.atan(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.sinhInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.sinh(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.coshInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=Math.cosh(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.tanhInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i)resultValues[i]=util.tanh(values[i]);return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.stepInternal=function(ndarray){for(var resultValues=new Float32Array(ndarray.size),values=ndarray.getValues(),i=0;i<values.length;++i){var value=values[i];resultValues[i]=value>0?1:value<0?0:value}return ndarray_1.NDArray.make(ndarray.shape,{values:resultValues})},NDArrayMathCPU.prototype.conv2dInternal=function(x,filter,bias,convInfo){for(var _a=x.shape,xRows=_a[0],xCols=_a[1],inputDepth=_a[2],filterHeight=filter.shape[0],filterWidth=filter.shape[1],outDepth=filter.shape[3],padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,y=ndarray_1.Array3D.zeros(convInfo.outShape),d2=0;d2<outDepth;++d2)for(var yR=0;yR<y.shape[0];++yR)for(var xRCorner=yR*convInfo.strideHeight-padLeft,xRMin=Math.max(0,xRCorner),xRMax=Math.min(xRows,filterHeight+xRCorner),yC=0;yC<y.shape[1];++yC){for(var xCCorner=yC*convInfo.strideWidth-padTop,xCMin=Math.max(0,xCCorner),xCMax=Math.min(xCols,filterWidth+xCCorner),dotProd=0,xR=xRMin;xR<xRMax;++xR)for(var wR=xR-xRCorner,xC=xCMin;xC<xCMax;++xC)for(var wC=xC-xCCorner,d1=0;d1<inputDepth;++d1)dotProd+=x.get(xR,xC,d1)*filter.get(wR,wC,d1,d2);var biasVal=null!=bias?bias.get(d2):0;y.set(dotProd+biasVal,yR,yC,d2)}return y},NDArrayMathCPU.prototype.conv2dDerInputInternal=function(dy,filter,convInfo){for(var inDepth=filter.shape[2],outDepth=filter.shape[3],yRows=dy.shape[0],yCols=dy.shape[1],filterHeight=filter.shape[0],filterWidth=filter.shape[1],topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dx=ndarray_1.Array3D.zeros(convInfo.inShape),d1=0;d1<inDepth;++d1)for(var xR=0;xR<dx.shape[0];++xR)for(var xRCorner=xR-leftPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(yRows,(filterHeight+xRCorner)/strideHeight),xC=0;xC<dx.shape[1];++xC){for(var xCCorner=xC-topPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(yCols,(filterWidth+xCCorner)/strideWidth),dotProd=0,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var wC=yC*strideWidth-xCCorner,d2=0;d2<outDepth;++d2)dotProd+=dy.get(yR,yC,d2)*filter.get(filterHeight-1-wR,filterWidth-1-wC,d1,d2);dx.set(dotProd,xR,xC,d1)}return dx},NDArrayMathCPU.prototype.conv2dDerFilterInternal=function(x,dY,convInfo){for(var inputDepth=x.shape[2],outputDepth=dY.shape[2],strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,weightsShape=conv_util.computeWeightsShape4D(inputDepth,outputDepth,filterHeight,filterWidth),dW=ndarray_1.Array4D.zeros(weightsShape),yNumRows=dY.shape[0],yNumCols=dY.shape[1],xNumRows=x.shape[0],xNumCols=x.shape[1],leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(yNumRows,(xNumRows+topPad-wR)/strideHeight),wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(yNumCols,(xNumCols+leftPad-wC)/strideWidth),d1=0;d1<inputDepth;++d1)for(var d2=0;d2<outputDepth;++d2){for(var dotProd=0,yR=yRMin;yR<yRMax;++yR)for(var xR=wR+yR*strideHeight-topPad,yC=yCMin;yC<yCMax;++yC){var xC=wC+yC*strideWidth-leftPad;dotProd+=x.get(xR,xC,d1)*dY.get(yR,yC,d2)}dW.set(dotProd,wR,wC,d1,d2)}return dW},NDArrayMathCPU.prototype.conv2dDerBiasInternal=function(dY){for(var outputDepth=dY.shape[2],numRows=dY.shape[0],numCols=dY.shape[1],values=new Float32Array(outputDepth),d2=0;d2<outputDepth;++d2){for(var sum=0,r=0;r<numRows;++r)for(var c=0;c<numCols;++c)sum+=dY.get(r,c,d2);values[d2]=sum}return ndarray_1.Array1D.new(values)},NDArrayMathCPU.prototype.switchDimInternal=function(t,newDim){for(var newShape=new Array(t.rank),i=0;i<newShape.length;i++)newShape[i]=t.shape[newDim[i]];for(var resultValues=new Float32Array(t.size),values=t.getValues(),result=ndarray_1.NDArray.make(newShape,{values:resultValues}),i=0;i<t.size;++i){for(var loc=t.indexToLoc(i),newLoc=new Array(loc.length),i_1=0;i_1<newLoc.length;i_1++)newLoc[i_1]=loc[newDim[i_1]];resultValues[result.locToIndex(newLoc)]=values[i]}return result},NDArrayMathCPU.prototype.pool=function(x,convInfo,poolType){for(var _a=x.shape,xRows=_a[0],xCols=_a[1],depth=_a[2],strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,y=ndarray_1.Array3D.zeros(convInfo.outShape),padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,d=0;d<depth;++d)for(var yR=0;yR<y.shape[0];++yR)for(var xRCorner=yR*strideHeight-padTop,xRMin=Math.max(0,xRCorner),xRMax=Math.min(xRows,filterHeight+xRCorner),yC=0;yC<y.shape[1];++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=Math.max(0,xCCorner),xCMax=Math.min(xCols,filterWidth+xCCorner),minMaxValue="max"===poolType?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,avgValue=0,xR=xRMin;xR<xRMax;++xR){for(var xC=xCMin;xC<xCMax;++xC){var pixel=x.get(xR,xC,d);if(isNaN(pixel)){minMaxValue=NaN,avgValue=NaN;break}"max"===poolType&&pixel>minMaxValue||"min"===poolType&&pixel<minMaxValue?minMaxValue=pixel:"avg"===poolType&&(avgValue+=pixel/(filterHeight*filterWidth))}if(isNaN(minMaxValue))break}y.set("avg"===poolType?avgValue:minMaxValue,yR,yC,d)}return y},NDArrayMathCPU.prototype.maxPoolInternal=function(x,convInfo){return this.pool(x,convInfo,"max")},NDArrayMathCPU.prototype.maxPoolPositions=function(x,convInfo){for(var _a=x.shape,xRows=_a[0],xCols=_a[1],depth=_a[2],outputShape=convInfo.outShape,maxPositions=ndarray_1.Array3D.zeros(outputShape),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,d=0;d<depth;++d)for(var yR=0;yR<outputShape[0];++yR)for(var xRCorner=yR*strideHeight-padTop,xRMin=Math.max(0,xRCorner),xRMax=Math.min(xRows,filterHeight+xRCorner),yC=0;yC<outputShape[1];++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=Math.max(0,xCCorner),xCMax=Math.min(xCols,filterWidth+xCCorner),maxValue=Number.NEGATIVE_INFINITY,maxPosition=-1,xR=xRMin;xR<xRMax;++xR)for(var wR=xR-xRCorner,xC=xCMin;xC<xCMax;++xC){var wC=xC-xCCorner,pixel=x.get(xR,xC,d);pixel>maxValue&&(maxValue=pixel,maxPosition=wR*filterWidth+wC)}maxPositions.set(maxPosition,yR,yC,d)}return maxPositions},NDArrayMathCPU.prototype.maxPoolBackpropInternal=function(dy,x,convInfo){for(var maxPositions=this.maxPoolPositions(x,convInfo),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,padLeft=filterWidth-1-convInfo.padInfo.left,padTop=filterHeight-1-convInfo.padInfo.top,_a=dy.shape,dyRows=_a[0],dyCols=_a[1],depth=_a[2],dx=ndarray_1.Array3D.zeros(x.shape),d=0;d<depth;++d)for(var dxR=0;dxR<dx.shape[0];++dxR)for(var dxC=0;dxC<dx.shape[1];++dxC){for(var dyRCorner=dxR-padTop,dyCCorner=dxC-padLeft,dotProd=0,wR=0;wR<filterHeight;++wR){var dyR=(dyRCorner+wR)/strideHeight;if(!(dyR<0||dyR>=dyRows||Math.floor(dyR)!==dyR))for(var wC=0;wC<filterWidth;++wC){var dyC=(dyCCorner+wC)/strideWidth;if(!(dyC<0||dyC>=dyCols||Math.floor(dyC)!==dyC)){var mask=filterHeight*filterWidth-1-maxPositions.get(dyR,dyC,d)===wR*filterWidth+wC?1:0;0!==mask&&(dotProd+=dy.get(dyR,dyC,d)*mask)}}}dx.set(dotProd,dxR,dxC,d)}return dx},NDArrayMathCPU.prototype.minPoolInternal=function(x,convInfo){return this.pool(x,convInfo,"min")},NDArrayMathCPU.prototype.avgPoolInternal=function(x,convInfo){return this.pool(x,convInfo,"avg")},NDArrayMathCPU.prototype.resizeBilinear3DInternal=function(x,newShape2D,alignCorners){for(var output=ndarray_1.Array3D.zeros([newShape2D[0],newShape2D[1],x.shape[2]]),effectiveInputSize=alignCorners?[x.shape[0]-1,x.shape[1]-1,x.shape[2]]:x.shape,effectiveOutputSize=alignCorners?[output.shape[0]-1,output.shape[1]-1,output.shape[2]]:output.shape,r=0;r<output.shape[0];r++)for(var c=0;c<output.shape[1];c++)for(var d=0;d<output.shape[2];d++){var sourceFracRow=effectiveInputSize[0]*r/effectiveOutputSize[0],sourceFracCol=effectiveInputSize[1]*c/effectiveOutputSize[1],sourceRowFloor=Math.floor(sourceFracRow),sourceRowCeil=Math.min(x.shape[0]-1,Math.ceil(sourceFracRow)),sourceColFloor=Math.floor(sourceFracCol),sourceColCeil=Math.min(x.shape[1]-1,Math.ceil(sourceFracCol)),topLeft=x.get(sourceRowFloor,sourceColFloor,d),bottomLeft=x.get(sourceRowCeil,sourceColFloor,d),colFrac=sourceFracCol-sourceColFloor,top_1=topLeft+(x.get(sourceRowFloor,sourceColCeil,d)-topLeft)*colFrac,newValue=top_1+(bottomLeft+(x.get(sourceRowCeil,sourceColCeil,d)-bottomLeft)*colFrac-top_1)*(sourceFracRow-sourceRowFloor);output.set(newValue,r,c,d)}return output},NDArrayMathCPU.prototype.batchNormalization3DInternal=function(x,mean,variance,varianceEpsilon,scale,offset){void 0===varianceEpsilon&&(varianceEpsilon=.001);for(var xValues=x.getValues(),meanValues=mean.getValues(),varianceValues=variance.getValues(),scaleValues=scale?scale.getValues():new Float32Array([1]),offsetValues=offset?offset.getValues():new Float32Array([0]),outValues=new Float32Array(xValues.length),i=0;i<xValues.length;i++)outValues[i]=offsetValues[i%offsetValues.length]+(xValues[i]-meanValues[i%meanValues.length])*scaleValues[i%scaleValues.length]/Math.sqrt(varianceValues[i%varianceValues.length]+varianceEpsilon);return ndarray_1.Array3D.make(x.shape,{values:outValues})},NDArrayMathCPU.prototype.multinomialInternal=function(probabilities,numSamples,seed){var probVals=probabilities.getValues(),cdf=new Float32Array(probabilities.size-1);cdf[0]=probVals[0];for(var event_1=1;event_1<cdf.length;++event_1)cdf[event_1]=cdf[event_1-1]+probVals[event_1];for(var random=seedrandom(seed.toString()),res=new Float32Array(numSamples),i=0;i<numSamples;++i){var r=random();res[i]=cdf.length;for(var event_2=0;event_2<cdf.length;event_2++)if(r<cdf[event_2]){res[i]=event_2;break}}return ndarray_1.Array1D.new(res)},NDArrayMathCPU.prototype.oneHotInternal=function(indices,depth,onValue,offValue){var res=new Float32Array(indices.size*depth);res.fill(offValue);for(var event_3=0;event_3<indices.size;++event_3)res[event_3*depth+indices.get(event_3)]=onValue;return ndarray_1.Array2D.new([indices.size,depth],res)},NDArrayMathCPU}(math_1.NDArrayMath);exports.NDArrayMathCPU=NDArrayMathCPU},{"../util":82,"./concat_util":44,"./conv_util":45,"./copy2d_util":46,"./math":48,"./ndarray":51,seedrandom:83}],50:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var math_1=require("./math"),ndarray=require("./ndarray"),ndarray_1=require("./ndarray"),addscaledmat_gpu_1=require("./webgl/addscaledmat_gpu"),argmaxequals_gpu_1=require("./webgl/argmaxequals_gpu"),argminmax_gpu_1=require("./webgl/argminmax_gpu"),batchnorm_gpu_1=require("./webgl/batchnorm_gpu"),binaryop_gpu=require("./webgl/binaryop_gpu"),binaryop_gpu_1=require("./webgl/binaryop_gpu"),concat_gpu_1=require("./webgl/concat_gpu"),conv_backprop_gpu_1=require("./webgl/conv_backprop_gpu"),conv_gpu_1=require("./webgl/conv_gpu"),copy_gpu_1=require("./webgl/copy_gpu"),gpgpu_context_1=require("./webgl/gpgpu_context"),gpgpu_math=require("./webgl/gpgpu_math"),gpgpu_util=require("./webgl/gpgpu_util"),logsumexp_gpu_1=require("./webgl/logsumexp_gpu"),max_pool_backprop_gpu_1=require("./webgl/max_pool_backprop_gpu"),minmax_gpu_1=require("./webgl/minmax_gpu"),mulmat_gpu_1=require("./webgl/mulmat_gpu"),multinomial_gpu_1=require("./webgl/multinomial_gpu"),onehot_gpu_1=require("./webgl/onehot_gpu"),pool_gpu_1=require("./webgl/pool_gpu"),reducesum_gpu_1=require("./webgl/reducesum_gpu"),resize_bilinear_gpu_1=require("./webgl/resize_bilinear_gpu"),slice_gpu_1=require("./webgl/slice_gpu"),texture_manager_1=require("./webgl/texture_manager"),unary_op=require("./webgl/unaryop_gpu"),unaryop_gpu_1=require("./webgl/unaryop_gpu"),webgl_util=require("./webgl/webgl_util"),NDArrayMathGPU=function(_super){function NDArrayMathGPU(gpgpu,safeMode){void 0===safeMode&&(safeMode=!1);var _this=_super.call(this,safeMode)||this;if(_this.binaryCache={},null==gpgpu){var gl=gpgpu_util.createWebGLContext();_this.gpgpu=new gpgpu_context_1.GPGPUContext(gl),_this.gpgpuCreatedLocally=!0}else _this.gpgpu=gpgpu,_this.gpgpuCreatedLocally=!1;return _this.textureManager=new texture_manager_1.TextureManager(_this.gpgpu),ndarray.initializeGPU(_this.gpgpu,_this.textureManager),_this}return __extends(NDArrayMathGPU,_super),NDArrayMathGPU.prototype.getGPGPUContext=function(){return this.gpgpu},NDArrayMathGPU.prototype.cloneInternal=function(a){var texShape=a.getTextureShapeRC(),source=a.as2D(texShape[0],texShape[1]),output=this.makeOutputArray(texShape);return this.copy2D(source,[0,0],texShape,output,[0,0],texShape),output.reshape(a.shape)},NDArrayMathGPU.prototype.slice1DInternal=function(input,begin,size){var program=new slice_gpu_1.SliceProgram([size]),customSetup=program.getCustomSetupFunc([begin]);return this.compileAndRun(program,[input],null,customSetup)},NDArrayMathGPU.prototype.slice2DInternal=function(input,begin,size){var program=new slice_gpu_1.SliceProgram(size),customSetup=program.getCustomSetupFunc(begin);return this.compileAndRun(program,[input],null,customSetup)},NDArrayMathGPU.prototype.slice3DInternal=function(input,begin,size){var program=new slice_gpu_1.SliceProgram(size),customSetup=program.getCustomSetupFunc(begin);return this.compileAndRun(program,[input],null,customSetup)},NDArrayMathGPU.prototype.slice4DInternal=function(input,begin,size){var program=new slice_gpu_1.SliceProgram(size),customSetup=program.getCustomSetupFunc(begin);return this.compileAndRun(program,[input],null,customSetup)},NDArrayMathGPU.prototype.copy2DInternal=function(source,sourceBeginRowCol,sourceSizeRowCol,dest,destBeginRowCol,destSizeRowCol){var program=new copy_gpu_1.Copy2DProgram(sourceSizeRowCol[1],destSizeRowCol[1]),customSetup=program.getCustomSetupFunc(sourceBeginRowCol,destBeginRowCol,destSizeRowCol);this.compileAndRun(program,[source],dest,customSetup)},NDArrayMathGPU.prototype.concat1DInternal=function(a,b){var program=new concat_gpu_1.ConcatProgram(a.shape,b.shape,0);return this.compileAndRun(program,[a,b])},NDArrayMathGPU.prototype.concat2DInternal=function(a,b,axis){var program=new concat_gpu_1.ConcatProgram(a.shape,b.shape,axis);return this.compileAndRun(program,[a,b])},NDArrayMathGPU.prototype.concat3DInternal=function(x1,x2,axis){var program=new concat_gpu_1.ConcatProgram(x1.shape,x2.shape,axis);return this.compileAndRun(program,[x1,x2])},NDArrayMathGPU.prototype.concat4DInternal=function(x1,x2,axis){var program=new concat_gpu_1.ConcatProgram(x1.shape,x2.shape,axis);return this.compileAndRun(program,[x1,x2])},NDArrayMathGPU.prototype.scaledArrayAddInternal=function(c1,a,c2,b){var program=new addscaledmat_gpu_1.AddScaledMatProgram(a.shape,b.shape);return this.compileAndRun(program,[a,b,c1,c2])},NDArrayMathGPU.prototype.negInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.NEG);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.makeOutputArray=function(shape){var textureShapeRC=webgl_util.getTextureShapeFromLogicalShape(this.gpgpu.gl,shape),texture=this.textureManager.acquireTexture(textureShapeRC);return ndarray_1.NDArray.make(shape,{texture:texture,textureShapeRC:textureShapeRC})},NDArrayMathGPU.prototype.compileAndRun=function(program,inputs,output,customSetup){var _this=this;null==output&&(output=this.makeOutputArray(program.outputShape));var key=gpgpu_math.makeShaderKey(program,inputs,output),binary=this.getAndSaveBinary(key,function(){return gpgpu_math.compileProgram(_this.gpgpu,program,inputs,output)});return gpgpu_math.runProgram(binary,inputs,output,customSetup),output},NDArrayMathGPU.prototype.matMulInternal=function(a,b,aOrientation,bOrientation){var program=new mulmat_gpu_1.MatMulProgram(a.shape,b.shape,aOrientation,bOrientation);return this.compileAndRun(program,[a,b])},NDArrayMathGPU.prototype.multiplyInternal=function(a,b){var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MUL,a.shape,b.shape);return this.compileAndRun(program,[a,b])},NDArrayMathGPU.prototype.batchNormalization3DInternal=function(x,mean,variance,varianceEpsilon,scale,offset){var inputs=[x,mean,variance];null==varianceEpsilon&&(varianceEpsilon=1e-6);var offsetShape=null;null!=offset&&(offsetShape=offset.shape,inputs.push(offset));var scaleShape=null;null!=scale&&(scaleShape=scale.shape,inputs.push(scale));var program=new batchnorm_gpu_1.BatchNormProgram(x.shape,mean.shape,variance.shape,offsetShape,scaleShape,varianceEpsilon);return this.compileAndRun(program,inputs)},NDArrayMathGPU.prototype.switchDimInternal=function(a,newDim){throw new Error("Not yet implemented!")},NDArrayMathGPU.prototype.sumInternal=function(a){var program=new reducesum_gpu_1.ReduceSumProgram(a.size);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.argMinInternal=function(a){var program=new argminmax_gpu_1.ArgMinMaxProgram(a.size,"min");return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.argMaxInternal=function(a){var program=new argminmax_gpu_1.ArgMinMaxProgram(a.size,"max");return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.argMaxEqualsInternal=function(x1,x2){var program=new argmaxequals_gpu_1.ArgMaxEqualsProgram(x1.size,x2.size);return this.compileAndRun(program,[x1,x2])},NDArrayMathGPU.prototype.topKInternal=function(ndarray,k){throw new Error("topK GPU not yet implemented!")},NDArrayMathGPU.prototype.minInternal=function(a){var program=new minmax_gpu_1.MinMaxProgram(a.size,"min");return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.maxInternal=function(a){var program=new minmax_gpu_1.MinMaxProgram(a.size,"max");return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.divideInternal=function(a,b){var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.DIV,a.shape,b.shape);return this.compileAndRun(program,[a,b])},NDArrayMathGPU.prototype.addInternal=function(a,b){var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ADD,a.shape,b.shape);return this.compileAndRun(program,[a,b])},NDArrayMathGPU.prototype.subInternal=function(a,b){var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SUB,a.shape,b.shape);return this.compileAndRun(program,[a,b])},NDArrayMathGPU.prototype.logSumExpInternal=function(a){var program=new logsumexp_gpu_1.LogSumExpProgram(a.size);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.expInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.EXP);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.logInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.LOG);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.sqrtInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.SQRT);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.reluInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.RELU);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.absInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.ABS);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.sigmoidInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.SIGMOID);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.sinInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.SIN);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.cosInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.COS);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.tanInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.TAN);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.asinInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.ASIN);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.acosInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.ACOS);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.atanInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.ATAN);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.sinhInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.SINH);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.coshInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.COSH);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.tanhInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.TANH);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.stepInternal=function(a){var program=new unaryop_gpu_1.UnaryOpProgram(a.shape,unary_op.STEP);return this.compileAndRun(program,[a])},NDArrayMathGPU.prototype.conv2dInternal=function(x,filter,bias,convInfo){var program=new conv_gpu_1.Conv2DProgram(convInfo,null!=bias),inputs=null!=bias?[x,filter,bias]:[x,filter];return this.compileAndRun(program,inputs)},NDArrayMathGPU.prototype.conv2dDerInputInternal=function(dy,filter,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},NDArrayMathGPU.prototype.conv2dDerFilterInternal=function(x,dY,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerWeightsProgram(convInfo);return this.compileAndRun(program,[x,dY])},NDArrayMathGPU.prototype.conv2dDerBiasInternal=function(dY){var program=new conv_backprop_gpu_1.Conv2DDerBiasProgram(dY.shape);return this.compileAndRun(program,[dY])},NDArrayMathGPU.prototype.maxPoolInternal=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"max",!1);return this.compileAndRun(program,[x])},NDArrayMathGPU.prototype.minPoolInternal=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"min",!1);return this.compileAndRun(program,[x])},NDArrayMathGPU.prototype.avgPoolInternal=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"avg",!1);return this.compileAndRun(program,[x])},NDArrayMathGPU.prototype.maxPoolBackpropInternal=function(dy,x,convInfo){var maxPoolPositionsProgram=new pool_gpu_1.Pool2DProgram(convInfo,"max",!0),maxPoolPositions=this.compileAndRun(maxPoolPositionsProgram,[x]),maxPoolBackPropProgram=new max_pool_backprop_gpu_1.MaxPool2DBackpropProgram(convInfo),result=this.compileAndRun(maxPoolBackPropProgram,[dy,maxPoolPositions]);return maxPoolPositions.dispose(),result},NDArrayMathGPU.prototype.resizeBilinear3DInternal=function(x,newShape2D,alignCorners){var program=new resize_bilinear_gpu_1.ResizeBilinear3DProgram(x.shape,newShape2D,alignCorners);return this.compileAndRun(program,[x])},NDArrayMathGPU.prototype.multinomialInternal=function(probs,numSamples,seed){var program=new multinomial_gpu_1.MultinomialProgram(probs.size,numSamples),customSetup=program.getCustomSetupFunc(seed);return this.compileAndRun(program,[probs],null,customSetup)},NDArrayMathGPU.prototype.oneHotInternal=function(indices,depth,onValue,offValue){var program=new onehot_gpu_1.OneHotProgram(indices.size,depth,onValue,offValue);return this.compileAndRun(program,[indices])},NDArrayMathGPU.prototype.getAndSaveBinary=function(key,getBinary){return key in this.binaryCache||(this.binaryCache[key]=getBinary()),this.binaryCache[key]},NDArrayMathGPU.prototype.getTextureManager=function(){return this.textureManager},NDArrayMathGPU.prototype.dispose=function(){for(var key in this.binaryCache)this.gpgpu.deleteProgram(this.binaryCache[key].webGLProgram);this.textureManager.dispose(),this.gpgpuCreatedLocally&&this.gpgpu.dispose()},NDArrayMathGPU}(math_1.NDArrayMath);exports.NDArrayMathGPU=NDArrayMathGPU},{"./math":48,"./ndarray":51,"./webgl/addscaledmat_gpu":53,"./webgl/argmaxequals_gpu":54,"./webgl/argminmax_gpu":55,"./webgl/batchnorm_gpu":56,"./webgl/binaryop_gpu":57,"./webgl/concat_gpu":58,"./webgl/conv_backprop_gpu":59,"./webgl/conv_gpu":60,"./webgl/copy_gpu":61,"./webgl/gpgpu_context":62,"./webgl/gpgpu_math":63,"./webgl/gpgpu_util":64,"./webgl/logsumexp_gpu":65,"./webgl/max_pool_backprop_gpu":66,"./webgl/minmax_gpu":67,"./webgl/mulmat_gpu":68,"./webgl/multinomial_gpu":69,"./webgl/onehot_gpu":70,"./webgl/pool_gpu":71,"./webgl/reducesum_gpu":72,"./webgl/resize_bilinear_gpu":74,"./webgl/slice_gpu":76,"./webgl/texture_manager":78,"./webgl/unaryop_gpu":79,"./webgl/webgl_util":80}],51:[function(require,module,exports){"use strict";function throwIfGPUNotInitialized(){if(null==exports.GPGPU||null==exports.TEXTURE_MANAGER)throw new Error("GPU not intialized.")}function toTypedArray(a){return a instanceof Float32Array?a:new Float32Array(util.flatten(a))}var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util=require("../util"),webgl_util=require("./webgl/webgl_util");exports.GPGPU=null,exports.TEXTURE_MANAGER=null,exports.initializeGPU=function(gpgpu,textureManager){exports.GPGPU=gpgpu,exports.TEXTURE_MANAGER=textureManager};var NDArray=function(){function NDArray(shape,data){util.assert(null!=data.values||null!=data.texture,"Either `values` or `texture` must be defined"),util.assert(null==data.texture||null!=data.textureShapeRC,"`textureShape` must be defined when `texture` is defined"),this.size=util.sizeFromShape(shape),null!=data.values&&util.assert(this.size===data.values.length,"Constructing ndarray of shape ("+this.size+") should match the length of values ("+data.values.length+")"),this.shape=shape,this.data=data;var dim=this.shape.length;if(dim<2)this.strides=[];else{this.strides=new Array(dim-1),this.strides[dim-2]=this.shape[dim-1];for(var i=dim-3;i>=0;--i)this.strides[i]=this.strides[i+1]*this.shape[i+1]}}return NDArray.zeros=function(shape){var values=new Float32Array(util.sizeFromShape(shape));return NDArray.make(shape,{values:values})},NDArray.zerosLike=function(another){return NDArray.zeros(another.shape)},NDArray.like=function(another){var values=another.getValues();return NDArray.make(another.shape,{values:new Float32Array(values)})},NDArray.make=function(shape,data){switch(shape.length){case 0:return new Scalar(data);case 1:return new Array1D(data);case 2:return new Array2D(shape,data);case 3:return new Array3D(shape,data);case 4:return new Array4D(shape,data);default:return new NDArray(shape,data)}},NDArray.prototype.reshape=function(newShape){return newShape=util.inferFromImplicitShape(newShape,this.size),util.arraysEqual(this.shape,newShape)?this:(util.assert(this.size===util.sizeFromShape(newShape),"new shape and old shape must have the same number of elements."),NDArray.make(newShape,this.data))},NDArray.prototype.asScalar=function(){return util.assert(1===this.size,"The array must have only 1 element."),this.reshape([])},NDArray.prototype.as1D=function(){return this.reshape([this.size])},NDArray.prototype.as2D=function(rows,columns){return this.reshape([rows,columns])},NDArray.prototype.as3D=function(rows,columns,depth){return this.reshape([rows,columns,depth])},NDArray.prototype.as4D=function(rows,columns,depth,depth2){return this.reshape([rows,columns,depth,depth2])},Object.defineProperty(NDArray.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),NDArray.prototype.get=function(){for(var locs=[],_i=0;_i<arguments.length;_i++)locs[_i]=arguments[_i];for(var index=locs[locs.length-1],i=0;i<locs.length-1;++i)index+=this.strides[i]*locs[i];return this.getValues()[index]},NDArray.prototype.add=function(value){for(var locs=[],_i=1;_i<arguments.length;_i++)locs[_i-1]=arguments[_i];this.set.apply(this,[this.get.apply(this,locs)+value].concat(locs))},NDArray.prototype.set=function(value){for(var locs=[],_i=1;_i<arguments.length;_i++)locs[_i-1]=arguments[_i];for(var index=locs[locs.length-1],i=0;i<locs.length-1;++i)index+=this.strides[i]*locs[i];this.getValues()[index]=value},NDArray.prototype.locToIndex=function(locs){for(var index=locs[locs.length-1],i=0;i<locs.length-1;++i)index+=this.strides[i]*locs[i];return index},NDArray.prototype.indexToLoc=function(index){for(var locs=new Array(this.shape.length),i=0;i<locs.length-1;++i)locs[i]=Math.floor(index/this.strides[i]),index-=locs[i]*this.strides[i];return locs[locs.length-1]=index,locs},NDArray.prototype.fill=function(value){this.getValues().fill(value)},NDArray.prototype.getData=function(){return this.data},NDArray.prototype.getValues=function(){return null==this.data.values&&(throwIfGPUNotInitialized(),this.data.values=exports.GPGPU.downloadMatrixFromTexture(this.data.texture,this.data.textureShapeRC[0],this.data.textureShapeRC[1]),this.disposeTexture()),this.data.values},NDArray.prototype.getValuesAsync=function(){var _this=this;return new Promise(function(resolve,reject){if(null==_this.data.values)if(environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED")){exports.GPGPU.runQuery(function(){}).then(function(){resolve(_this.getValues())})}else resolve(_this.getValues());else resolve(_this.data.values)})},NDArray.prototype.uploadToGPU=function(preferredTexShape){throwIfGPUNotInitialized(),this.data.textureShapeRC=webgl_util.getTextureShapeFromLogicalShape(exports.GPGPU.gl,this.shape,preferredTexShape),this.data.texture=exports.TEXTURE_MANAGER.acquireTexture(this.data.textureShapeRC),exports.GPGPU.uploadMatrixToTexture(this.data.texture,this.data.textureShapeRC[0],this.data.textureShapeRC[1],this.data.values),this.data.values=null},NDArray.prototype.getTexture=function(preferredShapeRC){return null==this.data.texture&&this.uploadToGPU(preferredShapeRC),this.data.texture},NDArray.prototype.getTextureShapeRC=function(preferredShapeRC){return null==this.data.textureShapeRC&&this.uploadToGPU(preferredShapeRC),this.data.textureShapeRC},NDArray.prototype.dispose=function(){this.data.values=null,this.shape=null,null!=this.data.texture&&this.disposeTexture()},NDArray.prototype.disposeTexture=function(){throwIfGPUNotInitialized(),exports.TEXTURE_MANAGER.releaseTexture(this.data.texture,this.data.textureShapeRC),this.data.texture=null,this.data.textureShapeRC=null},NDArray.prototype.inGPU=function(){return null!=this.data.texture},NDArray.prototype.equals=function(t){return util.arraysEqual(this.shape,t.shape)&&util.arraysEqual(this.getValues(),t.getValues())},NDArray.rand=function(shape,randFunction){for(var size=util.sizeFromShape(shape),values=new Float32Array(size),i=0;i<size;i++)values[i]=randFunction();return NDArray.make(shape,{values:values})},NDArray.randNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev)})},NDArray.randTruncatedNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev,!0)})},NDArray.randUniform=function(shape,a,b){return NDArray.rand(shape,function(){return util.randUniform(a,b)})},NDArray}();exports.NDArray=NDArray;var Scalar=function(_super){function Scalar(data){return null!=data.texture&&(data.textureShapeRC=[1,1]),_super.call(this,[],data)||this}return __extends(Scalar,_super),Scalar.new=function(value){return new Scalar({values:new Float32Array([value])})},Scalar.prototype.get=function(){return this.getValues()[0]},Scalar.prototype.set=function(value){this.getValues()[0]=value},Scalar.prototype.add=function(value){this.getValues()[0]+=value},Scalar.ZERO=Scalar.new(0),Scalar.ONE=Scalar.new(1),Scalar.TWO=Scalar.new(2),Scalar.NEG_ONE=Scalar.new(-1),Scalar}(NDArray);exports.Scalar=Scalar;var Array1D=function(_super){function Array1D(data){var shape=null!=data.values?[data.values.length]:[util.sizeFromShape(data.textureShapeRC)];return _super.call(this,shape,data)||this}return __extends(Array1D,_super),Array1D.new=function(values){if(!(values instanceof Float32Array)){var inferredShape=util.inferShape(values);util.assert(1===inferredShape.length,"Error constructing Array1D. Shape of values "+inferredShape+" is not 1 dimensional.")}return new Array1D({values:toTypedArray(values)})},Array1D.prototype.get=function(i){return this.getValues()[i]},Array1D.prototype.set=function(value,i){this.getValues()[i]=value},Array1D.prototype.add=function(value,i){this.getValues()[i]+=value},Array1D.prototype.locToIndex=function(loc){return loc[0]},Array1D.prototype.indexToLoc=function(index){return[index]},Array1D.zeros=function(shape){return NDArray.zeros(shape)},Array1D.randNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev)})},Array1D.randTruncatedNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev,!0)})},Array1D.randUniform=function(shape,a,b){return NDArray.rand(shape,function(){return util.randUniform(a,b)})},Array1D.make=function(shape,data){return new Array1D(data)},Array1D}(NDArray);exports.Array1D=Array1D;var Array2D=function(_super){function Array2D(shape,data){var _this=this;return util.assert(2===shape.length,"Shape should be of length 2"),_this=_super.call(this,shape,data)||this,_this.stride0=_this.strides[0],_this}return __extends(Array2D,_super),Array2D.new=function(shape,values){if(!(values instanceof Float32Array)){var inferredShape=util.inferShape(values);inferredShape.length>1&&util.assertShapesMatch(shape,inferredShape,"Error when constructing Array2D. Shape of values "+inferredShape+" does not match the provided shape "+shape+". ")}return new Array2D(shape,{values:toTypedArray(values)})},Array2D.prototype.get=function(i,j){return this.getValues()[this.stride0*i+j]},Array2D.prototype.set=function(value,i,j){this.getValues()[this.stride0*i+j]=value},Array2D.prototype.add=function(value,i,j){this.getValues()[this.stride0*i+j]+=value},Array2D.prototype.locToIndex=function(locs){return this.stride0*locs[0]+locs[1]},Array2D.prototype.indexToLoc=function(index){return[Math.floor(index/this.stride0),index%this.stride0]},Array2D.zeros=function(shape){return NDArray.zeros(shape)},Array2D.randNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev)})},Array2D.randTruncatedNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev,!0)})},Array2D.randUniform=function(shape,a,b){return NDArray.rand(shape,function(){return util.randUniform(a,b)})},Array2D.make=function(shape,data){return new Array2D(shape,data)},Array2D}(NDArray);exports.Array2D=Array2D;var Array3D=function(_super){function Array3D(shape,data){var _this=this;return util.assert(3===shape.length,"Shape should be of length 3"),_this=_super.call(this,shape,data)||this,_this.stride0=_this.strides[0],_this.stride1=_this.strides[1],_this}return __extends(Array3D,_super),Array3D.new=function(shape,values){if(!(values instanceof Float32Array)){var inferredShape=util.inferShape(values);inferredShape.length>1&&util.assertShapesMatch(shape,inferredShape,"Error when constructing Array3D. Shape of values "+inferredShape+" does not match the provided shape "+shape+". ")}return new Array3D(shape,{values:toTypedArray(values)})},Array3D.prototype.get=function(i,j,k){return this.getValues()[this.stride0*i+this.stride1*j+k]},Array3D.prototype.set=function(value,i,j,k){this.getValues()[this.stride0*i+this.stride1*j+k]=value},Array3D.prototype.add=function(value,i,j,k){this.getValues()[this.stride0*i+this.stride1*j+k]+=value},Array3D.prototype.locToIndex=function(locs){return this.stride0*locs[0]+this.stride1*locs[1]+locs[2]},Array3D.prototype.indexToLoc=function(index){var i=Math.floor(index/this.stride0);return index-=i*this.stride0,[i,Math.floor(index/this.stride1),index%this.stride1]},Array3D.zeros=function(shape){return NDArray.zeros(shape)},Array3D.randNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev)})},Array3D.randTruncatedNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev,!0)})},Array3D.randUniform=function(shape,a,b){return NDArray.rand(shape,function(){return util.randUniform(a,b)})},Array3D.make=function(shape,data){return new Array3D(shape,data)},Array3D}(NDArray);exports.Array3D=Array3D;var Array4D=function(_super){function Array4D(shape,data){var _this=this;return util.assert(4===shape.length,"Shape should be of length 4"),_this=_super.call(this,shape,data)||this,_this.stride0=_this.strides[0],_this.stride1=_this.strides[1],_this.stride2=_this.strides[2],_this}return __extends(Array4D,_super),Array4D.new=function(shape,values){if(!(values instanceof Float32Array)){var inferredShape=util.inferShape(values);inferredShape.length>1&&util.assertShapesMatch(shape,inferredShape,"Error when constructing Array4D. Shape of values "+inferredShape+" does not match the provided shape "+shape+". ")}return new Array4D(shape,{values:toTypedArray(values)})},Array4D.prototype.get=function(i,j,k,l){return this.getValues()[this.stride0*i+this.stride1*j+this.stride2*k+l]},Array4D.prototype.set=function(value,i,j,k,l){this.getValues()[this.stride0*i+this.stride1*j+this.stride2*k+l]=value},Array4D.prototype.add=function(value,i,j,k,l){this.getValues()[this.stride0*i+this.stride1*j+this.stride2*k+l]+=value},Array4D.prototype.locToIndex=function(locs){return this.stride0*locs[0]+this.stride1*locs[1]+this.stride2*locs[2]+locs[3]},Array4D.prototype.indexToLoc=function(index){var i=Math.floor(index/this.stride0);index-=i*this.stride0;var j=Math.floor(index/this.stride1);return index-=j*this.stride1,[i,j,Math.floor(index/this.stride2),index%this.stride2]},Array4D.zeros=function(shape){return NDArray.zeros(shape)},Array4D.randNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev)})},Array4D.randTruncatedNormal=function(shape,mean,stdDev){return void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),NDArray.rand(shape,function(){return util.randGauss(mean,stdDev,!0)})},Array4D.randUniform=function(shape,a,b){return NDArray.rand(shape,function(){return util.randUniform(a,b)})},Array4D.make=function(shape,data){return new Array4D(shape,data)},Array4D}(NDArray);exports.Array4D=Array4D},{"../environment":7,"../util":82,"./webgl/webgl_util":80}],52:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.assertParamsValid=function(input,begin,size){util.assert(input.rank===begin.length,"Error in slice"+input.rank+"D: Length of begin "+begin+" must match the rank of the array ("+input.rank+")."),util.assert(input.rank===size.length,"Error in slice"+input.rank+"D: Length of size "+size+" must match the rank of the array ("+input.rank+").");for(var i=0;i<input.rank;++i)util.assert(begin[i]+size[i]<=input.shape[i],"Error in slice"+input.rank+"D: begin["+i+"] + size["+i+"] ("+(begin[i]+size[i])+") would overflow input.shape["+i+"] ("+input.shape[i]+")")}},{"../util":82}],53:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util"),AddScaledMatProgram=function(){return function(aShape,bShape){this.variableNames=["A","B","c1","c2"],this.params=[],this.supportsBroadcasting=!0,this.outputShape=util.assertAndGetBroadcastedShape(aShape,bShape),this.userCode="\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        float c1 = getC1();\n        float c2 = getC2();\n        setOutput(dot(vec2(c1, c2), vec2(a, b)));\n      }\n    "}}();exports.AddScaledMatProgram=AddScaledMatProgram},{"../../util":82}],54:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var argminmax_gpu=require("./argminmax_gpu"),ArgMaxEqualsProgram=function(){return function(aSize,bSize){this.variableNames=["A","B"],this.outputShape=[],this.params=[];var aSnippet=argminmax_gpu.getArgMinMaxSnippet("max","A",aSize),bSnippet=argminmax_gpu.getArgMinMaxSnippet("max","B",bSize);this.userCode="\n      "+aSnippet+"\n      "+bSnippet+"\n\n      void main() {\n        float argMaxA = getArgMinMaxA();\n        float argMaxB = getArgMinMaxB();\n\n        float value;\n        if (isNaN(argMaxA)) {\n          value = argMaxA;\n        } else if (isNaN(argMaxB)) {\n          value = argMaxB;\n        } else {\n          value = float(argMaxA == argMaxB);\n        }\n\n        setOutput(value);\n      }\n    "}}();exports.ArgMaxEqualsProgram=ArgMaxEqualsProgram},{"./argminmax_gpu":55}],55:[function(require,module,exports){"use strict";function getArgMinMaxSnippet(op,texName,size){return"\n    float getArgMinMax"+texName+"() {\n      int bestIndex = 0;\n      float bestValue = get"+texName+"Flat(0);\n\n      for (int i = 0; i < "+size+"; i++) {\n        float candidate = get"+texName+"Flat(i);\n        if (isNaN(candidate)) {\n          return candidate;\n        }\n        if (candidate "+("min"===op?"<":">")+" bestValue) {\n          bestValue = candidate;\n          bestIndex = i;\n        }\n      }\n      return float(bestIndex);\n    }\n  "}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getArgMinMaxSnippet=getArgMinMaxSnippet;var ArgMinMaxProgram=function(){return function(aSize,opType){this.variableNames=["A"],this.outputShape=[],this.params=[opType];var aSnippet=getArgMinMaxSnippet(opType,"A",aSize);this.userCode="\n      "+aSnippet+"\n\n      void main() {\n        setOutput(getArgMinMaxA());\n      }\n    "}}();exports.ArgMinMaxProgram=ArgMinMaxProgram},{}],56:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util"),BatchNormProgram=function(){return function(xShape,meanShape,varianceShape,offsetShape,scaleShape,varianceEpsilon){this.params=[],this.outputShape=[],this.supportsBroadcasting=!0,this.variableNames=["x","mean","variance"],util.assertAndGetBroadcastedShape(xShape,meanShape),util.assertAndGetBroadcastedShape(xShape,varianceShape);var offsetSnippet="0.0";null!=offsetShape&&(util.assertAndGetBroadcastedShape(xShape,offsetShape),this.variableNames.push("offset"),offsetSnippet="getOffsetAtOutCoords()");var scaleSnippet="1.0";null!=scaleShape&&(util.assertAndGetBroadcastedShape(xShape,scaleShape),this.variableNames.push("scale"),scaleSnippet="getScaleAtOutCoords()"),this.params=[varianceEpsilon],this.outputShape=xShape,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+offsetSnippet+";\n        float scale = "+scaleSnippet+";\n        float inv = scale / sqrt(variance + float("+varianceEpsilon+"));\n        setOutput((x - mean) * inv + offset);\n      }\n    "}}();exports.BatchNormProgram=BatchNormProgram},{"../../util":82}],57:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util");exports.ADD="return a + b;",exports.SUB="return a - b;",exports.MUL="return a * b;",exports.DIV="return a / b;";var BinaryOpProgram=function(){return function(op,aShape,bShape){this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.params=[op],this.outputShape=util.assertAndGetBroadcastedShape(aShape,bShape),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+op+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "}}();exports.BinaryOpProgram=BinaryOpProgram},{"../../util":82}],58:[function(require,module,exports){"use strict";function getSampleCoords(rank){if(1===rank)return"yR";if(2===rank)return"yR, yC";if(3===rank)return"yR, yC, yD";if(4===rank)return"yR, yC, yD, yW";throw Error("Concat for rank "+rank+" is not yet supported")}function getUnpack(rank){var res=1===rank?"int yR = coords;":"int yR = coords.x;";if(rank>1&&(res+="\nint yC = coords.y;"),rank>2&&(res+="\nint yD = coords.z;"),rank>3&&(res+="\nint yW = coords.w;"),rank>4)throw Error("Concat for rank "+rank+" is not yet supported");return res}function getDataType(rank){if(1===rank)return"int";if(2===rank)return"ivec2";if(3===rank)return"ivec3";if(4===rank)return"ivec4";throw Error("Concat for rank "+rank+" is not yet supported")}Object.defineProperty(exports,"__esModule",{value:!0});var concat_util=require("../concat_util"),ConcatProgram=function(){return function(aShape,bShape,axis){this.variableNames=["A","B"],this.params=[],this.outputShape=[];var concatAxis=["yR","yC","yD","yW"][axis];this.params=[axis],this.outputShape=concat_util.computeOutShape(aShape,bShape,axis);var dType=getDataType(aShape.length),unpackSnippet=getUnpack(aShape.length),sampleCoords=getSampleCoords(aShape.length);this.userCode="\n      void main() {\n        "+dType+" coords = getOutputCoords();\n        "+unpackSnippet+"\n\n        float value = 0.0;\n        if ("+concatAxis+" < "+aShape[axis]+") {\n          value = getA("+sampleCoords+");\n        } else {\n          "+concatAxis+" -= "+aShape[axis]+";\n          value = getB("+sampleCoords+");\n        }\n\n        setOutput(value);\n      }\n    "}}();exports.ConcatProgram=ConcatProgram},{"../concat_util":44}],59:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var conv_util=require("../conv_util"),Conv2DDerWeightsProgram=function(){return function(convInfo){this.variableNames=["x","dy"];var _a=convInfo.outShape,yNumRows=_a[0],yNumCols=_a[1],outDepth=_a[2],_b=convInfo.inShape,xNumRows=_b[0],xNumCols=_b[1],inDepth=_b[2],strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth;this.outputShape=conv_util.computeWeightsShape4D(inDepth,outDepth,convInfo.filterHeight,convInfo.filterWidth);var padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.params=[strideHeight,strideWidth,padLeft,padTop],this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int yR = 0; yR < "+yNumRows+"; yR++) {\n          int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n          if (xR < 0 || xR >= "+xNumRows+") {\n            continue;\n          }\n\n          for (int yC = 0; yC < "+yNumCols+"; yC++) {\n            int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n            if (xC < 0 || xC >= "+xNumCols+") {\n              continue;\n            }\n\n            float dyValue = getDy(yR, yC, d2);\n            float xValue = getX(xR, xC, d1);\n            dotProd += (xValue * dyValue);\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}}();exports.Conv2DDerWeightsProgram=Conv2DDerWeightsProgram;var Conv2DDerInputProgram=function(){return function(convInfo){this.variableNames=["dy","W"];var _a=convInfo.outShape,yRows=_a[0],yCols=_a[1],outDepth=_a[2];this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left;this.params=[strideHeight,strideWidth,padLeft,padTop],this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int d1 = coords.z;\n\n        ivec2 dyCorner = coords.xy - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+yRows+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+filterHeight+" - 1 - wR;\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+yCols+".0 || fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+filterWidth+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+outDepth+"; d2++) {\n              float xValue = getDy(idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, d2);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}}();exports.Conv2DDerInputProgram=Conv2DDerInputProgram;var Conv2DDerBiasProgram=function(){return function(yShape){this.variableNames=["dy"],this.params=[];var yNumRows=yShape[0],yNumCols=yShape[1],outputDepth=yShape[2];this.outputShape=[outputDepth],this.userCode="\n      void main() {\n        int d2 = getOutputCoords();\n\n        float derBias = 0.0;\n        for (int yR = 0; yR < "+yNumRows+"; yR++) {\n          for (int yC = 0; yC < "+yNumCols+"; yC++) {\n            derBias += getDy(yR, yC, d2);\n          }\n        }\n        setOutput(derBias);\n      }\n    "}}();exports.Conv2DDerBiasProgram=Conv2DDerBiasProgram},{"../conv_util":45}],60:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Conv2DProgram=function(){return function(convInfo,hasBias){this.variableNames=["x","W"],hasBias&&this.variableNames.push("bias"),this.outputShape=convInfo.outShape;var biasSnippet=hasBias?"dotProd += getBias(d2);":"",_a=convInfo.inShape,xNumRows=_a[0],xNumCols=_a[1],inputDepth=_a[2],padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth;this.params=[strideHeight,strideWidth,hasBias,padLeft,padTop];var inputDepthNearestVec4=4*Math.floor(inputDepth/4),inputDepthVec4Remainder=inputDepth%4;this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int d2 = coords.z;\n\n        ivec2 xRCCorner = coords.xy * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+xNumRows+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            int xC = xCCorner + wC;\n\n            if (xC < 0 || xC >= "+xNumCols+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+inputDepthNearestVec4+"; d1 += 4) {\n              vec4 xValues = vec4(\n                getX(xR, xC, d1),\n                getX(xR, xC, d1 + 1),\n                getX(xR, xC, d1 + 2),\n                getX(xR, xC, d1 + 3)\n              );\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              dotProd += dot(xValues, wValues);\n            }\n\n            if ("+(1===inputDepthVec4Remainder)+") {\n              dotProd +=\n                getX(xR, xC, "+inputDepthNearestVec4+") *\n                getW(wR, wC, "+inputDepthNearestVec4+", d2);\n            } else if ("+(2===inputDepthVec4Remainder)+") {\n              vec2 xValues = vec2(\n                getX(xR, xC, "+inputDepthNearestVec4+"),\n                getX(xR, xC, "+inputDepthNearestVec4+" + 1)\n              );\n              vec2 wValues = vec2(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2)\n              );\n              dotProd += dot(xValues, wValues);\n            } else if ("+(3===inputDepthVec4Remainder)+") {\n              vec3 xValues = vec3(\n                getX(xR, xC, "+inputDepthNearestVec4+"),\n                getX(xR, xC, "+inputDepthNearestVec4+" + 1),\n                getX(xR, xC, "+inputDepthNearestVec4+" + 2)\n              );\n              vec3 wValues = vec3(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 2, d2)\n              );\n              dotProd += dot(xValues, wValues);\n            }\n          }\n        }\n        "+biasSnippet+"\n        setOutput(dotProd);\n      }\n    "}}();exports.Conv2DProgram=Conv2DProgram},{}],61:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Copy2DProgram=function(){function Copy2DProgram(srcNumCols,destNumCols){this.variableNames=["source"],this.outputShape=null,this.params=[srcNumCols,destNumCols],this.userCode="\n      uniform ivec2 sourceStart;\n      uniform ivec2 destStart;\n\n      void main() {\n        ivec2 destCoords = getOutputCoords() - destStart;\n        int index = destCoords.x * "+destNumCols+" + destCoords.y;\n        int r = index / "+srcNumCols+";\n        ivec2 sourceCoords = sourceStart + ivec2(r, index - r * "+srcNumCols+");\n        setOutput(getSource(sourceCoords.x, sourceCoords.y));\n      }\n    "}return Copy2DProgram.prototype.getCustomSetupFunc=function(sourceStart,destStart,destSize){return function(gpgpu,webGLProgram){gpgpu.setOutputMatrixWriteRegion(destStart[0],destSize[0],destStart[1],destSize[1]);var sourceStartCRLoc=gpgpu.getUniformLocation(webGLProgram,"sourceStart");gpgpu.gl.uniform2i(sourceStartCRLoc,sourceStart[0],sourceStart[1]);var destStartCRLoc=gpgpu.getUniformLocation(webGLProgram,"destStart");gpgpu.gl.uniform2i(destStartCRLoc,destStart[0],destStart[1])}},Copy2DProgram}();exports.Copy2DProgram=Copy2DProgram},{}],62:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),gpgpu_util=require("./gpgpu_util"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util"),GPGPUContext=function(){function GPGPUContext(gl){this.outputTexture=null,this.program=null,this.disposed=!1,this.autoDebugValidate=!1,this.gl=null!=gl?gl:gpgpu_util.createWebGLContext(),1===environment_1.ENV.get("WEBGL_VERSION")?(this.textureFloatExtension=webgl_util.getExtensionOrThrow(this.gl,"OES_texture_float"),this.colorBufferFloatExtension=this.gl.getExtension("WEBGL_color_buffer_float")):this.colorBufferFloatExtension=webgl_util.getExtensionOrThrow(this.gl,"EXT_color_buffer_float"),this.loseContextExtension=webgl_util.getExtensionOrThrow(this.gl,"WEBGL_lose_context"),this.vertexBuffer=gpgpu_util.createVertexBuffer(this.gl),this.indexBuffer=gpgpu_util.createIndexBuffer(this.gl),this.framebuffer=webgl_util.createFramebuffer(this.gl)}return GPGPUContext.prototype.dispose=function(){var _this=this;this.throwIfDisposed(),null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var gl=this.gl;webgl_util.callAndCheck(gl,function(){return gl.finish()}),webgl_util.callAndCheck(gl,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)}),webgl_util.callAndCheck(gl,function(){return gl.deleteFramebuffer(_this.framebuffer)}),webgl_util.callAndCheck(gl,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,null)}),webgl_util.callAndCheck(gl,function(){return gl.deleteBuffer(_this.vertexBuffer)}),webgl_util.callAndCheck(gl,function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)}),webgl_util.callAndCheck(gl,function(){return gl.deleteBuffer(_this.indexBuffer)}),this.loseContextExtension.loseContext(),this.disposed=!0},GPGPUContext.prototype.enableAutomaticDebugValidation=function(enabled){this.autoDebugValidate=enabled,webgl_util.enableDebugWebGLErrorChecking(enabled)},GPGPUContext.prototype.createMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createMatrixTexture(this.gl,rows,columns)},GPGPUContext.prototype.uploadPixelDataToTexture=function(texture,pixels){this.throwIfDisposed(),gpgpu_util.uploadPixelDataToTexture(this.gl,texture,pixels)},GPGPUContext.prototype.createPackedMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createPackedMatrixTexture(this.gl,rows,columns)},GPGPUContext.prototype.deleteMatrixTexture=function(texture){var _this=this;this.throwIfDisposed(),this.outputTexture===texture&&(webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.framebuffer),this.outputTexture=null),webgl_util.callAndCheck(this.gl,function(){return _this.gl.deleteTexture(texture)})},GPGPUContext.prototype.uploadMatrixToTexture=function(texture,rows,columns,matrix){this.throwIfDisposed();return gpgpu_util.uploadMatrixToTexture(this.gl,texture,rows,columns,matrix,1)},GPGPUContext.prototype.uploadMatrixToPackedTexture=function(texture,rows,columns,matrix){return this.throwIfDisposed(),gpgpu_util.uploadMatrixToPackedTexture(this.gl,texture,rows,columns,matrix)},GPGPUContext.prototype.downloadMatrixFromTexture=function(texture,rows,columns){var _this=this;return this.downloadMatrixDriver(texture,function(){return gpgpu_util.downloadMatrixFromOutputTexture(_this.gl,rows,columns)})},GPGPUContext.prototype.downloadMatrixFromPackedTexture=function(texture,rows,columns){var _this=this;return this.downloadMatrixDriver(texture,function(){return gpgpu_util.downloadMatrixFromPackedOutputTexture(_this.gl,rows,columns)})},GPGPUContext.prototype.createProgram=function(fragmentShaderSource){this.throwIfDisposed();var gl=this.gl,fragmentShader=webgl_util.createFragmentShader(gl,fragmentShaderSource),vertexShader=gpgpu_util.createVertexShader(gl),program=webgl_util.createProgram(gl);return webgl_util.callAndCheck(gl,function(){return gl.attachShader(program,vertexShader)}),webgl_util.callAndCheck(gl,function(){return gl.attachShader(program,fragmentShader)}),webgl_util.linkProgram(gl,program),this.autoDebugValidate&&webgl_util.validateProgram(gl,program),program},GPGPUContext.prototype.deleteProgram=function(program){var _this=this;this.throwIfDisposed(),program===this.program&&(this.program=null),null!=program&&webgl_util.callAndCheck(this.gl,function(){return _this.gl.deleteProgram(program)})},GPGPUContext.prototype.setProgram=function(program){var _this=this;this.throwIfDisposed(),this.program=program,null!=this.program&&this.autoDebugValidate&&webgl_util.validateProgram(this.gl,this.program),webgl_util.callAndCheck(this.gl,function(){return _this.gl.useProgram(program)})},GPGPUContext.prototype.getUniformLocation=function(program,uniformName){return this.throwIfDisposed(),webgl_util.getProgramUniformLocationOrThrow(this.gl,program,uniformName)},GPGPUContext.prototype.getAttributeLocation=function(program,attribute){var _this=this;return this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,function(){return _this.gl.getAttribLocation(program,attribute)})},GPGPUContext.prototype.getUniformLocationNoThrow=function(program,uniformName){return this.throwIfDisposed(),this.gl.getUniformLocation(program,uniformName)},GPGPUContext.prototype.setInputMatrixTexture=function(inputMatrixTexture,uniformLocation,textureUnit){this.throwIfDisposed(),this.throwIfNoProgram(),webgl_util.bindTextureToProgramUniformSampler(this.gl,this.program,inputMatrixTexture,uniformLocation,textureUnit)},GPGPUContext.prototype.setOutputMatrixTexture=function(outputMatrixTexture,rows,columns){this.setOutputMatrixTextureDriver(outputMatrixTexture,columns,rows)},GPGPUContext.prototype.setOutputPackedMatrixTexture=function(outputPackedMatrixTexture,rows,columns){this.throwIfDisposed();var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns),width=_a[0],height=_a[1];this.setOutputMatrixTextureDriver(outputPackedMatrixTexture,width,height)},GPGPUContext.prototype.setOutputMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){this.setOutputMatrixWriteRegionDriver(startColumn,startRow,numColumns,numRows)},GPGPUContext.prototype.setOutputPackedMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},GPGPUContext.prototype.debugValidate=function(){null!=this.program&&webgl_util.validateProgram(this.gl,this.program),webgl_util.validateFramebuffer(this.gl)},GPGPUContext.prototype.executeProgram=function(attribLocations){this.throwIfDisposed(),this.throwIfNoProgram();var gl=this.gl;gpgpu_util.bindVertexProgramAttributeStreams(gl,this.program,this.vertexBuffer,attribLocations),this.autoDebugValidate&&this.debugValidate(),webgl_util.callAndCheck(gl,function(){return gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)})},GPGPUContext.prototype.blockUntilAllProgramsCompleted=function(){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,function(){return _this.gl.finish()})},GPGPUContext.prototype.runQuery=function(queryFn){return 2===environment_1.ENV.get("WEBGL_VERSION")?this.runQueryWebGL2(queryFn):this.runQueryWebGL1(queryFn)},GPGPUContext.prototype.runQueryWebGL2=function(benchmark){var _this=this,ext=webgl_util.getExtensionOrThrow(this.gl,"EXT_disjoint_timer_query_webgl2"),query=this.gl.createQuery();return this.gl.beginQuery(ext.TIME_ELAPSED_EXT,query),benchmark(),this.gl.endQuery(ext.TIME_ELAPSED_EXT),new Promise(function(resolve,reject){util.repeatedTry(function(){var available=_this.gl.getQueryParameter(query,_this.gl.QUERY_RESULT_AVAILABLE),disjoint=_this.gl.getParameter(ext.GPU_DISJOINT_EXT);return available&&!disjoint}).then(function(){var timeElapsedNanos=_this.gl.getQueryParameter(query,_this.gl.QUERY_RESULT);resolve(timeElapsedNanos/1e6)}).catch(function(){console.warn("Disjoint query timer never available."),resolve(-1)})})},GPGPUContext.prototype.runQueryWebGL1=function(benchmark){var _this=this,ext=webgl_util.getExtensionOrThrow(this.gl,"EXT_disjoint_timer_query"),query=ext.createQueryEXT();return ext.beginQueryEXT(ext.TIME_ELAPSED_EXT,query),benchmark(),ext.endQueryEXT(ext.TIME_ELAPSED_EXT),new Promise(function(resolve,reject){util.repeatedTry(function(){var available=ext.getQueryObjectEXT(query,ext.QUERY_RESULT_AVAILABLE_EXT),disjoint=_this.gl.getParameter(ext.GPU_DISJOINT_EXT);return available&&!disjoint}).then(function(){var timeElapsedNanos=ext.getQueryObjectEXT(query,ext.QUERY_RESULT_EXT);resolve(timeElapsedNanos/1e6)}).catch(function(){console.warn("Disjoint query timer never available."),resolve(-1)})})},GPGPUContext.prototype.downloadMatrixDriver=function(texture,downloadAndDecode){this.throwIfDisposed(),webgl_util.bindColorTextureToFramebuffer(this.gl,texture,this.framebuffer),this.autoDebugValidate&&webgl_util.validateFramebuffer(this.gl);var result=downloadAndDecode();return null!=this.outputTexture?(webgl_util.bindColorTextureToFramebuffer(this.gl,this.outputTexture,this.framebuffer),this.autoDebugValidate&&webgl_util.validateFramebuffer(this.gl)):webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.framebuffer),result},GPGPUContext.prototype.setOutputMatrixTextureDriver=function(outputMatrixTextureMaybePacked,width,height){this.throwIfDisposed();var gl=this.gl;webgl_util.bindColorTextureToFramebuffer(gl,outputMatrixTextureMaybePacked,this.framebuffer),this.autoDebugValidate&&webgl_util.validateFramebuffer(gl),this.outputTexture=outputMatrixTextureMaybePacked,webgl_util.callAndCheck(gl,function(){return gl.viewport(0,0,width,height)}),webgl_util.callAndCheck(gl,function(){return gl.scissor(0,0,width,height)})},GPGPUContext.prototype.setOutputMatrixWriteRegionDriver=function(x,y,width,height){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,function(){return _this.gl.scissor(x,y,width,height)})},GPGPUContext.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},GPGPUContext.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},GPGPUContext}();exports.GPGPUContext=GPGPUContext},{"../../environment":7,"../../util":82,"./gpgpu_util":64,"./tex_util":77,"./webgl_util":80}],63:[function(require,module,exports){"use strict";function validateBinaryAndProgram(shapeInfos,inputs){if(shapeInfos.length!==inputs.length)throw Error("Binary was compiled with "+shapeInfos.length+" inputs, but was executed with "+inputs.length+" inputs");shapeInfos.forEach(function(s,i){var shapeA=s.logicalShape,texShapeA=s.texShape,shapeB=inputs[i].shape,texShapeB=inputs[i].getTextureShapeRC();if(!util.arraysEqual(shapeA,shapeB))throw Error("Binary was compiled with different shapes than the current args. Shapes "+shapeA+" and "+shapeB+" must match");if(!util.arraysEqual(texShapeA,texShapeB))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+texShapeA+" and "+texShapeB+" must match")})}Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util"),shader_compiler=require("./shader_compiler"),ATTRIBUTE_NAMES=["uv","clipSpacePos"];exports.compileProgram=function(gpgpu,program,inputs,output){for(var userCode=program.userCode,inputInfos=inputs.map(function(input,i){var shapeInfo={logicalShape:input.shape,texShape:input.getTextureShapeRC()};return{name:program.variableNames[i],shapeInfo:shapeInfo}}),inShapeInfos=inputInfos.map(function(x){return x.shapeInfo}),outShapeInfo={logicalShape:output.shape,texShape:output.getTextureShapeRC()},source=shader_compiler.makeShader(inputInfos,outShapeInfo,userCode,!0===program.supportsBroadcasting),webGLProgram=gpgpu.createProgram(source),uniformLocations={},i=0;i<program.variableNames.length;i++){var uniformName=program.variableNames[i];uniformLocations[uniformName]=gpgpu.getUniformLocation(webGLProgram,uniformName)}var attributeLocations={};return ATTRIBUTE_NAMES.forEach(function(attribute){attributeLocations[attribute]=gpgpu.getAttributeLocation(webGLProgram,attribute)}),{program:program,source:source,webGLProgram:webGLProgram,uniformLocations:uniformLocations,attributeLocations:attributeLocations,gpgpu:gpgpu,inShapeInfos:inShapeInfos,outShapeInfo:outShapeInfo}},exports.runProgram=function(binary,inputs,output,customSetup){validateBinaryAndProgram(binary.inShapeInfos,inputs),validateBinaryAndProgram([binary.outShapeInfo],[output]);var outTex=output.getTexture(),outTexShape=output.getTextureShapeRC(),gpgpu=binary.gpgpu;gpgpu.setOutputMatrixTexture(outTex,outTexShape[0],outTexShape[1]),gpgpu.setProgram(binary.webGLProgram),inputs.forEach(function(input,i){var tex=input.getTexture(),variableName=binary.program.variableNames[i],variableUniformLocation=binary.uniformLocations[variableName];gpgpu.setInputMatrixTexture(tex,variableUniformLocation,i)}),null!=customSetup&&customSetup(gpgpu,binary.webGLProgram),gpgpu.executeProgram(binary.attributeLocations)},exports.makeShaderKey=function(program,inputs,output){var params=program.params,keyStart=inputs.concat(output).map(function(x){return x.shape+"_"+x.getTextureShapeRC()}),keyEnd=params.map(String),key=[program.constructor.name];return key.push((!0===program.supportsBroadcasting).toString()),(key=key.concat(keyStart,keyEnd)).join("_")}},{"../../util":82,"./shader_compiler":75}],64:[function(require,module,exports){"use strict";function getWebGLContextAttributes(){return{alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0}}function getTextureInternalFormat(gl,numChannels){return 2===environment_1.ENV.get("WEBGL_VERSION")?4===numChannels?gl.RGBA32F:gl.R32F:gl.RGBA}function getTextureFormat(gl,numChannels){return 2===environment_1.ENV.get("WEBGL_VERSION")?4===numChannels?gl.RGBA:gl.RED:gl.RGBA}function createAndConfigureTexture(gl,width,height,numChannels){webgl_util.validateTextureSize(gl,width,height);var texture=webgl_util.createTexture(gl),tex2d=gl.TEXTURE_2D,internalFormat=getTextureInternalFormat(gl,numChannels),format=getTextureFormat(gl,numChannels);return webgl_util.callAndCheck(gl,function(){return gl.bindTexture(tex2d,texture)}),webgl_util.callAndCheck(gl,function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(gl,function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(gl,function(){return gl.texParameteri(tex2d,gl.TEXTURE_MIN_FILTER,gl.NEAREST)}),webgl_util.callAndCheck(gl,function(){return gl.texParameteri(tex2d,gl.TEXTURE_MAG_FILTER,gl.NEAREST)}),webgl_util.callAndCheck(gl,function(){return gl.texImage2D(tex2d,0,internalFormat,width,height,0,format,gl.FLOAT,null)}),webgl_util.callAndCheck(gl,function(){return gl.bindTexture(gl.TEXTURE_2D,null)}),texture}function uploadDataToTexture(gl,texture,width,height,data,numChannels){var textureFormat=getTextureFormat(gl,numChannels);webgl_util.validateTextureSize(gl,width,height),webgl_util.callAndCheck(gl,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)}),webgl_util.callAndCheck(gl,function(){return gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,width,height,textureFormat,gl.FLOAT,data)}),webgl_util.callAndCheck(gl,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})}Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util");exports.getWebGLContextAttributes=getWebGLContextAttributes,exports.createWebGLContext=function(canvas){var gl,attributes=getWebGLContextAttributes();return gl=null!=canvas?webgl_util.createWebGLRenderingContextFromCanvas(canvas,attributes):webgl_util.createWebGLRenderingContext(attributes),webgl_util.callAndCheck(gl,function(){return gl.disable(gl.DEPTH_TEST)}),webgl_util.callAndCheck(gl,function(){return gl.disable(gl.STENCIL_TEST)}),webgl_util.callAndCheck(gl,function(){return gl.disable(gl.BLEND)}),webgl_util.callAndCheck(gl,function(){return gl.disable(gl.DITHER)}),webgl_util.callAndCheck(gl,function(){return gl.disable(gl.POLYGON_OFFSET_FILL)}),webgl_util.callAndCheck(gl,function(){return gl.disable(gl.SAMPLE_COVERAGE)}),webgl_util.callAndCheck(gl,function(){return gl.enable(gl.SCISSOR_TEST)}),webgl_util.callAndCheck(gl,function(){return gl.enable(gl.CULL_FACE)}),webgl_util.callAndCheck(gl,function(){return gl.cullFace(gl.BACK)}),gl},exports.createVertexShader=function(gl){return webgl_util.createVertexShader(gl,"\n    precision highp float;\n    attribute vec3 clipSpacePos;\n    attribute vec2 uv;\n    varying vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")},exports.createVertexBuffer=function(gl){var vertexArray=new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]);return webgl_util.createStaticVertexBuffer(gl,vertexArray)},exports.createIndexBuffer=function(gl){var triangleVertexIndices=new Uint16Array([0,1,2,2,1,3]);return webgl_util.createStaticIndexBuffer(gl,triangleVertexIndices)},exports.createMatrixTexture=function(gl,rows,columns){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,_a[0],_a[1],1)},exports.createColorMatrixTexture=function(gl,rows,columns){var _a=tex_util.getColorMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,_a[0],_a[1],4)},exports.createPackedMatrixTexture=function(gl,rows,columns){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,_a[0],_a[1],4)},exports.bindVertexProgramAttributeStreams=function(gl,program,vertexBuffer,attribLocations){webgl_util.callAndCheck(gl,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer)}),webgl_util.bindVertexBufferToProgramAttribute(gl,program,"clipSpacePos",vertexBuffer,3,20,0,attribLocations),webgl_util.bindVertexBufferToProgramAttribute(gl,program,"uv",vertexBuffer,2,20,12,attribLocations)},exports.uploadPixelDataToTexture=function(gl,texture,pixels){var internalFormat=getTextureInternalFormat(gl,4);webgl_util.callAndCheck(gl,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)}),webgl_util.callAndCheck(gl,function(){return gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,gl.RGBA,gl.FLOAT,pixels)}),webgl_util.callAndCheck(gl,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.uploadMatrixToTexture=function(gl,texture,rows,columns,matrix,numChannels){var unpackedArray,_a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns),w=_a[0],h=_a[1],channelsPerTexture=1===numChannels?webgl_util.getChannelsPerTexture():numChannels;1===channelsPerTexture?unpackedArray=matrix:(unpackedArray=new Float32Array(tex_util.getUnpackedArraySizeFromMatrixSize(matrix.length,channelsPerTexture)),tex_util.encodeMatrixToUnpackedArray(matrix,unpackedArray,channelsPerTexture)),uploadDataToTexture(gl,texture,w,h,unpackedArray,numChannels)},exports.uploadMatrixToPackedTexture=function(gl,texture,rows,columns,matrix){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns),w=_a[0],h=_a[1],packedRGBA=new Float32Array(tex_util.getPackedRGBAArraySizeFromMatrixShape(rows,columns));tex_util.encodeMatrixToPackedRGBA(matrix,rows,columns,packedRGBA);uploadDataToTexture(gl,texture,w,h,packedRGBA,4)},exports.downloadMatrixFromOutputTexture=function(gl,rows,columns){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns),w=_a[0],h=_a[1],unpackedArray=new Float32Array(tex_util.getUnpackedArraySizeFromMatrixSize(rows*columns,4));webgl_util.callAndCheck(gl,function(){return gl.readPixels(0,0,w,h,gl.RGBA,gl.FLOAT,unpackedArray)});var matrix=new Float32Array(rows*columns);return tex_util.decodeMatrixFromUnpackedArray(unpackedArray,matrix,4),matrix},exports.downloadMatrixFromPackedOutputTexture=function(gl,rows,columns){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns),w=_a[0],h=_a[1],packedRGBA=new Float32Array(tex_util.getPackedRGBAArraySizeFromMatrixShape(rows,columns));webgl_util.callAndCheck(gl,function(){return gl.readPixels(0,0,w,h,gl.RGBA,gl.FLOAT,packedRGBA)});var matrix=new Float32Array(rows*columns);return tex_util.decodeMatrixFromPackedRGBA(packedRGBA,rows,columns,matrix)}},{"../../environment":7,"./tex_util":77,"./webgl_util":80}],65:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var LogSumExpProgram=function(){return function(size){this.variableNames=["A"],this.params=[],this.outputShape=[];var sizeNearestVec4=4*Math.floor(size/4),sizeVec4Remainder=size%4,r1=sizeNearestVec4,r2=sizeNearestVec4+1,r3=sizeNearestVec4+2;this.userCode="\n      const vec2 ones2 = vec2(1, 1);\n      const vec3 ones3 = vec3(1, 1, 1);\n      const vec4 ones4 = vec4(1, 1, 1, 1);\n\n      void main() {\n        vec4 maxVec = vec4(getAFlat(0));\n        for (int i = 0; i < "+sizeNearestVec4+"; i += 4) {\n          vec4 aVec = vec4(getAFlat(i), getAFlat(i+1),\n                           getAFlat(i+2), getAFlat(i+3));\n          maxVec = max(maxVec, aVec);\n        }\n        if ("+(1===sizeVec4Remainder)+") {\n          maxVec = max(maxVec, vec4(maxVec.xyz, getAFlat("+r1+")));\n        } else if ("+(2===sizeVec4Remainder)+") {\n          vec2 aVec = vec2(getAFlat("+r1+"), getAFlat("+r2+"));\n          maxVec = max(maxVec, vec4(maxVec.xy, aVec));\n        } else if ("+(3===sizeVec4Remainder)+") {\n          vec3 aVec = vec3(getAFlat("+r1+"), getAFlat("+r2+"), getAFlat("+r3+"));\n          maxVec = max(maxVec, vec4(maxVec.x, aVec));\n        }\n        float finalMax = max(maxVec.x, max(maxVec.y, max(maxVec.z, maxVec.w)));\n\n        float expSum = 0.0;\n        for (int i = 0; i < "+sizeNearestVec4+"; i += 4) {\n          vec4 aVec = vec4(getAFlat(i), getAFlat(i+1),\n                           getAFlat(i+2), getAFlat(i+3));\n          expSum += dot(ones4, exp(aVec - finalMax));\n        }\n        if ("+(1===sizeVec4Remainder)+") {\n          expSum += exp(getAFlat("+r1+") - finalMax);\n        } else if ("+(2===sizeVec4Remainder)+") {\n          vec2 aVec = vec2(getAFlat("+r1+"), getAFlat("+r2+"));\n          expSum += dot(ones2, exp(aVec - finalMax));\n        } else if ("+(3===sizeVec4Remainder)+") {\n          vec3 aVec = vec3(getAFlat("+r1+"), getAFlat("+r2+"), getAFlat("+r3+"));\n          expSum += dot(ones3, exp(aVec - finalMax));\n        }\n\n        setOutput(finalMax + log(expSum));\n      }\n    "}}();exports.LogSumExpProgram=LogSumExpProgram},{}],66:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MaxPool2DBackpropProgram=function(){return function(convInfo){this.variableNames=["dy","maxPos"],this.outputShape=convInfo.inShape;var dyRows=convInfo.outShape[0],dyCols=convInfo.outShape[1],filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left;this.params=[filterHeight,filterWidth,strideHeight,strideWidth,padTop,padLeft];var lastIndex=filterHeight*filterWidth-1;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int d = coords.z;\n\n        ivec2 dyRCCorner = coords.xy - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+dyRows+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+dyCols+".0 || fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(idyR, idyC, d);\n            int maxPosValue = "+lastIndex+" - int(getMaxPos(idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+filterWidth+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}}();exports.MaxPool2DBackpropProgram=MaxPool2DBackpropProgram},{}],67:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MinMaxProgram=function(){return function(size,op){this.variableNames=["A"],this.outputShape=[],this.params=[op];var sizeNearestVec4=4*Math.floor(size/4),sizeVec4Remainder=size%4,r1=sizeNearestVec4,r2=sizeNearestVec4+1,r3=sizeNearestVec4+2;this.userCode="\n      void main() {\n        vec4 bestVec = vec4(getAFlat(0));\n        for (int i = 0; i < "+sizeNearestVec4+"; i += 4) {\n          vec4 aVec = vec4(getAFlat(i), getAFlat(i+1),\n                           getAFlat(i+2), getAFlat(i+3));\n          if (hasNaN(aVec)) {\n            setOutput(getNaN(aVec));\n            return;\n          }\n          bestVec = "+op+"(bestVec, aVec);\n        }\n        vec4 aVec;\n        if ("+(1===sizeVec4Remainder)+") {\n          aVec = vec4(bestVec.xyz, getAFlat("+r1+"));\n        } else if ("+(2===sizeVec4Remainder)+") {\n          aVec = vec4(bestVec.xy, vec2(getAFlat("+r1+"), getAFlat("+r2+")));\n        } else if ("+(3===sizeVec4Remainder)+") {\n          aVec = vec4(bestVec.x,\n                      vec3(getAFlat("+r1+"), getAFlat("+r2+"), getAFlat("+r3+")));\n        }\n        if ("+(sizeVec4Remainder>0)+") {\n          if (hasNaN(aVec)) {\n            setOutput(getNaN(aVec));\n            return;\n          }\n          bestVec = "+op+"(bestVec, aVec);\n        }\n\n        float final = "+op+"(bestVec.x, "+op+"(bestVec.y,\n                      "+op+"(bestVec.z, bestVec.w)));\n        setOutput(final);\n      }\n    "}}();exports.MinMaxProgram=MinMaxProgram},{}],68:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var math_1=require("../math"),MatMulProgram=function(){return function(aShape,bShape,aOrient,bOrient){void 0===aOrient&&(aOrient=math_1.MatrixOrientation.REGULAR),void 0===bOrient&&(bOrient=math_1.MatrixOrientation.REGULAR),this.variableNames=["matrixA","matrixB"],this.params=[aOrient,bOrient];var outerShapeA=aOrient===math_1.MatrixOrientation.REGULAR?aShape[0]:aShape[1],outerShapeB=bOrient===math_1.MatrixOrientation.REGULAR?bShape[1]:bShape[0];this.outputShape=[outerShapeA,outerShapeB];var sharedDim=aOrient===math_1.MatrixOrientation.REGULAR?aShape[1]:aShape[0],aSnippetFromOffset=function(vec4Offset,indexVar){return aOrient===math_1.MatrixOrientation.REGULAR?"aRow, "+indexVar+" + "+vec4Offset:indexVar+" + "+vec4Offset+", aRow"},bSnippetFromOffset=function(vec4Offset,indexVar){return bOrient===math_1.MatrixOrientation.REGULAR?indexVar+" + "+vec4Offset+", bCol":"bCol, "+indexVar+" + "+vec4Offset},sharedDimNearestVec4=4*Math.floor(sharedDim/4),sharedDimVec4Remainder=sharedDim%4;this.userCode=" float dotARowBCol(int aRow, int bCol) {\n      float result = 0.0;\n      for (int i = 0; i < "+sharedDimNearestVec4+"; i += 4) {\n        vec4 a = vec4(\n          getMatrixA("+aSnippetFromOffset(0,"i")+"),\n          getMatrixA("+aSnippetFromOffset(1,"i")+"),\n          getMatrixA("+aSnippetFromOffset(2,"i")+"),\n          getMatrixA("+aSnippetFromOffset(3,"i")+")\n        );\n        vec4 b = vec4(\n          getMatrixB("+bSnippetFromOffset(0,"i")+"),\n          getMatrixB("+bSnippetFromOffset(1,"i")+"),\n          getMatrixB("+bSnippetFromOffset(2,"i")+"),\n          getMatrixB("+bSnippetFromOffset(3,"i")+")\n        );\n\n        result += dot(a, b);\n      }\n\n      if ("+(1===sharedDimVec4Remainder)+") {\n        result += getMatrixA("+aSnippetFromOffset(0,sharedDimNearestVec4)+") *\n          getMatrixB("+bSnippetFromOffset(0,sharedDimNearestVec4)+");\n      } else if ("+(2===sharedDimVec4Remainder)+") {\n        vec2 a = vec2(\n          getMatrixA("+aSnippetFromOffset(0,sharedDimNearestVec4)+"),\n          getMatrixA("+aSnippetFromOffset(1,sharedDimNearestVec4)+")\n        );\n        vec2 b = vec2(\n          getMatrixB("+bSnippetFromOffset(0,sharedDimNearestVec4)+"),\n          getMatrixB("+bSnippetFromOffset(1,sharedDimNearestVec4)+")\n        );\n        result += dot(a, b);\n      } else if ("+(3===sharedDimVec4Remainder)+") {\n        vec3 a = vec3(\n          getMatrixA("+aSnippetFromOffset(0,sharedDimNearestVec4)+"),\n          getMatrixA("+aSnippetFromOffset(1,sharedDimNearestVec4)+"),\n          getMatrixA("+aSnippetFromOffset(2,sharedDimNearestVec4)+")\n        );\n        vec3 b = vec3(\n          getMatrixB("+bSnippetFromOffset(0,sharedDimNearestVec4)+"),\n          getMatrixB("+bSnippetFromOffset(1,sharedDimNearestVec4)+"),\n          getMatrixB("+bSnippetFromOffset(2,sharedDimNearestVec4)+")\n        );\n        result += dot(a, b);\n      }\n\n      return result;\n    }\n\n    void main() {\n      ivec2 resRC = getOutputCoords();\n      setOutput(dotARowBCol(resRC.x, resRC.y));\n    }\n    "}}();exports.MatMulProgram=MatMulProgram},{"../math":48}],69:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MultinomialProgram=function(){function MultinomialProgram(numOutcomes,numSamples){this.variableNames=["probs"],this.outputShape=[numSamples],this.params=[],this.userCode="\n      uniform float seed;\n\n      void main() {\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(numOutcomes-1)+"; i++) {\n          cdf += getProbs(i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(numOutcomes-1)+"));\n      }\n    "}return MultinomialProgram.prototype.getCustomSetupFunc=function(seed){var _this=this;return function(gpgpu,webGLProgram){null==_this.seedLoc&&(_this.seedLoc=gpgpu.getUniformLocation(webGLProgram,"seed")),gpgpu.gl.uniform1f(_this.seedLoc,seed)}},MultinomialProgram}();exports.MultinomialProgram=MultinomialProgram},{}],70:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var OneHotProgram=function(){function OneHotProgram(numIndices,depth,onValue,offValue){this.variableNames=["indices"],this.outputShape=[numIndices,depth],this.params=[onValue,offValue],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+offValue+"), float("+onValue+"),\n                      float(index == coords.y)));\n      }\n    "}return OneHotProgram.prototype.getCustomSetupFunc=function(seed){var _this=this;return function(gpgpu,webGLProgram){null==_this.seedLoc&&(_this.seedLoc=gpgpu.getUniformLocation(webGLProgram,"seed")),gpgpu.gl.uniform1f(_this.seedLoc,seed)}},OneHotProgram}();exports.OneHotProgram=OneHotProgram},{}],71:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Pool2DProgram=function(){return function(convInfo,poolType,computePositions){if(this.variableNames=["x"],"avg"===poolType&&computePositions)throw new Error("Cannot compute positions for average pool.");var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,xNumRows=convInfo.inShape[0],xNumCols=convInfo.inShape[1],padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.params=[strideHeight,strideWidth,padLeft,padTop,poolType,computePositions],this.outputShape=convInfo.outShape;var isAvgPool="avg"===poolType,initializationValue="0.0";if(isAvgPool||(initializationValue="min"===poolType?"1.0 / 0.0":"-1.0 / 0.0"),computePositions){var compareOp_1="min"===poolType?"<=":">=";this.userCode="\n        const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n        const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n        void main() {\n          ivec3 coords = getOutputCoords();\n          int d = coords.z;\n\n          ivec2 xRCCorner = coords.xy * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+filterHeight+"; wR++) {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+xNumRows+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+filterWidth+"; wC++) {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+xNumCols+") {\n                continue;\n              }\n\n              float value = getX(xR, xC, d);\n\n              if (isNaN(value)) {\n                setOutput(value);\n                return;\n              }\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value "+compareOp_1+" currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+filterWidth+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      "}else{var compareOp="min"===poolType?"min":"max",returnValue=poolType+"("+poolType+"("+poolType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===poolType&&(returnValue="avgValue / "+filterHeight*filterWidth+".0");var filterWidthNearestVec4=4*Math.floor(filterWidth/4),filterWidthVec4Remainder=filterWidth%4,updateSnippet="\n      if (hasNaN(values)) {\n        setOutput(getNaN(values));\n        return;\n      }\n      if ("+isAvgPool+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = "+compareOp+"(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+xNumCols+") {\n          return initializationValue;\n        }\n        return getX(xR, xC, d);\n      }\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int d = coords.z;\n\n        ivec2 xRCCorner = coords.xy * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float avgValue = 0.0;\n\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+xNumRows+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidthNearestVec4+"; wC += 4) {\n            int xC = xCCorner + wC;\n\n            vec4 values = vec4(\n              getValue(xR, xC, d),\n              getValue(xR, xC + 1, d),\n              getValue(xR, xC + 2, d),\n              getValue(xR, xC + 3, d)\n            );\n\n            "+updateSnippet+"\n          }\n\n          int xC = xCCorner + "+filterWidthNearestVec4+";\n          if ("+(1===filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n            "+updateSnippet+"\n          } else if ("+(2===filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(xR, xC, d),\n              getValue(xR, xC + 1, d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          } else if ("+(3===filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(xR, xC, d),\n              getValue(xR, xC + 1, d),\n              getValue(xR, xC + 2, d),\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          }\n        }\n        setOutput("+returnValue+");\n      }\n    "}}}();exports.Pool2DProgram=Pool2DProgram},{}],72:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ReduceSumProgram=function(){return function(size){this.size=size,this.variableNames=["A"],this.params=[],this.outputShape=[];var sizeNearestVec4=4*Math.floor(size/4),sizeVec4Remainder=size%4,r1=sizeNearestVec4,r2=sizeNearestVec4+1,r3=sizeNearestVec4+2;this.userCode="\n      void main() {\n        const vec2 ones2 = vec2(1);\n        const vec3 ones3 = vec3(1);\n        const vec4 ones4 = vec4(1);\n\n        float sum = 0.0;\n        for (int i = 0; i < "+sizeNearestVec4+"; i += 4) {\n          vec4 aVec = vec4(getAFlat(i), getAFlat(i+1),\n                           getAFlat(i+2), getAFlat(i+3));\n          sum += dot(ones4, aVec);\n        }\n\n        if ("+(1===sizeVec4Remainder)+") {\n          sum += getAFlat("+r1+");\n        } else if ("+(2===sizeVec4Remainder)+") {\n          vec2 aVec = vec2(getAFlat("+r1+"), getAFlat("+r2+"));\n          sum += dot(ones2, aVec);\n        } else if ("+(3===sizeVec4Remainder)+") {\n          vec3 aVec = vec3(getAFlat("+r1+"), getAFlat("+r2+"), getAFlat("+r3+"));\n          sum += dot(ones3, aVec);\n        }\n\n        setOutput(sum);\n      }\n    "}}();exports.ReduceSumProgram=ReduceSumProgram},{}],73:[function(require,module,exports){"use strict";function renderToFramebuffer(gpgpu,renderShader,sourceTex){gpgpu.setProgram(renderShader);var sourceSamplerLocation=webgl_util.getProgramUniformLocationOrThrow(gpgpu.gl,renderShader,"source");gpgpu.setInputMatrixTexture(sourceTex,sourceSamplerLocation,0),gpgpu.executeProgram()}Object.defineProperty(exports,"__esModule",{value:!0});var webgl_util=require("./webgl_util");exports.getRenderRGBShader=function(gpgpu,destinationWidth){var fragmentShaderSource="\n    precision highp float;\n    uniform sampler2D source;\n    varying vec2 resultUV;\n\n    const float destinationWidth = "+destinationWidth+".0;\n    const float a = 1.0;\n\n    void main() {\n      float xr = floor(resultUV.s * destinationWidth) * 3.0;\n      vec3 x = xr + vec3(0, 1, 2);\n\n      float sourceWidth = destinationWidth * 3.0;\n      vec3 u = (x + 0.5) / sourceWidth;\n      float v = 1.0 - resultUV.t;\n\n      float r = texture2D(source, vec2(u[0], v)).r;\n      float g = texture2D(source, vec2(u[1], v)).r;\n      float b = texture2D(source, vec2(u[2], v)).r;\n\n      gl_FragColor = vec4(r, g, b, a);\n    }";return gpgpu.createProgram(fragmentShaderSource)},exports.renderToCanvas=function(gpgpu,renderShader,sourceTex){webgl_util.bindCanvasToFramebuffer(gpgpu.gl),renderToFramebuffer(gpgpu,renderShader,sourceTex)},exports.renderToFramebuffer=renderToFramebuffer},{"./webgl_util":80}],74:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ResizeBilinear3DProgram=function(){return function(inputShape,outputDimensionsRowCol,alignCorners){this.variableNames=["A"],this.params=[],this.outputShape=[];var depth=inputShape[2];this.outputShape=[outputDimensionsRowCol[0],outputDimensionsRowCol[1],depth],this.params=[alignCorners];var effectiveInputShape=alignCorners?[inputShape[0]-1,inputShape[1]-1,depth]:inputShape,effectiveOutputShape=alignCorners?[this.outputShape[0]-1,this.outputShape[1]-1,depth]:this.outputShape;this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+effectiveInputShape[0]/effectiveOutputShape[0]+",\n          "+effectiveInputShape[1]/effectiveOutputShape[1]+");\n      const vec2 inputShapeRC = vec2("+inputShape[0]+".0, "+inputShape[1]+".0);\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        ivec2 yRC = coords.xy;\n        int d = coords.z;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "}}();exports.ResizeBilinear3DProgram=ResizeBilinear3DProgram},{}],75:[function(require,module,exports){"use strict";function getInputSamplingSnippet(inInfo,outShapeInfo,broadcast){var shape=inInfo.shapeInfo.logicalShape,texShape=inInfo.shapeInfo.texShape,outTexShape=outShapeInfo.texShape,res="";switch(shape.length){case 0:res+=getSamplerScalar(inInfo.name);break;case 1:res+=getSampler1D(inInfo.name,texShape);break;case 2:res+=getSampler2D(inInfo.name,shape,texShape);break;case 3:res+=getSampler3D(inInfo.name,shape,texShape);break;case 4:res+=getSampler4D(inInfo.name,shape,texShape);break;default:throw new Error(shape.length+"-D input sampling is not yet supported")}return(broadcast||util.arraysEqual(inInfo.shapeInfo.logicalShape,outShapeInfo.logicalShape))&&(res+=getSamplerAtOutputCoords(inInfo.name,texShape,outTexShape,broadcast)),res+=getSamplerFlat(inInfo.name,texShape)}function getOutputSamplingSnippet(outShape,outTexShape){switch(outShape.length){case 0:return"";case 1:return getOutput1DCoords(outShape,outTexShape);case 2:return getOutput2DCoords(outShape,outTexShape);case 3:return getOutput3DCoords(outShape,outTexShape);case 4:return getOutput4DCoords(outShape,outTexShape);default:throw new Error(outShape.length+"-D output sampling is not yet supported")}}function getOutput1DCoords(shape,texShape){return 1===texShape[0]?"\n      int getOutputCoords() {\n        return int(gl_FragCoord.x);\n      }\n    ":1===texShape[1]?"\n      int getOutputCoords() {\n        return int(gl_FragCoord.y);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(gl_FragCoord.yx);\n      return resTexRC.x * "+texShape[1]+" + resTexRC.y;\n    }\n  "}function getOutput3DCoords(shape,texShape){var stride0=shape[1]*shape[2],stride1=shape[2];return"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(gl_FragCoord.yx);\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      int r = index / "+stride0+";\n      index -= r * "+stride0+";\n      int c = index / "+stride1+";\n      int d = index - c * "+stride1+";\n      return ivec3(r, c, d);\n    }\n  "}function getOutput4DCoords(shape,texShape){var stride2=shape[3],stride1=shape[2]*stride2,stride0=shape[1]*stride1;return"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(gl_FragCoord.yx);\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n\n      int r = index / "+stride0+";\n      index -= r * "+stride0+";\n\n      int c = index / "+stride1+";\n      index -= c * "+stride1+";\n\n      int d = index / "+stride2+";\n      int d2 = index - d * "+stride2+";\n\n      return ivec4(r, c, d, d2);\n    }\n  "}function getOutput2DCoords(shape,texShape){return util.arraysEqual(shape,texShape)?"\n      ivec2 getOutputCoords() {\n        return ivec2(gl_FragCoord.yx);\n      }\n    ":1===shape[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(gl_FragCoord.yx);\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===shape[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(gl_FragCoord.yx);\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(gl_FragCoord.yx);\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      int r = index / "+shape[1]+";\n      int c = index - r * "+shape[1]+";\n      return ivec2(r, c);\n    }\n  "}function getSamplerScalar(texName){return"\n    float "+("get"+texName.charAt(0).toUpperCase()+texName.slice(1))+"() {\n      return sample("+texName+", halfCR);\n    }\n  "}function getSampler1D(texName,texShape){var funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),tR=texShape[0],tC=texShape[1];return 1===texShape[0]&&1===texShape[1]?"\n      float "+funcName+"(int index) {\n        return sample("+texName+", halfCR);\n      }\n    ":1===texShape[1]?"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2(0.5, (float(index) + 0.5) / "+tR+".0);\n        return sample("+texName+", uv);\n      }\n    ":1===texShape[0]?"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2((float(index) + 0.5) / "+tC+".0, 0.5);\n        return sample("+texName+", uv);\n      }\n    ":"\n    float "+funcName+"(int index) {\n      vec2 uv = UVfrom1D("+tR+", "+tC+", index);\n      return sample("+texName+", uv);\n    }\n  "}function getSampler3D(texName,shape,texShape){var funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),tR=texShape[0],tC=texShape[1],stride0=shape[1]*shape[2],stride1=shape[2];return tC===stride0?"\n      float "+funcName+"(int row, int col, int depth) {\n        int texR = row;\n        int texC = col * "+stride1+" + depth;\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+tC+".0, "+tR+".0);\n        return sample("+texName+", uv);\n      }\n    ":"\n    float "+funcName+"(int row, int col, int depth) {\n      vec2 uv = UVfrom3D("+tR+", "+tC+", "+stride0+", "+stride1+", row, col, depth);\n      return sample("+texName+", uv);\n    }\n  "}function getSampler4D(texName,shape,texShape){var funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),tR=texShape[0],tC=texShape[1],stride2=shape[3],stride1=shape[2]*stride2,stride0=shape[1]*stride1;return tC===stride0?"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        int texR = row;\n        int texC = col * "+stride1+" + depth * "+stride2+" + depth2;\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+tC+".0, "+tR+".0);\n        return sample("+texName+", uv);\n      }\n    ":"\n    float "+funcName+"(int row, int col, int depth, int depth2) {\n      vec2 uv = UVfrom4D("+tR+", "+tC+", "+stride0+", "+stride1+", "+stride2+",\n          row, col, depth, depth2);\n      return sample("+texName+", uv);\n    }\n  "}function getSampler2D(texName,shape,texShape){var funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),tR=texShape[0],tC=texShape[1];return util.arraysEqual(shape,texShape)?"\n      float "+funcName+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+tC+".0, "+tR+".0);\n        return sample("+texName+", uv);\n      }\n    ":1===tC?1===shape[0]?"\n        float "+funcName+"(int row, int col) {\n          vec2 uv = vec2(0.5, (float(col) + 0.5) / "+tR+".0);\n          return sample("+texName+", uv);\n        }\n      ":1===shape[1]?"\n        float "+funcName+"(int row, int col) {\n          vec2 uv = vec2(0.5, (float(row) + 0.5) / "+tR+".0);\n          return sample("+texName+", uv);\n        }\n      ":"\n      float "+funcName+"(int row, int col) {\n        int index = row * "+shape[1]+" + col;\n        vec2 uv = vec2(0.5, (float(index) + 0.5) / "+tR+".0);\n        return sample("+texName+", uv);\n      }\n    ":1===tR?"\n      float "+funcName+"(int row, int col) {\n        int index = row * "+shape[1]+" + col;\n        vec2 uv = vec2((float(index) + 0.5) / "+tC+".0, 0.5);\n        return sample("+texName+", uv);\n      }\n    ":"\n    float "+funcName+"(int row, int col) {\n      vec2 uv = UVfrom2D("+tR+", "+tC+", "+shape[1]+", row, col);\n      return sample("+texName+", uv);\n    }\n  "}function getSamplerFlat(texName,texShape){var funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1)+"Flat",tNumR=texShape[0],tNumC=texShape[1];return 1===tNumC&&1===tNumR?"\n      float "+funcName+"(int index) {\n        return sample("+texName+", halfCR);\n      }\n    ":1===tNumC?"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2(0.5, (float(index) + 0.5) / "+tNumR+".0);\n        return sample("+texName+", uv);\n      }\n    ":1===tNumR?"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2((float(index) + 0.5) / "+tNumC+".0, 0.5);\n        return sample("+texName+", uv);\n      }\n    ":"\n    float "+funcName+"(int index) {\n      int texR = index / "+tNumC+";\n      int texC = index - texR * "+tNumC+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+tNumC+".0, "+tNumR+".0);\n      return sample("+texName+", uv);\n    }\n  "}function getSamplerAtOutputCoords(texName,inTexShape,outTexShape,broadcast){var funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1)+"AtOutCoords";if(util.arraysEqual(inTexShape,outTexShape))return"\n      float "+funcName+"() {\n        return sample("+texName+", resultUV);\n      }\n    ";var inSize=util.sizeFromShape(inTexShape),broadcastSnippet="";return broadcast&&(broadcastSnippet="\n      int mainPart = index / "+inSize+";\n      index -= mainPart * "+inSize+";\n    "),"\n    float "+funcName+"() {\n      ivec2 resTexRC = ivec2(gl_FragCoord.yx);\n      int index = resTexRC.x * "+outTexShape[1]+" + resTexRC.y;\n      "+broadcastSnippet+"\n      int texR = index / "+inTexShape[1]+";\n      int texC = index - texR * "+inTexShape[1]+";\n      vec2 uv = (vec2(texC, texR) + halfCR) /\n                 vec2("+inTexShape[1]+".0, "+inTexShape[0]+".0);\n      return sample("+texName+", uv);\n    }\n  "}Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util");exports.makeShader=function(inputsInfo,outputShape,userCode,broadcast){var inputPrefixSnippet=inputsInfo.map(function(x){return"uniform sampler2D "+x.name+";"}).join("\n"),inputSamplingSnippet=inputsInfo.map(function(x){return getInputSamplingSnippet(x,outputShape,broadcast)}).join("\n"),outTexShape=outputShape.texShape,outputSamplingSnippet=getOutputSamplingSnippet(outputShape.logicalShape,outTexShape);return[SHADER_PREFIX,inputPrefixSnippet,inputSamplingSnippet,outputSamplingSnippet,userCode].join("\n")};var SHADER_PREFIX="\n  precision highp float;\n  varying vec2 resultUV;\n  const vec2 halfCR = vec2(0.5, 0.5);\n\n  float sample(sampler2D texture, vec2 uv) {\n    return texture2D(texture, uv).r;\n  }\n\n  void setOutput(float val) {\n    gl_FragColor = vec4(val, 0, 0, 0);\n  }\n\n  bool isNaN(float val) {\n    return val == val ? false : true;\n  }\n\n  bool hasNaN(vec4 values) {\n    return any(notEqual(values, values));\n  }\n\n  float getNaN(vec4 values) {\n    return dot(vec4(1), values);\n  }\n\n  int round(float value) {\n    return int(floor(value + 0.5));\n  }\n\n  const vec2 randomConst = vec2(\n    23.14069263277926, // e^pi (Gelfond's constant)\n     2.665144142690225 // 2^sqrt(2) (Gelfond–Schneider constant)\n  );\n\n  float random(float seed) {\n      return fract(cos(dot(resultUV * seed, randomConst)) * 12345.6789);\n  }\n\n  \nvec2 UVfrom1D(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n  \nvec2 UVfrom2D(int texNumR, int texNumC, int numC, int row, int col) {\n  int index = row * numC + col;\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n  \nvec2 UVfrom3D(int texNumR, int texNumC, int stride0,\n    int stride1, int row, int col, int depth) {\n  int index = row * stride0 + col * stride1 + depth;\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n  \nvec2 UVfrom4D(int texNumR, int texNumC, int stride0,\n    int stride1, int stride2, int row, int col, int depth,\n    int depth2) {\n  int index = row * stride0 + col * stride1 + depth * stride2 + depth2;\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n"},{"../../util":82}],76:[function(require,module,exports){"use strict";function getCoords(rank){if(1===rank)return"sourceLoc";if(2===rank)return"sourceLoc.x, sourceLoc.y";if(3===rank)return"sourceLoc.x, sourceLoc.y, sourceLoc.z";if(4===rank)return"sourceLoc.x, sourceLoc.y, sourceLoc.z, sourceLoc.w";throw Error("Slicing for rank "+rank+" is not yet supported")}function getDataType(rank){if(1===rank)return"int";if(2===rank)return"ivec2";if(3===rank)return"ivec3";if(4===rank)return"ivec4";throw Error("Slicing for rank "+rank+" is not yet supported")}Object.defineProperty(exports,"__esModule",{value:!0});var SliceProgram=function(){function SliceProgram(destSize){this.variableNames=["source"],this.outputShape=destSize,this.rank=destSize.length,this.params=[];var dtype=getDataType(this.rank),sourceCoords=getCoords(this.rank);this.userCode="\n      uniform "+dtype+" start;\n\n      void main() {\n        "+dtype+" sourceLoc = start + getOutputCoords();\n        setOutput(getSource("+sourceCoords+"));\n      }\n    "}return SliceProgram.prototype.getCustomSetupFunc=function(start){var _this=this;if(start.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+start.length+")");return function(gpgpu,webGLProgram){if(null!=_this.startLoc||(_this.startLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"start"),null!=_this.startLoc))if(1===_this.rank)gpgpu.gl.uniform1i(_this.startLoc,start[0]);else if(2===_this.rank)gpgpu.gl.uniform2i(_this.startLoc,start[0],start[1]);else if(3===_this.rank)gpgpu.gl.uniform3i(_this.startLoc,start[0],start[1],start[2]);else{if(4!==_this.rank)throw Error("Slicing for rank "+_this.rank+" is not yet supported");gpgpu.gl.uniform4i(_this.startLoc,start[0],start[1],start[2],start[3])}}},SliceProgram}();exports.SliceProgram=SliceProgram},{}],77:[function(require,module,exports){"use strict";function getUnpackedArraySizeFromMatrixSize(matrixSize,channelsPerTexture){return matrixSize*channelsPerTexture}function getMatrixSizeFromUnpackedArraySize(unpackedSize,channelsPerTexture){if(unpackedSize%channelsPerTexture!=0)throw new Error("unpackedSize ("+unpackedSize+") must be a multiple of "+channelsPerTexture);return unpackedSize/channelsPerTexture}function getPackedMatrixTextureShapeWidthHeight(rows,columns){return[Math.ceil(columns/2),Math.ceil(rows/2)]}function getPackedRGBAArraySizeFromMatrixShape(rows,columns){var _a=getPackedMatrixTextureShapeWidthHeight(rows,columns);return _a[0]*_a[1]*4}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getUnpackedMatrixTextureShapeWidthHeight=function(rows,columns){return[columns,rows]},exports.getUnpackedArraySizeFromMatrixSize=getUnpackedArraySizeFromMatrixSize,exports.getColorMatrixTextureShapeWidthHeight=function(rows,columns){return[4*columns,rows]},exports.getMatrixSizeFromUnpackedArraySize=getMatrixSizeFromUnpackedArraySize,exports.encodeMatrixToUnpackedArray=function(matrix,unpackedArray,channelsPerTexture){var requiredSize=getUnpackedArraySizeFromMatrixSize(matrix.length,channelsPerTexture);if(unpackedArray.length<requiredSize)throw new Error("unpackedArray length ("+unpackedArray.length+") must be >= "+requiredSize);for(var dst=0,src=0;src<matrix.length;++src)unpackedArray[dst]=matrix[src],dst+=channelsPerTexture},exports.decodeMatrixFromUnpackedArray=function(unpackedArray,matrix,channelsPerTexture){var requiredSize=getMatrixSizeFromUnpackedArraySize(unpackedArray.length,channelsPerTexture);if(matrix.length<requiredSize)throw new Error("matrix length ("+matrix.length+") must be >= "+requiredSize);for(var dst=0,src=0;src<unpackedArray.length;src+=channelsPerTexture)matrix[dst++]=unpackedArray[src]},exports.getPackedMatrixTextureShapeWidthHeight=getPackedMatrixTextureShapeWidthHeight,exports.getPackedRGBAArraySizeFromMatrixShape=getPackedRGBAArraySizeFromMatrixShape,exports.encodeMatrixToPackedRGBA=function(matrix,rows,columns,packedRGBA){var requiredSize=getPackedRGBAArraySizeFromMatrixShape(rows,columns);if(packedRGBA.length<requiredSize)throw new Error("packedRGBA length ("+packedRGBA.length+") must be >= "+requiredSize);for(var _a=getPackedMatrixTextureShapeWidthHeight(rows,columns),textureWidth=_a[0],textureHeight=_a[1],oddWidth=columns%2==1,oddHeight=rows%2==1,widthInFullBlocks=Math.floor(columns/2),heightInFullBlocks=Math.floor(rows/2),dstStride=oddWidth?4:0,oneRow=columns,dst=0,blockY=0;blockY<heightInFullBlocks;++blockY){for(var matrixSrcRow=2*blockY*columns,blockX=0;blockX<widthInFullBlocks;++blockX)src=matrixSrcRow+2*blockX,packedRGBA[dst]=matrix[src],packedRGBA[dst+1]=matrix[src+1],packedRGBA[dst+2]=matrix[src+oneRow],packedRGBA[dst+3]=matrix[src+oneRow+1],dst+=4;dst+=dstStride}if(oddWidth)for(var src=columns-1,dst=4*(textureWidth-1),srcStride=2*columns,dstStride=4*textureWidth,blockY=0;blockY<heightInFullBlocks;++blockY)packedRGBA[dst]=matrix[src],packedRGBA[dst+2]=matrix[src+columns],src+=srcStride,dst+=dstStride;if(oddHeight)for(var src=(rows-1)*columns,dst=(textureHeight-1)*textureWidth*4,blockX=0;blockX<widthInFullBlocks;++blockX)packedRGBA[dst++]=matrix[src++],packedRGBA[dst++]=matrix[src++],dst+=2;return oddWidth&&oddHeight&&(packedRGBA[packedRGBA.length-4]=matrix[matrix.length-1]),packedRGBA},exports.decodeMatrixFromPackedRGBA=function(packedRGBA,rows,columns,matrix){var requiredSize=rows*columns;if(requiredSize<matrix.length)throw new Error("matrix length ("+matrix.length+") must be >= "+requiredSize);for(var oddWidth=columns%2==1,oddHeight=rows%2==1,widthInFullBlocks=Math.floor(columns/2),heightInFullBlocks=Math.floor(rows/2),_a=getPackedMatrixTextureShapeWidthHeight(rows,columns),textureWidth=_a[0],textureHeight=_a[1],srcStride=oddWidth?4:0,dstStride=columns+(oddWidth?1:0),src=0,dstRow1=0,dstRow2=columns,blockY=0;blockY<heightInFullBlocks;++blockY){for(blockX=0;blockX<widthInFullBlocks;++blockX)matrix[dstRow1++]=packedRGBA[src++],matrix[dstRow1++]=packedRGBA[src++],matrix[dstRow2++]=packedRGBA[src++],matrix[dstRow2++]=packedRGBA[src++];src+=srcStride,dstRow1+=dstStride,dstRow2+=dstStride}if(oddWidth)for(var src=4*(textureWidth-1),dst=columns-1,srcStride=4*textureWidth,dstStride=2*columns,blockY=0;blockY<heightInFullBlocks;++blockY)matrix[dst]=packedRGBA[src],matrix[dst+columns]=packedRGBA[src+2],src+=srcStride,dst+=dstStride;if(oddHeight)for(var src=(textureHeight-1)*textureWidth*4,dst=(rows-1)*columns,blockX=0;blockX<widthInFullBlocks;++blockX)matrix[dst++]=packedRGBA[src++],matrix[dst++]=packedRGBA[src++],src+=2;return oddWidth&&oddHeight&&(matrix[matrix.length-1]=packedRGBA[packedRGBA.length-4]),matrix}},{}],78:[function(require,module,exports){"use strict";function getKeyFromTextureShape(shapeRowsCol){return shapeRowsCol[0]+"_"+shapeRowsCol[1]}Object.defineProperty(exports,"__esModule",{value:!0});var TextureManager=function(){function TextureManager(gpgpu){this.gpgpu=gpgpu,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextureCount={}}return TextureManager.prototype.acquireTexture=function(shapeRC){var shapeKey=getKeyFromTextureShape(shapeRC);return shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),shapeKey in this.usedTextureCount||(this.usedTextureCount[shapeKey]=0),this.usedTextureCount[shapeKey]++,this.freeTextures[shapeKey].length>0?(this.numFreeTextures--,this.numUsedTextures++,this.log(),this.freeTextures[shapeKey].shift()):(this.numUsedTextures++,this.log(),this.gpgpu.createMatrixTexture(shapeRC[0],shapeRC[1]))},TextureManager.prototype.releaseTexture=function(texture,shape){var shapeKey=getKeyFromTextureShape(shape);shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),this.freeTextures[shapeKey].push(texture),this.numFreeTextures++,this.numUsedTextures--,this.usedTextureCount[shapeKey]--,this.log()},TextureManager.prototype.log=function(){if(this.logEnabled){var total=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+total+")")}},TextureManager.prototype.getNumUsedTextures=function(){return this.numUsedTextures},TextureManager.prototype.getNumFreeTextures=function(){return this.numFreeTextures},TextureManager.prototype.dispose=function(){for(var shape in this.freeTextures)if(this.freeTextures.hasOwnProperty(shape))for(var i=0;i<this.freeTextures[shape].length;i++)this.gpgpu.deleteMatrixTexture(this.freeTextures[shape][i])},TextureManager}();exports.TextureManager=TextureManager},{}],79:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var UnaryOpProgram=function(){return function(aShape,opSnippet){this.variableNames=["A"],this.outputShape=aShape,this.params=[opSnippet],this.userCode="\n      float unaryOperation(float x) {\n        "+opSnippet+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}}();exports.UnaryOpProgram=UnaryOpProgram,exports.CHECK_NAN_SNIPPET="\n  if (isNaN(x)) {\n    return x;\n  }\n",exports.ABS="\n  return abs(x);\n",exports.RELU="\n  return (x < 0.0) ? 0.0 : x;\n",exports.STEP="\n  return (x == x) ? (x > 0.0 ? 1.0 : 0.0) : x;\n",exports.NEG="\n  return -x;\n",exports.EXP="\n  return exp(x);\n",exports.LOG="\n  return log(x);\n",exports.SQRT=exports.CHECK_NAN_SNIPPET+"\n  return sqrt(x);\n",exports.SIGMOID="\n  return 1.0 / (1.0 + exp(-1.0 * x));\n",exports.SIN=exports.CHECK_NAN_SNIPPET+"\n  return sin(x);\n",exports.COS=exports.CHECK_NAN_SNIPPET+"\n  return cos(x);\n",exports.TAN="\n  return tan(x);\n",exports.ASIN=exports.CHECK_NAN_SNIPPET+"\n  return asin(x);\n",exports.ACOS=exports.CHECK_NAN_SNIPPET+"\n  return acos(x);\n",exports.ATAN=exports.CHECK_NAN_SNIPPET+"\n  return atan(x);\n",exports.SINH="\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n",exports.COSH="\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n",exports.TANH="\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n"},{}],80:[function(require,module,exports){"use strict";function createWebGLRenderingContextFromCanvas(canvas,attributes){var gl,webglVersion=environment_1.ENV.get("WEBGL_VERSION");if(2===webglVersion?gl=canvas.getContext("webgl2",attributes):1===webglVersion&&(gl=canvas.getContext("webgl",attributes)||canvas.getContext("experimental-webgl",attributes)),0===webglVersion||null==gl)throw new Error("This browser does not support WebGL.");return gl}function callAndCheck(gl,func){var returnValue=func();return checkWebGLError(gl),returnValue}function checkWebGLError(gl){if(webGLDebugErrorCheckingEnabled){var error=gl.getError();if(error!==gl.NO_ERROR)throw new Error("WebGL Error: "+getWebGLErrorMessage(gl,error))}}function getWebGLErrorMessage(gl,status){switch(status){case gl.NO_ERROR:return"NO_ERROR";case gl.INVALID_ENUM:return"INVALID_ENUM";case gl.INVALID_VALUE:return"INVALID_VALUE";case gl.INVALID_OPERATION:return"INVALID_OPERATION";case gl.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case gl.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case gl.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+status}}function logShaderSourceAndInfoLog(shaderSource,shaderInfoLog){var lineNumberRegexResult=lineNumberRegex.exec(shaderInfoLog);if(null==lineNumberRegexResult)return console.log("Couldn't parse line number in error: "+shaderInfoLog),void console.log(shaderSource);for(var lineNumber=+lineNumberRegexResult[1],shaderLines=shaderSource.split("\n"),pad=(""+shaderLines.length).length+2,linesWithLineNumbers=shaderLines.map(function(line,lineNumber){return util.rightPad(""+(lineNumber+1),pad)+line}),maxLineLength=0,i=0;i<linesWithLineNumbers.length;i++)maxLineLength=Math.max(linesWithLineNumbers[i].length,maxLineLength);var beforeErrorLines=linesWithLineNumbers.slice(0,lineNumber-1),errorLine=linesWithLineNumbers.slice(lineNumber-1,lineNumber),afterErrorLines=linesWithLineNumbers.slice(lineNumber);console.log(beforeErrorLines.join("\n")),console.log(shaderInfoLog.split("\n")[0]),console.log("%c "+util.rightPad(errorLine[0],maxLineLength),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(afterErrorLines.join("\n"))}function queryMaxTextureSize(gl){return null!=MAX_TEXTURE_SIZE?MAX_TEXTURE_SIZE:MAX_TEXTURE_SIZE=callAndCheck(gl,function(){return gl.getParameter(gl.MAX_TEXTURE_SIZE)})}function bindTextureUnit(gl,texture,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)}),callAndCheck(gl,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)})}function getFramebufferErrorMessage(gl,status){switch(status){case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case gl.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+status}}function throwIfNull(gl,returnTOrNull,failureMessage){var tOrNull=callAndCheck(gl,function(){return returnTOrNull()});if(null==tOrNull)throw new Error(failureMessage);return tOrNull}function validateTextureUnit(gl,textureUnit){var maxTextureUnit=gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,glTextureUnit=textureUnit+gl.TEXTURE0;if(glTextureUnit<gl.TEXTURE0||glTextureUnit>maxTextureUnit){var textureUnitRange="[gl.TEXTURE0, gl.TEXTURE"+maxTextureUnit+"]";throw new Error("textureUnit must be in "+textureUnitRange+".")}}Object.defineProperty(exports,"__esModule",{value:!0});var MAX_TEXTURE_SIZE=null,util=require("../../util"),environment_1=require("../../environment");exports.createWebGLRenderingContext=function(attributes){var canvas=document.createElement("canvas");return canvas.width=1,canvas.height=1,createWebGLRenderingContextFromCanvas(canvas,attributes)},exports.createWebGLRenderingContextFromCanvas=createWebGLRenderingContextFromCanvas,exports.callAndCheck=callAndCheck;var webGLDebugErrorCheckingEnabled=!1;exports.enableDebugWebGLErrorChecking=function(enabled){webGLDebugErrorCheckingEnabled=enabled},exports.checkWebGLError=checkWebGLError,exports.getWebGLErrorMessage=getWebGLErrorMessage,exports.getExtensionOrThrow=function(gl,extensionName){return throwIfNull(gl,function(){return gl.getExtension(extensionName)},'Extension "'+extensionName+'" not supported on this browser.')},exports.createVertexShader=function(gl,vertexShaderSource){var vertexShader=throwIfNull(gl,function(){return gl.createShader(gl.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(callAndCheck(gl,function(){return gl.shaderSource(vertexShader,vertexShaderSource)}),callAndCheck(gl,function(){return gl.compileShader(vertexShader)}),!1===gl.getShaderParameter(vertexShader,gl.COMPILE_STATUS))throw console.log(gl.getShaderInfoLog(vertexShader)),new Error("Failed to compile vertex shader.");return vertexShader},exports.createFragmentShader=function(gl,fragmentShaderSource){var fragmentShader=throwIfNull(gl,function(){return gl.createShader(gl.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(callAndCheck(gl,function(){return gl.shaderSource(fragmentShader,fragmentShaderSource)}),callAndCheck(gl,function(){return gl.compileShader(fragmentShader)}),!1===gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS))throw logShaderSourceAndInfoLog(fragmentShaderSource,gl.getShaderInfoLog(fragmentShader)),new Error("Failed to compile fragment shader.");return fragmentShader};var lineNumberRegex=/ERROR: [0-9]+:([0-9]+):/g;exports.createProgram=function(gl){return throwIfNull(gl,function(){return gl.createProgram()},"Unable to create WebGLProgram.")},exports.linkProgram=function(gl,program){if(callAndCheck(gl,function(){return gl.linkProgram(program)}),!1===gl.getProgramParameter(program,gl.LINK_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Failed to link vertex and fragment shaders.")},exports.validateProgram=function(gl,program){if(callAndCheck(gl,function(){return gl.validateProgram(program)}),!1===gl.getProgramParameter(program,gl.VALIDATE_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Shader program validation failed.")},exports.createStaticVertexBuffer=function(gl,data){var buffer=throwIfNull(gl,function(){return gl.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(gl,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)}),callAndCheck(gl,function(){return gl.bufferData(gl.ARRAY_BUFFER,data,gl.STATIC_DRAW)}),buffer},exports.createStaticIndexBuffer=function(gl,data){var buffer=throwIfNull(gl,function(){return gl.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(gl,function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffer)}),callAndCheck(gl,function(){return gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,data,gl.STATIC_DRAW)}),buffer},exports.queryMaxTextureSize=queryMaxTextureSize,exports.getChannelsPerTexture=function(){return 2===environment_1.ENV.get("WEBGL_VERSION")?1:4},exports.createTexture=function(gl){return throwIfNull(gl,function(){return gl.createTexture()},"Unable to create WebGLTexture.")},exports.validateTextureSize=function(gl,width,height){var maxTextureSize=queryMaxTextureSize(gl);if(width<=0||height<=0)throw requested="["+width+"x"+height+"]",new Error("Requested texture size "+requested+" is invalid.");if(width>maxTextureSize||height>maxTextureSize){var requested="["+width+"x"+height+"]",max="["+maxTextureSize+"x"+maxTextureSize+"]";throw new Error("Requested texture size "+requested+" greater than WebGL maximum on this browser / GPU "+max+".")}},exports.createFramebuffer=function(gl){return throwIfNull(gl,function(){return gl.createFramebuffer()},"Unable to create WebGLFramebuffer.")},exports.bindVertexBufferToProgramAttribute=function(gl,program,attribute,buffer,arrayEntriesPerItem,itemStrideInBytes,itemOffsetInBytes,attribLocations){var loc=-1;-1!==(loc=null!=attribLocations&&attribute in attribLocations?attribLocations[attribute]:gl.getAttribLocation(program,attribute))&&(callAndCheck(gl,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)}),callAndCheck(gl,function(){return gl.vertexAttribPointer(loc,arrayEntriesPerItem,gl.FLOAT,!1,itemStrideInBytes,itemOffsetInBytes)}),callAndCheck(gl,function(){return gl.enableVertexAttribArray(loc)}))},exports.bindTextureUnit=bindTextureUnit,exports.unbindTextureUnit=function(gl,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)}),callAndCheck(gl,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.getProgramUniformLocationOrThrow=function(gl,program,uniformName){return throwIfNull(gl,function(){return gl.getUniformLocation(program,uniformName)},'uniform "'+uniformName+'" not present in program.')},exports.bindTextureToProgramUniformSampler=function(gl,program,texture,uniformSamplerLocation,textureUnit){callAndCheck(gl,function(){return bindTextureUnit(gl,texture,textureUnit)}),callAndCheck(gl,function(){return gl.uniform1i(uniformSamplerLocation,textureUnit)})},exports.bindCanvasToFramebuffer=function(gl){callAndCheck(gl,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)}),callAndCheck(gl,function(){return gl.viewport(0,0,gl.canvas.width,gl.canvas.height)}),callAndCheck(gl,function(){return gl.scissor(0,0,gl.canvas.width,gl.canvas.height)})},exports.bindColorTextureToFramebuffer=function(gl,texture,framebuffer){callAndCheck(gl,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)}),callAndCheck(gl,function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0)})},exports.unbindColorTextureFromFramebuffer=function(gl,framebuffer){callAndCheck(gl,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)}),callAndCheck(gl,function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,null,0)})},exports.validateFramebuffer=function(gl){var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(status!==gl.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+getFramebufferErrorMessage(gl,status))},exports.getFramebufferErrorMessage=getFramebufferErrorMessage,exports.getTextureShapeFromLogicalShape=function(gl,logShape,preferredTexShape){var maxTexSize=queryMaxTextureSize(gl),size=util.sizeFromShape(logShape);if(null!=preferredTexShape){var sizePreferred=util.sizeFromShape(preferredTexShape);if(util.assert(size===sizePreferred,"Size of shape ("+size+") must match size of preferredShape ("+sizePreferred+")"),preferredTexShape[0]<=maxTexSize&&preferredTexShape[1]<=maxTexSize)return preferredTexShape}return logShape.length<=1&&size<=maxTexSize?[size,1]:2===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]<=maxTexSize?logShape:3===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]<=maxTexSize?[logShape[0],logShape[1]*logShape[2]]:4===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]*logShape[3]<=maxTexSize?[logShape[0],logShape[1]*logShape[2]*logShape[3]]:util.sizeToSquarishShape(size)}},{"../../environment":7,"../../util":82}],81:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var EPSILON=1e-4;exports.expectArraysClose=function(actual,expected,epsilon){if(void 0===epsilon&&(epsilon=EPSILON),actual.length!==expected.length)throw new Error("Matrices have different lengths ("+actual.length+" vs "+expected.length+").");for(var i=0;i<expected.length;++i){var a=actual[i],e=expected[i];if((!isNaN(a)||!isNaN(e))&&(isNaN(a)||isNaN(e)||Math.abs(a-e)>epsilon)){var actualStr="actual["+i+"] === "+a,expectedStr="expected["+i+"] === "+e;throw new Error("Arrays differ: "+actualStr+", "+expectedStr)}}},exports.randomArrayInRange=function(n,minValue,maxValue){for(var v=new Float32Array(n),range=maxValue-minValue,i=0;i<n;++i)v[i]=Math.random()*range+minValue;return v},exports.makeIdentity=function(n){for(var i=new Float32Array(n*n),j=0;j<n;++j)i[j*n+j]=1;return i},exports.setValue=function(m,mNumRows,mNumCols,v,row,column){if(row>=mNumRows)throw new Error("row ("+row+") must be in [0 "+mNumRows+"].");if(column>=mNumCols)throw new Error("column ("+column+") must be in [0 "+mNumCols+"].");m[row*mNumCols+column]=v},exports.cpuMultiplyMatrix=function(a,aRow,aCol,b,bRow,bCol){for(var result=new Float32Array(aRow*bCol),r=0;r<aRow;++r)for(var aOffset=r*aCol,cOffset=r*bCol,c=0;c<bCol;++c){for(var d=0,k=0;k<aCol;++k)d+=a[aOffset+k]*b[k*bCol+c];result[cOffset+c]=d}return result},exports.cpuDotProduct=function(a,b){if(a.length!==b.length)throw new Error("cpuDotProduct: incompatible vectors.");for(var d=0,i=0;i<a.length;++i)d+=a[i]*b[i];return d}},{}],82:[function(require,module,exports){"use strict";function shuffle(array){for(var counter=array.length,temp=0,index=0;counter>0;)index=Math.random()*counter|0,temp=array[--counter],array[counter]=array[index],array[index]=temp}function randGauss(mean,stdDev,truncated){void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),void 0===truncated&&(truncated=!1);var v1,v2,s;do{s=(v1=2*Math.random()-1)*v1+(v2=2*Math.random()-1)*v2}while(s>1);var result=Math.sqrt(-2*Math.log(s)/s)*v1;return truncated&&Math.abs(result)>2?randGauss(mean,stdDev,!0):mean+stdDev*result}function assert(expr,msg){if(!expr)throw new Error(msg)}function flatten(arr,ret){ret=void 0===ret?[]:ret;for(var i=0;i<arr.length;++i)Array.isArray(arr[i])?flatten(arr[i],ret):ret.push(arr[i]);return ret}function arraysEqual(n1,n2){if(n1.length!==n2.length)return!1;for(var i=0;i<n1.length;i++)if(n1[i]!==n2[i])return!1;return!0}function decodeParam(params,name,value){params[decodeURIComponent(name)]=decodeURIComponent(value||"")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.shuffle=shuffle,exports.clamp=function(min,x,max){return Math.max(min,Math.min(x,max))},exports.randUniform=function(a,b){return Math.random()*(b-a)+a},exports.randGauss=randGauss,exports.distSquared=function(a,b){for(var result=0,i=0;i<a.length;i++){var diff=a[i]-b[i];result+=diff*diff}return result},exports.assert=assert,exports.assertShapesMatch=function(shapeA,shapeB,errorMessagePrefix){void 0===errorMessagePrefix&&(errorMessagePrefix=""),assert(arraysEqual(shapeA,shapeB),errorMessagePrefix+"Shapes "+shapeA+" and "+shapeB+" must match")},exports.flatten=flatten,exports.inferShape=function(arr){for(var shape=[];arr instanceof Array;)shape.push(arr.length),arr=arr[0];return shape},exports.sizeFromShape=function(shape){if(0===shape.length)return 1;for(var size=shape[0],i=1;i<shape.length;i++)size*=shape[i];return size},exports.isScalarShape=function(shape){return 0===shape.length},exports.arraysEqual=arraysEqual,exports.isInt=function(a){return a%1==0},exports.tanh=function(x){if(null!=Math.tanh)return Math.tanh(x);if(x===1/0)return 1;if(x===-1/0)return-1;var e2x=Math.exp(2*x);return(e2x-1)/(e2x+1)},exports.sizeToSquarishShape=function(size){for(var a=Math.floor(Math.sqrt(size));a>1;--a)if(size%a==0)return[a,size/a];return[1,size]},exports.createShuffledIndices=function(n){for(var shuffledIndices=new Uint32Array(n),i=0;i<n;++i)shuffledIndices[i]=i;return shuffle(shuffledIndices),shuffledIndices},exports.assertAndGetBroadcastedShape=function(shapeA,shapeB){var result=[],nextADimMustBeOne=!1,nextBDimMustBeOne=!1,errMsg="Operands could not be broadcast together with shapes "+shapeA+" and "+shapeB+". Currently, we only support a stricter version of broadcasting than numpy.",l=Math.max(shapeA.length,shapeB.length);shapeA=shapeA.slice().reverse(),shapeB=shapeB.slice().reverse();for(var i=0;i<l;i++){var a=shapeA[i]||1,b=shapeB[i]||1;if(b>1&&nextBDimMustBeOne||a>1&&nextADimMustBeOne)throw Error(errMsg);if(a>1&&1===b&&(nextBDimMustBeOne=!0),b>1&&1===a&&(nextADimMustBeOne=!0),a>1&&b>1&&a!==b)throw Error(errMsg);result.push(Math.max(a,b))}return result.reverse()},exports.rightPad=function(a,size){return size<=a.length?a:a+" ".repeat(size-a.length)},exports.repeatedTry=function(checkFn,delayFn,maxCounter){return void 0===delayFn&&(delayFn=function(counter){return 0}),new Promise(function(resolve,reject){var tryCount=0,tryFn=function(){if(checkFn())resolve();else{var nextBackoff=delayFn(++tryCount);null!=maxCounter&&tryCount>=maxCounter?reject():setTimeout(tryFn,nextBackoff)}};setTimeout(tryFn,0)})},exports.getQueryParams=function(queryString){var params={};return queryString.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(s){for(var t=[],_i=1;_i<arguments.length;_i++)t[_i-1]=arguments[_i];return decodeParam(params,t[0],t[1]),t.join("=")}),params},exports.inferFromImplicitShape=function(shape,size){for(var shapeProd=1,implicitIdx=-1,i=0;i<shape.length;++i)if(shape[i]>0)shapeProd*=shape[i];else if(-1===shape[i]){if(-1!==implicitIdx)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+implicitIdx+" and dim "+i);implicitIdx=i}else if(shape[i]<=0)throw Error("Shapes can not be <= 0. Found "+shape[i]+" at dim "+i);if(-1===implicitIdx){if(size>0&&size!==shapeProd)throw Error("Size ("+size+") must match the product of shape "+shape);return shape}if(size%shapeProd!=0)throw Error("The implicit shape can't be a fractional number. Got "+size+" / "+shapeProd);var newShape=shape.slice();return newShape[implicitIdx]=size/shapeProd,newShape}},{}],83:[function(require,module,exports){var alea=require("./lib/alea"),xor128=require("./lib/xor128"),xorwow=require("./lib/xorwow"),xorshift7=require("./lib/xorshift7"),xor4096=require("./lib/xor4096"),tychei=require("./lib/tychei"),sr=require("./seedrandom");sr.alea=alea,sr.xor128=xor128,sr.xorwow=xorwow,sr.xorshift7=xorshift7,sr.xor4096=xor4096,sr.tychei=tychei,module.exports=sr},{"./lib/alea":84,"./lib/tychei":85,"./lib/xor128":86,"./lib/xor4096":87,"./lib/xorshift7":88,"./lib/xorwow":89,"./seedrandom":90}],84:[function(require,module,exports){!function(global,module,define){function Alea(seed){var me=this,mash=Mash();me.next=function(){var t=2091639*me.s0+2.3283064365386963e-10*me.c;return me.s0=me.s1,me.s1=me.s2,me.s2=t-(me.c=0|t)},me.c=1,me.s0=mash(" "),me.s1=mash(" "),me.s2=mash(" "),me.s0-=mash(seed),me.s0<0&&(me.s0+=1),me.s1-=mash(seed),me.s1<0&&(me.s1+=1),me.s2-=mash(seed),me.s2<0&&(me.s2+=1),mash=null}function copy(f,t){return t.c=f.c,t.s0=f.s0,t.s1=f.s1,t.s2=f.s2,t}function impl(seed,opts){var xg=new Alea(seed),state=opts&&opts.state,prng=xg.next;return prng.int32=function(){return 4294967296*xg.next()|0},prng.double=function(){return prng()+1.1102230246251565e-16*(2097152*prng()|0)},prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}function Mash(){var n=4022871197;return function(data){data=data.toString();for(var i=0;i<data.length;i++){var h=.02519603282416938*(n+=data.charCodeAt(i));h-=n=h>>>0,n=(h*=n)>>>0,n+=4294967296*(h-=n)}return 2.3283064365386963e-10*(n>>>0)}}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.alea=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],85:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var b=me.b,c=me.c,d=me.d,a=me.a;return b=b<<25^b>>>7^c,c=c-d|0,d=d<<24^d>>>8^a,a=a-b|0,me.b=b=b<<20^b>>>12^c,me.c=c=c-d|0,me.d=d<<16^c>>>16^a,me.a=a-b|0},me.a=0,me.b=0,me.c=-1640531527,me.d=1367130551,seed===Math.floor(seed)?(me.a=seed/4294967296|0,me.b=0|seed):strseed+=seed;for(var k=0;k<strseed.length+20;k++)me.b^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.a=f.a,t.b=f.b,t.c=f.c,t.d=f.d,t}function impl(seed,opts){var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.tychei=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],86:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.x=0,me.y=0,me.z=0,me.w=0,me.next=function(){var t=me.x^me.x<<11;return me.x=me.y,me.y=me.z,me.z=me.w,me.w^=me.w>>>19^t^t>>>8},seed===(0|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t}function impl(seed,opts){var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xor128=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],87:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,w=me.w,X=me.X,i=me.i;return me.w=w=w+1640531527|0,v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,v=X[i]=v^t,me.i=i,v+(w^w>>>16)|0},function(me,seed){var t,v,i,j,w,X=[],limit=128;for(seed===(0|seed)?(v=seed,seed=null):(seed+="\0",v=0,limit=Math.max(limit,seed.length)),i=0,j=-32;j<limit;++j)seed&&(v^=seed.charCodeAt((j+32)%seed.length)),0===j&&(w=v),v^=v<<10,v^=v>>>15,v^=v<<4,v^=v>>>13,j>=0&&(w=w+1640531527|0,i=0==(t=X[127&j]^=v+w)?i+1:0);for(i>=128&&(X[127&(seed&&seed.length||0)]=-1),i=127,j=512;j>0;--j)v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,X[i]=v^t;me.w=w,me.X=X,me.i=i}(me,seed)}function copy(f,t){return t.i=f.i,t.w=f.w,t.X=f.X.slice(),t}function impl(seed,opts){null==seed&&(seed=+new Date);var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.X&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xor4096=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],88:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,X=me.x,i=me.i;return t=X[i],t^=t>>>7,v=t^t<<24,t=X[i+1&7],v^=t^t>>>10,t=X[i+3&7],v^=t^t>>>3,t=X[i+4&7],v^=t^t<<7,t=X[i+7&7],t^=t<<13,v^=t^t<<9,X[i]=v,me.i=i+1&7,v},function(me,seed){var j,X=[];if(seed===(0|seed))X[0]=seed;else for(seed=""+seed,j=0;j<seed.length;++j)X[7&j]=X[7&j]<<15^seed.charCodeAt(j)+X[j+1&7]<<13;for(;X.length<8;)X.push(0);for(j=0;j<8&&0===X[j];++j);for(8==j?X[7]=-1:X[j],me.x=X,me.i=0,j=256;j>0;--j)me.next()}(me,seed)}function copy(f,t){return t.x=f.x.slice(),t.i=f.i,t}function impl(seed,opts){null==seed&&(seed=+new Date);var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.x&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xorshift7=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],89:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var t=me.x^me.x>>>2;return me.x=me.y,me.y=me.z,me.z=me.w,me.w=me.v,(me.d=me.d+362437|0)+(me.v=me.v^me.v<<4^t^t<<1)|0},me.x=0,me.y=0,me.z=0,me.w=0,me.v=0,seed===(0|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),k==strseed.length&&(me.d=me.x<<10^me.x>>>4),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t.v=f.v,t.d=f.d,t}function impl(seed,opts){var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xorwow=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],90:[function(require,module,exports){!function(pool,math){function seedrandom(seed,options,callback){var key=[],shortseed=mixkey(flatten((options=1==options?{entropy:!0}:options||{}).entropy?[seed,tostring(pool)]:null==seed?autoseed():seed,3),key),arc4=new ARC4(key),prng=function(){for(var n=arc4.g(chunks),d=startdenom,x=0;n<significance;)n=(n+x)*width,d*=width,x=arc4.g(1);for(;n>=overflow;)n/=2,d/=2,x>>>=1;return(n+x)/d};return prng.int32=function(){return 0|arc4.g(4)},prng.quick=function(){return arc4.g(4)/4294967296},prng.double=prng,mixkey(tostring(arc4.S),pool),(options.pass||callback||function(prng,seed,is_math_call,state){return state&&(state.S&&copy(state,arc4),prng.state=function(){return copy(arc4,{})}),is_math_call?(math[rngname]=prng,seed):prng})(prng,shortseed,"global"in options?options.global:this==math,options.state)}function ARC4(key){var t,keylen=key.length,me=this,i=0,j=me.i=me.j=0,s=me.S=[];for(keylen||(key=[keylen++]);i<width;)s[i]=i++;for(i=0;i<width;i++)s[i]=s[j=mask&j+key[i%keylen]+(t=s[i])],s[j]=t;(me.g=function(count){for(var t,r=0,i=me.i,j=me.j,s=me.S;count--;)t=s[i=mask&i+1],r=r*width+s[mask&(s[i]=s[j=mask&j+t])+(s[j]=t)];return me.i=i,me.j=j,r})(width)}function copy(f,t){return t.i=f.i,t.j=f.j,t.S=f.S.slice(),t}function flatten(obj,depth){var prop,result=[],typ=typeof obj;if(depth&&"object"==typ)for(prop in obj)try{result.push(flatten(obj[prop],depth-1))}catch(e){}return result.length?result:"string"==typ?obj:obj+"\0"}function mixkey(seed,key){for(var smear,stringseed=seed+"",j=0;j<stringseed.length;)key[mask&j]=mask&(smear^=19*key[mask&j])+stringseed.charCodeAt(j++);return tostring(key)}function autoseed(){try{var out;return nodecrypto&&(out=nodecrypto.randomBytes)?out=out(width):(out=new Uint8Array(width),(global.crypto||global.msCrypto).getRandomValues(out)),tostring(out)}catch(e){var browser=global.navigator,plugins=browser&&browser.plugins;return[+new Date,global,plugins,global.screen,tostring(pool)]}}function tostring(a){return String.fromCharCode.apply(0,a)}var nodecrypto,global=this,width=256,chunks=6,rngname="random",startdenom=math.pow(width,chunks),significance=math.pow(2,52),overflow=2*significance,mask=width-1;if(math["seed"+rngname]=seedrandom,mixkey(math.random(),pool),"object"==typeof module&&module.exports){module.exports=seedrandom;try{nodecrypto=require("crypto")}catch(ex){}}else"function"==typeof define&&define.amd&&define(function(){return seedrandom})}([],Math)},{crypto:1}],91:[function(require,module,exports){"use strict";var rnn=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("./rnn"));window.onload=function(){var writeBtn=document.getElementById("writeBtn"),result=document.getElementById("result");writeBtn.onclick=function(){result.innerHTML=rnn.generateText()}}},{"./rnn":92}],92:[function(require,module,exports){"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateText=void 0;var _vocab,_deeplearn=require("deeplearn"),lstmKernel1=void 0,lstmBias1=void 0,lstmKernel2=void 0,lstmBias2=void 0,fullyConnectedBiases=void 0,fullyConnectedWeights=void 0,embeddingWeights=void 0,checkpointsLoaded=!1,math=new _deeplearn.NDArrayMathGPU,vocab=(_vocab={"\n":10,"!":46," ":0,$:64,"'":30,"&":63,"-":48,",":16,".":25,3:62,";":38,":":24,"?":44,A:26,C:37,B:43,E:31,D:47,G:45,F:49,I:21,H:41,K:52,J:58,M:42,L:36,O:32,N:33,Q:59,P:51,S:35,R:34,"":40,T:29,W:39,V:53,Y:50,X:61,Z:60,a:4,c:19,b:22,e:1,d:12,g:20,f:18,i:9,h:5,k:28,j:54,m:14,l:11,o:3,n:8,q:55,p:23,s:6,r:7},_defineProperty(_vocab,"",13),_defineProperty(_vocab,"t",2),_defineProperty(_vocab,"w",17),_defineProperty(_vocab,"v",27),_defineProperty(_vocab,"y",15),_defineProperty(_vocab,"x",56),_defineProperty(_vocab,"z",57),_vocab);new _deeplearn.CheckpointLoader("../../../models/shakespear/").getAllVariables().then(function(vars){embeddingWeights=vars.embedding,lstmKernel1=vars["rnnlm/multi_rnn_cell/cell_0/basic_lstm_cell/weights"],lstmBias1=vars["rnnlm/multi_rnn_cell/cell_0/basic_lstm_cell/biases"],lstmKernel2=vars["rnnlm/multi_rnn_cell/cell_1/basic_lstm_cell/weights"],lstmBias2=vars["rnnlm/multi_rnn_cell/cell_1/basic_lstm_cell/biases"],fullyConnectedBiases=vars["rnnlm/softmax_b"],fullyConnectedWeights=vars["rnnlm/softmax_w"],checkpointsLoaded=!0});exports.generateText=function generateText(){var results=[];if(checkpointsLoaded){math.scope(function(keep,track){for(var forgetBias=track(_deeplearn.Scalar.new(1)),lstm1=math.basicLSTMCell.bind(math,forgetBias,lstmKernel1,lstmBias1),lstm2=math.basicLSTMCell.bind(math,forgetBias,lstmKernel2,lstmBias2),c=[track(_deeplearn.Array2D.zeros([1,lstmBias1.shape[0]/4])),track(_deeplearn.Array2D.zeros([1,lstmBias2.shape[0]/4]))],h=[track(_deeplearn.Array2D.zeros([1,lstmBias1.shape[0]/4])),track(_deeplearn.Array2D.zeros([1,lstmBias2.shape[0]/4]))],input=20,i=0;i<500;i++){var onehot=track(_deeplearn.Array2D.zeros([1,65]));onehot.set(1,0,input);var embedded=math.matMul(onehot,embeddingWeights),output=math.multiRNNCell([lstm1,lstm2],embedded,c,h);c=output[0];for(var outputH=(h=output[1])[1],weightedResult=math.matMul(outputH,fullyConnectedWeights),logits=math.add(weightedResult,fullyConnectedBiases),divided=(math.argMax(logits).get(),math.arrayDividedByScalar(logits,_deeplearn.Scalar.new(.25))),probabilities=math.exp(divided),normalized=math.divide(probabilities,math.sum(probabilities)).getValues(),randValue=Math.random(),sum=0,j=0;j<normalized.length&&(sum+=normalized[j],!(randValue<sum));j++);results.push(j),input=j}});var generated="";results.forEach(function(c,i){generated+=Object.keys(vocab).find(function(key){return vocab[key]===c})}),console.log(generated)}else setTimeout(function(){generateText()},100)}},{deeplearn:41}]},{},[91]);
